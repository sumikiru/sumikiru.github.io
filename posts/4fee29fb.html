<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹ | Sumikiruã®Blog</title><meta name="author" content="Sumikiru"><meta name="copyright" content="Sumikiru"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="C++åŸºç¡€ï¼šå¤šçº¿ç¨‹"><meta property="og:type" content="article"><meta property="og:title" content="è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹"><meta property="og:url" content="https://sumikiru.top/posts/4fee29fb.html"><meta property="og:site_name" content="Sumikiruã®Blog"><meta property="og:description" content="C++åŸºç¡€ï¼šå¤šçº¿ç¨‹"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg"><meta property="article:published_time" content="2024-12-15T19:52:10.000Z"><meta property="article:modified_time" content="2024-12-23T23:16:03.000Z"><meta property="article:author" content="Sumikiru"><meta property="article:tag" content="C++"><meta property="article:tag" content="å¤šçº¿ç¨‹"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sumikiru.top/posts/4fee29fb.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#d9f8ff"><link rel="apple-touch-icon" sizes="180x180" href="/images/siteicon/128.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/siteicon/32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/siteicon/16.png"><link rel="mask-icon" href="/images/siteicon/128.png" color="#5bbad5"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“ä¸­æ–‡","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“ä¸­æ–‡","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-12-23 23:16:03"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload='this.media="all"'><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload='this.media="screen"'><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Sumikiruã®Blog" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/glow.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">19</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">4</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-video"></i> <span>è¿½ç•ª</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i> <span>ç•™è¨€æ¿</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="Sumikiruã®Blog"><span class="site-name">Sumikiruã®Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i> <span>æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>Home</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/index.html"><i class="fa-fw fas fa-video"></i> <span>è¿½ç•ª</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i> <span>ç•™è¨€æ¿</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-12-15T19:52:10.000Z" title="å‘è¡¨äº 2024-12-15 19:52:10">2024-12-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-12-23T23:16:03.000Z" title="æ›´æ–°äº 2024-12-23 23:16:03">2024-12-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C-%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/">C++è¯­è¨€åŸºç¡€</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">20.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>82åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote><p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.zhihu.com/tardis/zm/art/194198073">C++å¤šçº¿ç¨‹å¼€å‘åŸºç¡€å…¥é—¨æ•™ç¨‹</a>ï¼Œ<a target="_blank" rel="noopener" href="https://www.zhihu.com/column/c_1479157429707059201">C++å­¦ä¹ ç¬”è®°ï¼šå¹¶å‘ä¸å¤šçº¿ç¨‹</a><br>å‚è€ƒè§†é¢‘ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1An4y1d7Jc?vd_source=6176273f0f24da0db424c2d99bd01fd5">C++ç¼–ç¨‹è¿›é˜¶æ•™ç¨‹</a></p></blockquote><h1 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h1><h2 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶å‘"><a href="#ä»€ä¹ˆæ˜¯çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶å‘" class="headerlink" title="ä»€ä¹ˆæ˜¯çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶å‘"></a>ä»€ä¹ˆæ˜¯çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶å‘</h2><p><strong>çº¿ç¨‹</strong>ï¼ˆThreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡ŒCPUè°ƒåº¦çš„<strong>æœ€å°å•ä½</strong>ï¼Œå®ƒè¢«<strong>åŒ…å«åœ¨è¿›ç¨‹ï¼ˆprogramï¼‰ä¹‹ä¸­</strong>ï¼Œä¸€ä¸ªè¿›ç¨‹å¯åŒ…å«å•ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹ã€‚<br>ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­å•ä¸€çš„æ§åˆ¶æµï¼Œæ¯æ¡çº¿ç¨‹æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p><p><strong>è¿›ç¨‹</strong>æ˜¯è¿è¡Œèµ·æ¥çš„å¯æ‰§è¡Œç¨‹åºã€‚<br><strong>å¹¶å‘</strong>æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡åŒæ—¶å‘ç”Ÿï¼Œä¸€ä¸ªç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªç‹¬ç«‹ä»»åŠ¡ã€‚</p><h2 id="è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»"></a>è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»</h2><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹<font color="#00b050">å…±äº«</font>ç›¸åŒçš„<u>è¿›ç¨‹ç©ºé—´ï¼ˆä»£ç æ®µã€æ•°æ®æ®µã€å †ï¼‰</u>å’Œ<u>ç³»ç»Ÿèµ„æºï¼ˆæ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ï¼‰</u>ï¼Œä½†å„è‡ªæœ‰<font color="#00b050">ç‹¬ç«‹çš„æ ˆç©ºé—´å’Œçº¿ç¨‹æ§åˆ¶å—</font>ï¼Œä¸å…±äº«å†…å­˜ã€‚</p><p>ğŸš€è¯¦ç»†åŒºåˆ†ï¼š</p><ol><li><strong>å®¹å™¨</strong>ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç›¸åº”çš„çº¿ç¨‹ã€‚è¿›ç¨‹æ˜¯çº¿ç¨‹çš„<font color="#00b050">å®¹å™¨</font>ã€‚</li><li><strong>æœ€å°å•ä½</strong>ï¼šè¿›ç¨‹æ˜¯<strong>èµ„æºåˆ†é…</strong>çš„æœ€å°å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯<strong>ç¨‹åºæ‰§è¡Œ</strong>çš„æœ€å°å•ä½ã€‚</li><li><strong>åœ°å€ç©ºé—´</strong>ï¼šè¿›ç¨‹æœ‰è‡ªå·±<font color="#00b050">ç‹¬ç«‹çš„åœ°å€ç©ºé—´</font>ï¼Œè€Œçº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œ<strong>åŒä¸€è¿›ç¨‹</strong>çš„çº¿ç¨‹<font color="#00b050">å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´</font>ã€‚</li><li><strong>èµ„æº</strong>ï¼šè¿›ç¨‹ä¹‹é—´çš„<font color="#00b050">èµ„æºæ˜¯ç‹¬ç«‹çš„</font>ï¼Œè€ŒåŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹<font color="#00b050">å…±äº«æœ¬è¿›ç¨‹çš„èµ„æº</font>ã€‚</li><li><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼šè¿›ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œ<strong>åŒä¸€è¿›ç¨‹</strong>å†…çš„å¤šä¸ªçº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘æ‰§è¡Œã€‚</li></ol><p>é”…ç‚‰çˆ·çˆ·æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¯æ¡æ‰‹å¯ä»¥è¢«çœ‹æˆä¸€ä¸ªçº¿ç¨‹ã€‚</p><h2 id="çº¿ç¨‹çš„ç‰¹ç‚¹"><a href="#çº¿ç¨‹çš„ç‰¹ç‚¹" class="headerlink" title="çº¿ç¨‹çš„ç‰¹ç‚¹"></a>çº¿ç¨‹çš„ç‰¹ç‚¹</h2><ol><li><strong>è½»é‡çº§</strong>ï¼šä¸è¿›ç¨‹ç›¸æ¯”ï¼Œçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬ä½ã€‚å› ä¸ºçº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªæ‰§è¡Œæµï¼Œå…±äº«è¿›ç¨‹çš„å¤§éƒ¨åˆ†èµ„æºï¼Œåªéœ€è¦å°‘é‡çš„é¢å¤–å¼€é”€æ¥ç»´æŠ¤è¿›ç¨‹çš„çŠ¶æ€å’Œæ§åˆ¶ä¿¡æ¯ã€‚</li><li><strong>å…±äº«åœ°å€ç©ºé—´å’Œèµ„æº</strong>ï¼šåŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´å’Œå…¨å±€å˜é‡ç­‰èµ„æºï¼Œè¿™ä½¿å¾—çº¿ç¨‹é—´é€šä¿¡æ›´åŠ ä¾¿æ·ã€‚ä½†æ˜¯è¿™ä¹Ÿå¸¦æ¥äº†æ•°æ®åŒæ­¥å’Œäº’æ–¥é—®é¢˜ï¼Œéœ€è¦é€‚å½“çš„åŒæ­¥æœºåˆ¶æ¥é¿å…æ•°æ®ç«äº‰å’Œæ­»é”çš„é—®é¢˜ã€‚</li><li><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åœ¨åŒä¸€æ—¶é—´å†…å¹¶å‘æ‰§è¡Œï¼Œæé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ä½†æ˜¯ç”±äºçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå’Œé€Ÿåº¦å—åˆ°æ“ä½œç³»ç»Ÿè°ƒåº¦ç­–ç•¥å’Œç¡¬ä»¶æ€§èƒ½çš„å½±å“ï¼Œå› æ­¤çº¿ç¨‹çš„æ‰§è¡Œç»“æœå¯èƒ½æ˜¯ä¸ç¡®å®šçš„ã€‚</li><li><strong>ç‹¬ç«‹è°ƒåº¦</strong>ï¼šçº¿ç¨‹æ˜¯ç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚åœ¨å¤šçº¿ç¨‹æ“ä½œç³»ç»Ÿä¸­ï¼Œè°ƒåº¦å™¨æ ¹æ®çº¿ç¨‹çš„ä¼˜å…ˆçº§ã€çŠ¶æ€ç­‰å› ç´ æ¥å†³å®šçº¿ç¨‹çš„è°ƒåº¦é¡ºåºå’Œæ‰§è¡Œæ—¶é—´ã€‚</li></ol><h2 id="ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹"><a href="#ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹" class="headerlink" title="ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹"></a>ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹</h2><p>ä¸€ä¸ª<font color="#00b050">ç¨‹åºä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¹¶å‘</font>çš„æ‰§è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹-å¹¶å‘ï¼ˆä¼˜ç‚¹ï¼‰"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹-å¹¶å‘ï¼ˆä¼˜ç‚¹ï¼‰" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹/å¹¶å‘ï¼ˆä¼˜ç‚¹ï¼‰"></a>ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹/å¹¶å‘ï¼ˆä¼˜ç‚¹ï¼‰</h2><ol><li>å……åˆ†åˆ©ç”¨ CPU èµ„æº</li><li>æé«˜ç¨‹åºå“åº”é€Ÿåº¦</li><li>ä¾¿äºç¨‹åºè®¾è®¡å’Œç»´æŠ¤</li></ol><h2 id="å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«"><a href="#å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«" class="headerlink" title="å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«"></a>å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«</h2><ul><li>å¹¶å‘ï¼šåŒä¸€æ—¶é—´æ®µï¼Œå¤šä¸ªä»»åŠ¡<font color="#00b050">äº¤æ›¿</font>æ‰§è¡Œã€‚</li><li>å¹¶è¡Œï¼šåŒä¸€æ—¶é—´æ®µï¼Œå¤šä¸ªä»»åŠ¡<font color="#00b050">åŒæ—¶</font>æ‰§è¡Œã€‚</li></ul><h2 id="çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ"><a href="#çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ"></a>çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ</h2><ol><li>æ–°å»ºçŠ¶æ€ New</li><li>å°±ç»ªçŠ¶æ€ Runnable</li><li>è¿è¡ŒçŠ¶æ€ Running</li><li>é˜»å¡çŠ¶æ€ Blocked</li><li>æ­»äº¡çŠ¶æ€ Dead</li></ol><h1 id="Thread-åˆ›å»ºçº¿ç¨‹"><a href="#Thread-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="Thread åˆ›å»ºçº¿ç¨‹"></a>Thread åˆ›å»ºçº¿ç¨‹</h1><h2 id="æ€»ä½“ä»£ç "><a href="#æ€»ä½“ä»£ç " class="headerlink" title="æ€»ä½“ä»£ç "></a>æ€»ä½“ä»£ç </h2><p>éœ€è¦åŒ…å«å¤´æ–‡ä»¶ <code>&lt;thread&gt;</code>ã€‚å¯é€šè¿‡å›è°ƒå‡½æ•°ã€ä»¿å‡½æ•°ã€Lambdaè¡¨è¾¾å¼åˆ›å»ºã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡å‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹ï¼š</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">myprint</span><span class="params">()</span><span class="comment">//åˆå§‹å‡½æ•° //å›è°ƒå‡½æ•°</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œä¸­1&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œä¸­2&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œä¸­3&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œä¸­4&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œä¸­5&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test05_01</span><span class="params">()</span> <span class="comment">//é€šè¿‡å‡½æ•°æ¥åˆ›å»ºçº¿ç¨‹</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">thread <span class="title">myobj</span><span class="params">(myprint)</span></span>; <span class="comment">//threadï¼šåˆ›å»ºçº¿ç¨‹çš„ç±»ï¼›//åˆ›å»ºçº¿ç¨‹ï¼Œè°ƒç”¨myprintï¼Œä»myprintå¼€å§‹æ‰§è¡Œï¼›</span></span><br><span class="line">	<span class="comment">// ğŸš©åˆ›å»ºè¯¥çº¿ç¨‹ä»¥åï¼Œçº¿ç¨‹å°±å·²ç»å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸æ˜¯ç­‰åˆ°è°ƒç”¨join()æˆ–è€…detach()æ—¶æ‰å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (myobj.<span class="built_in">joinable</span>())<span class="comment">//åˆ¤æ–­èƒ½ä¸èƒ½joinæˆ–è€…detachï¼Œtrueè¡¨ç¤ºå¯ä»¥joinæˆ–è€…detachï¼›</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;joinable() = true&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;joinable() = false&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ğŸš©å½“çº¿ç¨‹å¯åŠ¨åï¼Œä¸€å®šè¦åœ¨å’Œçº¿ç¨‹ç›¸å…³çš„threadå¯¹è±¡è¢«é”€æ¯å‰ï¼Œå¯¹çº¿ç¨‹è°ƒç”¨join()æˆ–è€…detach()æ–¹æ³•</span></span><br><span class="line">	myobj.<span class="built_in">join</span>();<span class="comment">//é˜»å¡ä¸»çº¿ç¨‹ï¼Œè®©ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åå­çº¿ç¨‹å’Œä¸»çº¿ç¨‹æ±‡åˆï¼›</span></span><br><span class="line">	<span class="comment">//myobj.detach(); //ä¸€æ—¦ä½¿ç”¨detach()åï¼Œä¸è¿™ä¸ªä¸»çº¿ç¨‹å…³è”çš„threadå¯¹è±¡å°±å¤±å»äº†ä¸è¿™ä¸ªä¸»çº¿ç¨‹çš„å…³è”ï¼Œæ­¤æ—¶è¿™ä¸ªå­çº¿ç¨‹å°±ä¼šåœ¨åå°è¿è¡Œï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰ï¼›</span></span><br><span class="line">	<span class="comment">//è¿™ä¸ªå­çº¿ç¨‹å°±ç›¸å½“äºè¢«C++è¿è¡Œæ—¶åº“æ¥ç®¡ï¼Œè¿™ä¸ªå­çº¿ç¨‹è¿è¡Œå®Œåï¼Œç”±è¿è¡Œæ—¶åº“æ¸…ç†è¯¥çº¿ç¨‹ç›¸å…³èµ„æºï¼›å°±ä¸èƒ½å†ç”¨join()æ¥ç®¡å›æ¥äº†ï¼›</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (myobj.<span class="built_in">joinable</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;joinable2() = true&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;joinable2() = false&quot;</span> &lt;&lt; endl; <span class="comment">//join()ä¹‹åä¹Ÿä¸èƒ½å†join</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ2&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ3&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ4&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ5&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹è¿è¡Œç»“æŸ6&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ç±»æ¥åˆ›å»ºçº¿ç¨‹ï¼Œç±»ä½œä¸ºå¯è°ƒç”¨å¯¹è±¡ï¼ˆä»¿å‡½æ•°ï¼‰ï¼š</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TA</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">TA</span>(<span class="type">int</span> i):<span class="built_in">m_i</span>(i) <span class="comment">//æœ‰å‚æ„é€  //ä¸èƒ½ç”¨å¼•ç”¨int &amp;i</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;TAæœ‰å‚æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">TA</span>(<span class="type">const</span> TA &amp;ta) :<span class="built_in">m_i</span>(ta.m_i) <span class="comment">//æ‹·è´æ„é€ </span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;TAæ‹·è´æ„é€ å‡½æ•°è¢«æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	~<span class="built_in">TA</span>() <span class="comment">//ææ„</span></span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;TAææ„å‡½æ•°è¢«æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span><span class="comment">//ä¸èƒ½å¸¦å‚æ•° //operator()()å°±æ˜¯çº¿ç¨‹çš„å…¥å£ç‚¹</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;operator()çº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;m_i = &quot;</span> &lt;&lt; m_i &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;operator()çº¿ç¨‹æ‰§è¡Œå®Œæ¯•&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//int &amp;m_i;</span></span><br><span class="line">	<span class="type">int</span> m_i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test05_02</span><span class="params">()</span> <span class="comment">//é€šè¿‡ç±»æ¥åˆ›å»ºçº¿ç¨‹</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> myi = <span class="number">6</span>;</span><br><span class="line">	<span class="function">TA <span class="title">ta</span><span class="params">(myi)</span></span>;</span><br><span class="line">	<span class="function">thread <span class="title">myjob</span><span class="params">(ta)</span></span>;<span class="comment">//ta: å¯è°ƒç”¨å¯¹è±¡	//taæ˜¯è¢«å¤åˆ¶åˆ°äº†çº¿ç¨‹ä¸­ï¼ˆæ‹·è´æ„é€ ï¼‰ï¼Œä¸»çº¿ç¨‹ç»“æŸåè¿™ä¸ªè¢«å¤æ‚çš„å¯¹è±¡ä¾ç„¶å­˜åœ¨ï¼›åªè¦æ²¡æœ‰å¼•ç”¨ã€æŒ‡é’ˆå°±ä¸ä¼šæœ‰é—®é¢˜ï¼›</span></span><br><span class="line">	myjob.<span class="built_in">join</span>();<span class="comment">//ç­‰å¾…çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">	<span class="comment">//å¦‚æœç”¨detach()ï¼Œå› ä¸ºæœ‰å±€éƒ¨å˜é‡taï¼Œä¸”æ„é€ å‡½æ•°é‡Œæ˜¯å¼•ç”¨ï¼Œä¸»çº¿ç¨‹è¿è¡Œç»“æŸåä¼šå›æ”¶è¿™å—å±€éƒ¨å˜é‡taçš„å†…å­˜ï¼Œåœ¨å­çº¿ç¨‹çš„æ„é€ å‡½æ•°é‡Œå°±è·å–ä¸åˆ°è¿™ä¸ªåœ°å€äº†ï¼Œä¼šäº§ç”Ÿä¸å¯é¢„æ–™çš„åæœï¼›</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹ä¸å­çº¿ç¨‹æ±‡åˆ&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨Lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹ï¼šï¼ˆå‰ææ˜¯å’Œtest05_03ä¸€æ ·åœ¨å±€éƒ¨ä½œç”¨åŸŸä¸­æ‰è¡Œï¼Œä¸èƒ½èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼‰</span></span><br><span class="line"><span class="keyword">auto</span> mylamthread = []() <span class="comment">//çº¿ç¨‹å…¥å£</span></span><br><span class="line">&#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Lambdaçº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Lambdaçº¿ç¨‹æ‰§è¡Œç»“æŸ&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test05_03</span><span class="params">()</span><span class="comment">//ç”¨Lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">thread <span class="title">myjob</span><span class="params">(mylamthread)</span></span>;</span><br><span class="line">	myjob.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;ä¸»çº¿ç¨‹ä¸å­çº¿ç¨‹æ±‡åˆ&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="é€šè¿‡å¯è°ƒç”¨å¯¹è±¡åˆ›å»ºçº¿ç¨‹"><a href="#é€šè¿‡å¯è°ƒç”¨å¯¹è±¡åˆ›å»ºçº¿ç¨‹" class="headerlink" title="é€šè¿‡å¯è°ƒç”¨å¯¹è±¡åˆ›å»ºçº¿ç¨‹"></a>é€šè¿‡å¯è°ƒç”¨å¯¹è±¡åˆ›å»ºçº¿ç¨‹</h2><ol><li>å‡½æ•°æŒ‡é’ˆ</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FunctionPtrTask</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">void</span> (*ptr)() = []()  <span class="comment">// å¦ä¸€ç§</span></span><br><span class="line">&#123;  </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(FunctionPtrTask)</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æˆå‘˜å‡½æ•°æŒ‡é’ˆ</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">MemberFunctionTask</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TestClass obj;</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(&amp;TestClass::MemberFunctionTask, &amp;obj)</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Lambda è¡¨è¾¾å¼</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="comment">// Lambdaè¡¨è¾¾å¼æ”¾åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ä¼šå¯¼è‡´ç±»å‹é—®é¢˜ï¼Œå»ºè®®æ”¾åœ¨å±€éƒ¨ä½œç”¨åŸŸä¸­ä½¿ç”¨</span></span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">([]()  </span></span></span><br><span class="line"><span class="params"><span class="function">    &#123;  </span></span></span><br><span class="line"><span class="params"><span class="function">        std::cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;  </span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;  </span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    function&lt;<span class="type">void</span>(<span class="type">void</span>)&gt; Lambda = []()  </span><br><span class="line">    &#123;  </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(Lambda)</span></span>;  </span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>ğŸ¤”ä¾‹å­ï¼šä¸åœ¨åŒä¸€ä½œç”¨åŸŸï¼Œæœ‰è­¦å‘Š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function&lt;<span class="type">void</span>(<span class="type">void</span>)&gt; WrongLambda = []()  <span class="comment">//è­¦å‘Š</span></span><br><span class="line">&#123;  </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="built_in">void</span> (*ptr)() = []()  <span class="comment">//å‡½æ•°æŒ‡é’ˆåŒç†</span></span><br><span class="line">&#123;  </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;  </span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(WrongLambda)</span></span>;  </span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ol><li>ä»¿å‡½æ•° functorï¼ˆä¹Ÿå«å‡½æ•°å¯¹è±¡ï¼‰</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Functor</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span>	<span class="comment">//ä¸èƒ½å¸¦å‚æ•°</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Executed&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Functor functor;</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(functor)</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>ç»‘å®šå¯¹è±¡ï¼ˆ<code>std::bind</code> åˆ›å»ºï¼‰</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FunctionWithArgs</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;,b = &quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> BoundFunc = std::<span class="built_in">bind</span>(FunctionWithArgs, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(BoundFunc)</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹å‚æ•°ä¼ é€’"><a href="#çº¿ç¨‹å‚æ•°ä¼ é€’" class="headerlink" title="çº¿ç¨‹å‚æ•°ä¼ é€’"></a>çº¿ç¨‹å‚æ•°ä¼ é€’</h2><h3 id="é€šè¿‡å€¼ä¼ é€’"><a href="#é€šè¿‡å€¼ä¼ é€’" class="headerlink" title="é€šè¿‡å€¼ä¼ é€’"></a>é€šè¿‡å€¼ä¼ é€’</h3><p>è§å‰æ–‡ï¼Œ1-4 éƒ½æ²¡ä¼ é€’ä»»ä½•å‚æ•°ã€‚å¦‚æœè¦å€¼ä¼ é€’å‚æ•°ä¸”ä¸ä½¿ç”¨ <code>std::bind</code>ï¼Œå‚è€ƒä»¥ä¸‹ä»£ç ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="built_in">void</span> (*ptr)(<span class="type">int</span>) = [](<span class="type">int</span> x)  </span><br><span class="line">    &#123;  </span><br><span class="line">        std::cout &lt;&lt; x &lt;&lt; endl;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(ptr, <span class="number">45</span>)</span></span>; <span class="comment">//è¾“å‡º45 </span></span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ–è€…åœ¨ä½¿ç”¨äº† <code>std::bind</code> çš„æƒ…å†µä¸‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FunctionWithArgs</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;,b = &quot;</span> &lt;&lt; b &lt;&lt; endl;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">auto</span> BoundFunc = std::<span class="built_in">bind</span>(FunctionWithArgs, <span class="number">1</span>, placeholders::_1);  </span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(BoundFunc, <span class="number">2</span>)</span></span>; <span class="comment">//a = 1,b = 2  </span></span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="é€šè¿‡å¼•ç”¨ä¼ é€’"><a href="#é€šè¿‡å¼•ç”¨ä¼ é€’" class="headerlink" title="é€šè¿‡å¼•ç”¨ä¼ é€’"></a>é€šè¿‡å¼•ç”¨ä¼ é€’</h3><p>è¿™æ„å‘³ç€åŸå§‹æ•°æ®å’Œçº¿ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®æ˜¯åŒä¸€ä¸ªå®ä½“ï¼ˆè€Œä¸æ˜¯å‰¯æœ¬ï¼‰ï¼Œè¿™å°±éœ€è¦å°å¿ƒäº†ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¿®æ”¹äº†æ•°æ®ï¼Œè¿™äº›ä¿®æ”¹å°†åœ¨æ‰€æœ‰å¼•ç”¨è¯¥æ•°æ®çš„çº¿ç¨‹ä¸­å¯è§ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ModifyAndPrint</span><span class="params">(<span class="type">int</span>&amp; a, <span class="type">int</span>&amp; b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	a += <span class="number">5</span>;</span><br><span class="line">	b += <span class="number">10</span>;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Modified Values:&quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; b &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">5</span>;</span><br><span class="line">	<span class="type">int</span> y = <span class="number">10</span>;</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(ModifyAndPrint, std::ref(x), std::ref(y))</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;Values in main thread: &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; y &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Modified Values:10,20</span></span><br><span class="line"><span class="comment">//Values in main thread: 10, 20</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº† <code>std::ref</code> æ¥åŒ…è£… <code>x</code> å’Œ <code>y</code> çš„å¼•ç”¨å¹¶è¿›è¡Œå‚æ•°ä¼ é€’ã€‚</p><p>ğŸš€æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>çº¿ç¨‹å®‰å…¨æ€§ï¼šå¼•ç”¨ä¼ é€’æ•°æ®æ—¶éœ€è¦ä¿è¯å¯¹æ•°æ®çš„è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½é‡åˆ°æ•°æ®ç«äº‰ç­‰å¹¶å‘é—®é¢˜ã€‚</li><li>èµ„æºç®¡ç†ï¼šç‰¹åˆ«æ˜¯åœ¨æ–°çº¿ç¨‹ä½¿ç”¨äº†åŠ¨æ€åˆ†é…çš„å†…å­˜æ—¶ï¼Œç¡®ä¿è¿™äº›èµ„æºåœ¨ä¸å†éœ€è¦çš„æ—¶å€™è¢«æ­£ç¡®é‡Šæ”¾ã€‚</li><li>å¼‚å¸¸å¤„ç†ï¼šæ–°çº¿ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¸ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°åˆ›å»ºè¯¥å­çº¿ç¨‹çš„çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿åœ¨æ–°çº¿ç¨‹ä¸­å¤„ç†å¯èƒ½äº§ç”Ÿçš„æ‰€æœ‰å¼‚å¸¸ï¼ˆä¸è¦å°è¯•åœ¨ä¸»çº¿ç¨‹ä¸­æ•è·å­çº¿ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„å¼‚å¸¸ï¼‰ã€‚</li></ul><h2 id="join-ä¸-detach-çš„åŒºåˆ«"><a href="#join-ä¸-detach-çš„åŒºåˆ«" class="headerlink" title="join ä¸ detach çš„åŒºåˆ«"></a>join ä¸ detach çš„åŒºåˆ«</h2><ul><li><strong><code>join</code></strong>ï¼šé˜»å¡è°ƒç”¨ï¼Œç­‰å¾…çº¿ç¨‹å®Œæˆï¼Œé€‚ç”¨äºéœ€è¦åŒæ­¥å’Œèµ„æºç®¡ç†çš„åœºæ™¯ã€‚</li><li><strong><code>detach</code></strong>ï¼šéé˜»å¡è°ƒç”¨ï¼Œçº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œé€‚ç”¨äºåå°ä»»åŠ¡æˆ–ä¸éœ€è¦åŒæ­¥çš„åœºæ™¯ã€‚</li><li><strong>å¿…é¡»è°ƒç”¨ <code>join</code> æˆ– <code>detach</code></strong>ï¼šå¦åˆ™ç¨‹åºä¼šå´©æºƒã€‚</li><li>è°ƒç”¨ <code>join</code> æˆ– <code>detach</code> åï¼Œçº¿ç¨‹å¯¹è±¡ä¸å†ä¸å®é™…çº¿ç¨‹ç›¸å…³è”ï¼Œçº¿ç¨‹å¯¹è±¡å¯ä»¥å®‰å…¨é”€æ¯ã€‚</li><li>ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>join</code> / <code>detach</code> æ–¹æ³•ã€‚</li></ul><p>âœ…è¡¨æ ¼ï¼š</p><div class="table-container"><table><thead><tr><th>ç‰¹æ€§</th><th>join</th><th>detach</th></tr></thead><tbody><tr><td>é˜»å¡æ€§</td><td>é˜»å¡è°ƒç”¨ï¼Œç­‰å¾…çº¿ç¨‹å®Œæˆ</td><td>éé˜»å¡è°ƒç”¨ï¼Œç«‹å³è¿”å›ï¼ˆä»ä¸»çº¿ç¨‹åˆ†ç¦»ï¼Œå’Œä¸»çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼‰</td></tr><tr><td>èµ„æºç®¡ç†</td><td>çº¿ç¨‹å®Œæˆåï¼Œèµ„æºè¢«å›æ”¶</td><td>çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œèµ„æºç”±æ“ä½œç³»ç»Ÿç®¡ç†</td></tr><tr><td>çº¿ç¨‹æ§åˆ¶</td><td>ä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…çº¿ç¨‹å®Œæˆ</td><td>ä¸»çº¿ç¨‹ä¸éœ€è¦ç­‰å¾…çº¿ç¨‹å®Œæˆ</td></tr><tr><td>çº¿ç¨‹å¯¹è±¡çŠ¶æ€</td><td>è°ƒç”¨ <code>join</code> åï¼Œçº¿ç¨‹å¯¹è±¡å˜ä¸ºæ— æ•ˆ</td><td>è°ƒç”¨ <code>detach</code> åï¼Œçº¿ç¨‹å¯¹è±¡å˜ä¸ºæ— æ•ˆ</td></tr><tr><td>ä½¿ç”¨åœºæ™¯</td><td>éœ€è¦ç­‰å¾…çº¿ç¨‹ç»“æœæˆ–åŒæ­¥æ—¶</td><td>çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œä¸éœ€è¦åŒæ­¥ï¼ˆå¦‚åå°ä»»åŠ¡ï¼‰</td></tr></tbody></table></div><p>ğŸ’»ä»£ç ç¤ºä¾‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SayHello</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(i &lt; <span class="number">1000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Hello: &quot;</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">thread <span class="title">t</span><span class="params">(SayHello)</span></span>;</span><br><span class="line">	t.<span class="built_in">join</span>();	<span class="comment">//é˜»å¡ä¸»çº¿ç¨‹</span></span><br><span class="line">	<span class="comment">//t.detach();	//ä»ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»å‡ºå»</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;This is main Thread.&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨t.join();</span></span><br><span class="line"><span class="comment">//Hello: 0</span></span><br><span class="line"><span class="comment">//Hello: 1</span></span><br><span class="line"><span class="comment">//......</span></span><br><span class="line"><span class="comment">//Hello: 998</span></span><br><span class="line"><span class="comment">//Hello: 999</span></span><br><span class="line"><span class="comment">//This is main Thread.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨t.detach();</span></span><br><span class="line"><span class="comment">//This is main Thread.Hello:	//é¡ºåºæ˜¯ä¹±çš„ï¼Œå› ä¸ºdetachåçš„çº¿ç¨‹tå’Œä¸»çº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„</span></span><br></pre></td></tr></table></figure><p></p><h2 id="ä¸»çº¿ç¨‹åŒ…å«çš„å†…å®¹"><a href="#ä¸»çº¿ç¨‹åŒ…å«çš„å†…å®¹" class="headerlink" title="ä¸»çº¿ç¨‹åŒ…å«çš„å†…å®¹"></a>ä¸»çº¿ç¨‹åŒ…å«çš„å†…å®¹</h2><ol><li>çº¿ç¨‹ IDï¼šç³»ç»Ÿä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒåŒºåˆ†ä¸åŒçº¿ç¨‹ã€‚</li><li>çº¿ç¨‹æ ˆ (Thread Stack)ï¼šæ¯ä¸ªçº¿ç¨‹</li><li>çº¿ç¨‹çŠ¶æ€ï¼šæ–°å»º Newï¼Œå°±ç»ª Readyï¼Œè¿è¡Œ Runningï¼Œé˜»å¡ Blockedï¼Œç»ˆæ­¢ Terminated</li><li>çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆThread Contextï¼‰</li><li>çº¿ç¨‹å‡½æ•°ï¼ˆThread Functionï¼‰</li><li>çº¿ç¨‹ä¼˜å…ˆçº§</li><li>çº¿ç¨‹å±æ€§</li><li>çº¿ç¨‹åŒæ­¥åŸè¯­ï¼šäº’æ–¥é” Mutexã€æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ Semaphoreï¼Œå¸®åŠ©çº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºæ—¶é¿å…å†²çªå’Œç«æ€æ¡ä»¶ã€‚</li></ol><h2 id="this-thread"><a href="#this-thread" class="headerlink" title="this_thread"></a>this_thread</h2><p><code>std::this_thread</code> æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ª<font color="#00b050">å‘½åç©ºé—´</font>ï¼Œæä¾›äº†ä¸å½“å‰çº¿ç¨‹ç›¸å…³çš„æ“ä½œã€‚å®ƒåŒ…å«ä¸€äº›é™æ€æˆå‘˜å‡½æ•°ï¼Œç”¨äºè·å–å½“å‰çº¿ç¨‹çš„ä¿¡æ¯æˆ–æ§åˆ¶å½“å‰çº¿ç¨‹çš„è¡Œä¸ºã€‚</p><ol><li><strong>è·å–å½“å‰çº¿ç¨‹çš„ ID</strong>ï¼š<code>this_thread::get_id()</code></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread ID: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Main Thread ID: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Thread ID: 140234567890176</span></span><br><span class="line"><span class="comment">//Main Thread ID: 140234576282880</span></span><br></pre></td></tr></table></figure><ol><li><strong>æš‚åœå½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´</strong>ï¼š<code>this_thread::sleep_for()</code></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread starts&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// å‚æ•°ä¸ºä¸€ä¸ª std::chrono::duration ç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">    this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); <span class="comment">// æš‚åœ2ç§’</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread resumes after 2 seconds&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><strong>æš‚åœå½“å‰çº¿ç¨‹åˆ°æŒ‡å®šæ—¶é—´ç‚¹</strong>ï¼š<code>std::this_thread::sleep_until()</code></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> endTime = now + std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>); <span class="comment">// å½“å‰æ—¶é—´ + 2 ç§’</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread starts&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// å‚æ•°ä¸ºä¸€ä¸ª std::chrono::time_point ç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">    this_thread::<span class="built_in">sleep_until</span>(endTime); <span class="comment">// æš‚åœåˆ°æŒ‡å®šæ—¶é—´ç‚¹</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Thread resumes after 2 seconds&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Thread starts</span></span><br><span class="line"><span class="comment">//Thread resumes after 2 seconds</span></span><br></pre></td></tr></table></figure><ol><li><strong>ä¸»åŠ¨è®©å‡º CPU æ—¶é—´ç‰‡</strong>ï¼š<code>std::this_thread::yield()</code></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread is running&quot;</span> &lt;&lt; endl;</span><br><span class="line">        this_thread::<span class="built_in">yield</span>(); <span class="comment">// è®©å‡ºCPUæ—¶é—´ç‰‡ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è¿è¡Œã€‚ç”¨äºå®ç°çº¿ç¨‹çš„åä½œå¼è°ƒåº¦ï¼Œé¿å…é•¿æ—¶é—´å ç”¨CPU</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a>çº¿ç¨‹åŒæ­¥</h1><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>çº¿ç¨‹åŒæ­¥ï¼ˆThread Synchronizationï¼‰æ˜¯æŒ‡é€šè¿‡ä¸€å®šæœºåˆ¶æ¥<font color="#00b050">æ§åˆ¶å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„æ‰§è¡Œé¡ºåºï¼Œä»¥ç¡®ä¿å®ƒä»¬èƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®å’Œä¿®æ”¹å…±äº«èµ„æº</font>ï¼Œä»è€Œé¿å…æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´æ€§é—®é¢˜ã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/dXCWFZc.png" alt="|861"><br>âœ…C++æä¾›äº†å¤šç§çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼ˆé‡è¦ï¼‰ï¼š</p><ol><li><strong>äº’æ–¥é”ï¼ˆMutexï¼‰</strong>ï¼šå½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå®ƒ<font color="#00b050">é¦–å…ˆä¼šå°è¯•è·å–ä¸è¯¥èµ„æºå…³è”çš„äº’æ–¥é”</font>ã€‚å¦‚æœé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®å…±äº«èµ„æºã€‚åŒ…å«äºå¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code> ä¸­ã€‚</li><li><strong>æ¡ä»¶å˜é‡ï¼ˆCondition Valueï¼‰</strong>ï¼šä½¿çº¿ç¨‹åœ¨æ»¡è¶³æŸæ¡ä»¶å‰ç­‰å¾…ï¼Œé€šå¸¸ä¸äº’æ–¥é”ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨<font color="#00b050">ç­‰å¾…æ¡ä»¶æˆç«‹æ—¶é‡Šæ”¾é”ï¼Œå¹¶åœ¨æ¡ä»¶æˆç«‹æ—¶åˆ›å»ºé”</font>ã€‚è¿™å…è®¸çº¿ç¨‹åœ¨ç­‰å¾…æœŸé—´ä¸å ç”¨é”ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚åŒ…å«äºå¤´æ–‡ä»¶ <code>&lt;condition_variable&gt;</code> ä¸­ã€‚</li><li><strong>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</strong>ï¼šå…è®¸<font color="#00b050">å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œä½†é™åˆ¶åŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°é‡</font>ã€‚ä¿¡å·é‡å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè¡¨ç¤ºå¯ç”¨èµ„æºçš„æ•°é‡ã€‚å½“çº¿ç¨‹éœ€è¦è®¿é—®èµ„æºæ—¶ï¼Œå®ƒä¼šå°è¯•å‡å°‘è®¡æ•°å™¨çš„å€¼ï¼›å½“çº¿ç¨‹é‡Šæ”¾èµ„æºæ—¶ï¼Œå®ƒä¼šå¢åŠ è®¡æ•°å™¨çš„å€¼ã€‚å½“è®¡æ•°å™¨çš„å€¼å°äºé›¶æ—¶ï¼Œå°è¯•è·å–èµ„æºçš„çº¿ç¨‹å°†è¢«é˜»å¡ã€‚ï¼ˆPV æ“ä½œï¼‰</li><li><strong>åŸå­æ“ä½œï¼ˆAtomic Operationsï¼‰</strong>ï¼šåŸå­æ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„æ“ä½œï¼ˆæ‰§è¡Œè¿‡ç¨‹ä¸­<font color="#00b050">ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­</font>ï¼‰ï¼Œç”¨äºå®‰å…¨åœ°æ›´æ–°å…±äº«æ•°æ®ï¼Œè€Œ<font color="#00b050">æ— éœ€ä½¿ç”¨äº’æ–¥é”ç­‰åŒæ­¥æœºåˆ¶</font>ã€‚åŒ…å«äº C++11 åŠä»¥åçš„å¤´æ–‡ä»¶ <code>&lt;atomic&gt;</code> ä¸­ã€‚</li><li><strong>è¯»å†™é”</strong>ï¼šå…è®¸<font color="#00b050">å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–</font>ï¼Œä½†åªå…è®¸<font color="#00b050">ä¸€ä¸ªçº¿ç¨‹å†™å…¥</font>ã€‚</li><li><strong>æ …æ ï¼ˆBarrierï¼‰</strong>ï¼šç”¨äºåè°ƒå¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼Œä½¿å¾—å®ƒä»¬<font color="#00b050">åœ¨æŸä¸ªåŒæ­¥ç‚¹ç­‰å¾…</font>ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾è¯¥ç‚¹ï¼ˆC++20 æ–°ç‰¹æ€§ï¼‰ã€‚</li></ol><h2 id="ğŸš©äº’æ–¥é”-mutex"><a href="#ğŸš©äº’æ–¥é”-mutex" class="headerlink" title="ğŸš©äº’æ–¥é” mutex"></a>ğŸš©äº’æ–¥é” mutex</h2><blockquote><p>å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå®ƒ<font color="#00b050">é¦–å…ˆä¼šå°è¯•è·å–ä¸è¯¥èµ„æºå…³è”çš„äº’æ–¥é”</font>ã€‚å¦‚æœé”å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®å…±äº«èµ„æºã€‚</p></blockquote><p>ğŸ’»ä»£ç ç¤ºä¾‹ï¼š</p><p>æœªå¼•å…¥äº’æ–¥é”æ—¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…±äº«å˜é‡</span></span><br><span class="line"><span class="type">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment_counter</span><span class="params">(<span class="type">int</span> times)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; times; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//æ•°æ®ç«äº‰ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ‰§è¡Œè¿™è¡Œä»£ç </span></span><br><span class="line">		counter++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">thread <span class="title">t1</span><span class="params">(increment_counter, <span class="number">100000</span>)</span></span>;</span><br><span class="line">	<span class="function">thread <span class="title">t2</span><span class="params">(increment_counter, <span class="number">100000</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	t1.<span class="built_in">join</span>();</span><br><span class="line">	t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;æœ€ç»ˆç»“æœï¼š&quot;</span> &lt;&lt; counter &lt;&lt; endl;	<span class="comment">// 145593</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ğŸš©å¼•å…¥äº’æ–¥é”ï¼ˆéœ€è¦å¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code>ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> counter = <span class="number">0</span>;  </span><br><span class="line">mutex mtx;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment_counter</span><span class="params">(<span class="type">int</span> times)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; times; i++)  </span><br><span class="line">    &#123;  </span><br><span class="line">        mtx.<span class="built_in">lock</span>();	<span class="comment">//è®¿é—®ä¸´ç•Œå˜é‡å‰å…ˆåŠ é”  </span></span><br><span class="line">        counter++;  </span><br><span class="line">        mtx.<span class="built_in">unlock</span>();   <span class="comment">//è®¿é—®å®Œæˆï¼Œè§£é”  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(increment_counter, <span class="number">100000</span>)</span></span>;  </span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(increment_counter, <span class="number">100000</span>)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    t1.<span class="built_in">join</span>();  </span><br><span class="line">    t2.<span class="built_in">join</span>();  </span><br><span class="line">  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;æœ€ç»ˆç»“æœï¼š&quot;</span> &lt;&lt; counter &lt;&lt; endl; <span class="comment">// 200000  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ol><li><strong>æ­»é”</strong>ï¼š<br>å¦‚æœçº¿ç¨‹åœ¨æŒæœ‰äº’æ–¥é‡çš„æƒ…å†µä¸‹è°ƒç”¨äº†å¦ä¸€ä¸ªé˜»å¡æ“ä½œï¼ˆå¦‚å¦ä¸€ä¸ªäº’æ–¥é‡çš„ <code>lock()</code>ï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªé˜»å¡æ“ä½œæ°¸è¿œä¸ä¼šå®Œæˆï¼ˆå› ä¸ºå…¶ä»–çº¿ç¨‹æŒæœ‰å®ƒéœ€è¦çš„èµ„æºï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿæ­»é”ã€‚é¿å…æ­»é”çš„ä¸€ç§æ–¹æ³•æ˜¯å§‹ç»ˆ<font color="#00b050">æŒ‰ç…§ç›¸åŒçš„é¡ºåºé”å®šäº’æ–¥é‡</font>ï¼Œæˆ–è€…ä½¿ç”¨æ›´é«˜çº§çš„<font color="#00b050">åŒæ­¥åŸè¯­</font>ï¼Œå¦‚ <code>std::lock_guard</code> æˆ– <code>std::unique_lock</code>ï¼Œå®ƒä»¬å¯ä»¥è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ã€‚</li><li><strong>å¼‚å¸¸å®‰å…¨</strong>ï¼š<br>å¦‚æœåœ¨é”å®šäº’æ–¥é‡åæŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå¿…é¡»ç¡®ä¿äº’æ–¥é‡è¢«æ­£ç¡®è§£é”ã€‚ä½¿ç”¨ <code>std::lock_guard</code> æˆ– <code>std::unique_lock</code> å¯ä»¥è‡ªåŠ¨å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒä»¬åœ¨ææ„æ—¶ä¼šé‡Šæ”¾é”ã€‚</li><li><strong>ä¸è¦æ‰‹åŠ¨è§£é”æœªé”å®šçš„äº’æ–¥é‡</strong>ï¼š<br>è°ƒç”¨ <code>unlock</code> ä¹‹å‰ï¼Œå¿…é¡»ç¡®ä¿äº’æ–¥é‡å·²ç»è¢« <code>lock</code> é”å®šã€‚å¦åˆ™è¯¥è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚</li><li><strong>ä¸è¦å¤šæ¬¡é”å®šåŒä¸€ä¸ªäº’æ–¥é‡</strong>ï¼š<br>å¯¹äºéé€’å½’äº’æ–¥é‡ï¼ˆå¦‚ <code>std::mutex</code>ï¼‰ï¼Œä¸è¦åœ¨åŒä¸€çº¿ç¨‹ä¸­å¤šæ¬¡é”å®šå®ƒï¼Œè¿™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚å¦‚æœéœ€è¦é€’å½’é”å®šï¼Œä½¿ç”¨ <code>std::recursive_mutex</code>ã€‚</li><li><strong>ä½¿ç”¨ RAII ç®¡ç†é”</strong>ï¼š<br>ä½¿ç”¨ RAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰åŸåˆ™æ¥ç®¡ç†é”çš„ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡ <code>std::lock_guard</code> æˆ–è€… <code>std::unique_lock</code> æ¥ç¡®ä¿é”åœ¨ä¸éœ€è¦æ—¶è‡ªåŠ¨é‡Šæ”¾ã€‚</li><li><strong>é¿å…é•¿æ—¶é—´æŒæœ‰é”</strong>ï¼š<br>å°½é‡ç¼©çŸ­æŒæœ‰é”çš„æ—¶é—´ï¼Œä»¥<font color="#00b050">å‡å°‘çº¿ç¨‹ä¹‹é—´çš„äº‰ç”¨</font>ï¼Œæé«˜ç¨‹åºå¹¶å‘æ€§èƒ½ã€‚</li><li><strong>è€ƒè™‘ä½¿ç”¨æ›´é«˜çº§çš„åŒæ­¥åŸè¯­</strong>ï¼š<br>é™¤äº† <code>std::mutex</code>ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ¡ä»¶å˜é‡ <code>std::condition_variable</code>ã€è¯»å†™é” <code>std::shared_mutex</code> ç­‰ç­‰ã€‚</li></ol><p>ğŸš€ä½¿ç”¨ <code>std::lock_guard</code> æˆ– <code>std::unique_lock</code>ï¼ˆéµå¾ª RAII åŸåˆ™ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line">std::mutex mtx;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SafeFunction</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;  <span class="comment">//é”å®šäº’æ–¥é‡  </span></span><br><span class="line">    <span class="comment">//è¿™é‡Œæ‰§è¡Œéœ€è¦äº’æ–¥è®¿é—®çš„ä»£ç ã€‚  </span></span><br><span class="line">    <span class="comment">//å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œlock_guardä¼šåœ¨ææ„æ—¶è‡ªåŠ¨è§£é” mtx    try &#123;  </span></span><br><span class="line">        <span class="keyword">if</span> (<span class="comment">/*ä¸€äº›å¯èƒ½é€ æˆå¼‚å¸¸çš„ä»£ç */</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;An error occurred!&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e)&#123;  </span><br><span class="line">        <span class="comment">//å¤„ç†å¼‚å¸¸ï¼Œä¸éœ€è¦æ‹…å¿ƒè§£é”ï¼Œlock_guardä¼šå¤„ç†  </span></span><br><span class="line">        std::cerr &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">//lock_guardä¼šåœ¨ææ„/ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨è§£é” mtx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="âœ…å…³äºRAII"><a href="#âœ…å…³äºRAII" class="headerlink" title="âœ…å…³äºRAII"></a>âœ…å…³äºRAII</h3><p>å…¨ç§°ä¸º <strong>Resource Acquisition Is Initialization</strong>ï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰ã€‚å®ƒæ˜¯ C++ ä¸­ç®¡ç†èµ„æºï¼ˆå¦‚å†…å­˜ã€æ–‡ä»¶å¥æŸ„ã€äº’æ–¥é”ç­‰ï¼‰çš„ä¸€ç§é‡è¦æœºåˆ¶ã€‚RAII çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†èµ„æºçš„è·å–å’Œé‡Šæ”¾ä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œä»è€Œ<font color="#00b050">ç¡®ä¿èµ„æºåœ¨å¯¹è±¡åˆ›å»ºæ—¶è‡ªåŠ¨è·å–ï¼Œåœ¨å¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾</font>ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼šè‡ªåŠ¨ç®¡ç†èµ„æºã€å¼‚å¸¸å®‰å…¨ã€ç®€åŒ–ä»£ç ã€‚</p><p>RAII çš„å®ç°ä¾èµ–äºæ„é€ å’Œææ„å‡½æ•°ã€‚ğŸ’»ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileHandler</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FileHandler</span>(<span class="type">const</span> string&amp; filename) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Opening file: &quot;</span> &lt;&lt; filename &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">FileHandler</span>() &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Closing file&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå…³é—­æ–‡ä»¶</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string&amp; data)</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Writing data: &quot;</span> &lt;&lt; data &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">FileHandler <span class="title">file</span><span class="params">(<span class="string">&quot;example.txt&quot;</span>)</span></span>; <span class="comment">// èµ„æºè·å–</span></span><br><span class="line">    file.<span class="built_in">write</span>(<span class="string">&quot;Hello, RAII!&quot;</span>);       <span class="comment">// ä½¿ç”¨èµ„æº</span></span><br><span class="line">    <span class="comment">// èµ„æºåœ¨ file å¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Opening file: example.txt</span></span><br><span class="line"><span class="comment">//Writing data: Hello, RAII!</span></span><br><span class="line"><span class="comment">//Closing file</span></span><br></pre></td></tr></table></figure><ul><li><strong>æ„é€ å‡½æ•°</strong>ï¼šåœ¨ <code>FileHandler</code> å¯¹è±¡åˆ›å»ºæ—¶ï¼Œæ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰“å¼€æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚</li><li><strong>ææ„å‡½æ•°</strong>ï¼šåœ¨ <code>FileHandler</code> å¯¹è±¡é”€æ¯æ—¶ï¼Œææ„å‡½æ•°ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿï¼‰ã€‚</li><li><strong>èµ„æºç®¡ç†</strong>ï¼šé€šè¿‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ–‡ä»¶çš„æ‰“å¼€å’Œå…³é—­ï¼Œé¿å…äº†æ‰‹åŠ¨è°ƒç”¨ <code>close()</code> çš„å¤æ‚æ€§ã€‚</li></ul><p>ğŸš©RAII åœ¨æ ‡å‡†åº“ä¸­åº”ç”¨ï¼š</p><ol><li>åŠ¨æ€å†…å­˜ç®¡ç†ï¼š<code>unique_ptr</code> å’Œ <code>shared_ptr</code></li><li>äº’æ–¥é”ç®¡ç†ï¼š<code>lock_guard</code> å’Œ <code>unique_lock</code></li><li>æ–‡ä»¶ç®¡ç†: <code>ifstream</code> å’Œ <code>ofstream</code></li></ol><h3 id="mutex-çš„å››ç§ç±»å‹"><a href="#mutex-çš„å››ç§ç±»å‹" class="headerlink" title="mutex çš„å››ç§ç±»å‹"></a>mutex çš„å››ç§ç±»å‹</h3><ol><li><strong><code>std::mutex</code></strong>ï¼šæœ€åŸºæœ¬çš„äº’æ–¥é”ï¼Œé€‚ç”¨äºç®€å•çš„èµ„æºä¿æŠ¤ã€‚</li><li><strong><code>std::recursive_mutex</code></strong>ï¼šæ”¯æŒé€’å½’é”å®šï¼Œé€‚ç”¨äºé€’å½’å‡½æ•°æˆ–å¤šæ¬¡é”å®šåœºæ™¯ã€‚</li><li><strong><code>std::timed_mutex</code></strong>ï¼šæ”¯æŒè¶…æ—¶é”å®šï¼Œé€‚ç”¨äºéœ€è¦é¿å…é•¿æ—¶é—´é˜»å¡çš„åœºæ™¯ã€‚</li><li><strong><code>std::recursive_timed_mutex</code></strong>ï¼šç»“åˆé€’å½’é”å®šå’Œè¶…æ—¶é”å®šåŠŸèƒ½ï¼Œé€‚ç”¨äºå¤æ‚çš„åŒæ­¥éœ€æ±‚ã€‚</li></ol><p>ğŸ’»ä»£ç ç¤ºä¾‹ï¼š<br><code>recursive_mutex</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::recursive_mutex mtx; <span class="comment">// å®šä¹‰ä¸€ä¸ªé€’å½’äº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recursiveFunction</span><span class="params">(<span class="type">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::recursive_mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;	<span class="comment">//é”å®šäº’æ–¥é‡</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Count: &quot;</span> &lt;&lt; count &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">recursiveFunction</span>(count - <span class="number">1</span>); <span class="comment">// é€’å½’è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(recursiveFunction, <span class="number">5</span>)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Count: 5</span></span><br><span class="line"><span class="comment">//Count: 4</span></span><br><span class="line"><span class="comment">//Count: 3</span></span><br><span class="line"><span class="comment">//Count: 2</span></span><br><span class="line"><span class="comment">//Count: 1</span></span><br><span class="line"><span class="comment">//Count: 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…ï¼š</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recursiveFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mtx.<span class="built_in">lock</span>();	<span class="comment">//ç¬¬ä¸€æ¬¡é”å®š</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; locked mutex.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    mtx.<span class="built_in">lock</span>();	<span class="comment">//å¯ä»¥å¤šæ¬¡é”å®š</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; locked mutex.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	mtx.<span class="built_in">unlock</span>();</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; unlocked mutex.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	mtx.<span class="built_in">unlock</span>();</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;Thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; unlocked mutex.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>timed_mutex</code>:<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::timed_mutex mtx; <span class="comment">// å®šä¹‰ä¸€ä¸ªå®šæ—¶äº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mtx.<span class="built_in">try_lock_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>))) &#123; <span class="comment">// å°è¯•é”å®š 1 ç§’ï¼Œä½¿ç”¨try_lock_foræˆ–è€…try_lock_until</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread ID: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; acquired the lock&quot;</span> &lt;&lt; endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); <span class="comment">// æ¨¡æ‹Ÿå·¥ä½œ</span></span><br><span class="line">        mtx.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread ID: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; failed to acquire the lock&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(threadFunction)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Thread ID: 140234567890176 acquired the lock</span></span><br><span class="line"><span class="comment">//Thread ID: 140234576282880 failed to acquire the lock</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">threadFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> deadline = std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>); <span class="comment">// è®¾ç½®æˆªæ­¢æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mtx.<span class="built_in">try_lock_until</span>(deadline)) &#123; <span class="comment">// å°è¯•åœ¨æˆªæ­¢æ—¶é—´ä¹‹å‰è·å–é”</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread ID: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; acquired the lock&quot;</span> &lt;&lt; endl;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); <span class="comment">// æ¨¡æ‹Ÿå·¥ä½œ</span></span><br><span class="line">        mtx.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread ID: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; failed to acquire the lock&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>recursive_timed_mutex</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::recursive_timed_mutex mtx; <span class="comment">// å®šä¹‰ä¸€ä¸ªé€’å½’å®šæ—¶äº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recursiveFunction</span><span class="params">(<span class="type">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mtx.<span class="built_in">try_lock_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>))) &#123; <span class="comment">// å°è¯•é”å®š 1 ç§’</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Count: &quot;</span> &lt;&lt; count &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">recursiveFunction</span>(count - <span class="number">1</span>); <span class="comment">// é€’å½’è°ƒç”¨</span></span><br><span class="line">        &#125;</span><br><span class="line">        mtx.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Failed to acquire the lock at count: &quot;</span> &lt;&lt; count &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(recursiveFunction, <span class="number">5</span>)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Count: 5</span></span><br><span class="line"><span class="comment">//Count: 4</span></span><br><span class="line"><span class="comment">//Count: 3</span></span><br><span class="line"><span class="comment">//Count: 2</span></span><br><span class="line"><span class="comment">//Count: 1</span></span><br><span class="line"><span class="comment">//Count: 0</span></span><br></pre></td></tr></table></figure><p></p><p>ï¼ˆäº†è§£ï¼‰å…³äº <code>std::chrono</code>ï¼š<br>å®ƒæä¾›äº†é«˜ç²¾åº¦çš„æ—¶é—´æ“ä½œå’Œè®¡æ—¶åŠŸèƒ½ï¼Œå…è®¸å¼€å‘è€…ä»¥çµæ´»çš„æ–¹å¼å¤„ç†æ—¶é—´ç‚¹å’Œæ—¶é—´æ®µã€‚<code>std::chrono</code> çš„æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬ <strong>æ—¶é—´ç‚¹ï¼ˆtime_pointï¼‰</strong>ã€<strong>æ—¶é—´æ®µï¼ˆdurationï¼‰</strong> å’Œ <strong>æ—¶é’Ÿï¼ˆclockï¼‰</strong>ã€‚</p><p>å¸¸ç”¨æ“ä½œæœ‰ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ—¶é—´æ®µdurationçš„æ“ä½œ---------------------------------------</span></span><br><span class="line"><span class="comment">//åˆ›å»ºæ—¶é—´æ®µ</span></span><br><span class="line">std::<span class="function">chrono::seconds <span class="title">sec</span><span class="params">(<span class="number">10</span>)</span></span>;          <span class="comment">// 10 ç§’</span></span><br><span class="line">std::<span class="function">chrono::milliseconds <span class="title">ms</span><span class="params">(<span class="number">500</span>)</span></span>;     <span class="comment">// 500 æ¯«ç§’</span></span><br><span class="line">std::<span class="function">chrono::microseconds <span class="title">us</span><span class="params">(<span class="number">1000</span>)</span></span>;    <span class="comment">// 1000 å¾®ç§’</span></span><br><span class="line"><span class="comment">//æ—¶é—´æ®µè½¬æ¢</span></span><br><span class="line">std::chrono::seconds sec = std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(ms);</span><br><span class="line"><span class="comment">//æ—¶é—´æ®µè¿ç®—</span></span><br><span class="line">std::<span class="function">chrono::seconds <span class="title">sec1</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">std::<span class="function">chrono::seconds <span class="title">sec2</span><span class="params">(<span class="number">20</span>)</span></span>;</span><br><span class="line">std::chrono::seconds sec3 = sec1 + sec2; <span class="comment">// 30 ç§’</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ—¶é—´ç‚¹time_pointçš„æ“ä½œ--------------------------------------</span></span><br><span class="line"><span class="comment">//è·å–å½“å‰æ—¶é—´ç‚¹</span></span><br><span class="line"><span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="comment">//æ—¶é—´ç‚¹è½¬æ¢ä¸ºæ—¶é—´æˆ³</span></span><br><span class="line">std::<span class="type">time_t</span> <span class="type">now_time_t</span> = std::chrono::system_clock::<span class="built_in">to_time_t</span>(now);</span><br><span class="line"><span class="comment">//æ—¶é—´ç‚¹è¿ç®—</span></span><br><span class="line"><span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="keyword">auto</span> future = now + std::chrono::<span class="built_in">seconds</span>(<span class="number">10</span>); <span class="comment">// å½“å‰æ—¶é—´ + 10 ç§’</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ—¶é’Ÿclockçš„æ“ä½œ--------------------------------------------</span></span><br><span class="line"><span class="comment">//è·å–å½“å‰æ—¶é—´ç‚¹</span></span><br><span class="line"><span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line"><span class="comment">//è·å–ç¨³å®šæ—¶é—´ç‚¹</span></span><br><span class="line"><span class="keyword">auto</span> steady_now = std::chrono::steady_clock::<span class="built_in">now</span>();</span><br></pre></td></tr></table></figure><p></p><h3 id="lock-guard"><a href="#lock-guard" class="headerlink" title="lock_guard"></a>lock_guard</h3><blockquote><p>ä»€ä¹ˆæ˜¯ <code>lock_guard</code>ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ <code>lock_guard</code>ï¼Ÿ</p></blockquote><p><code>lock_guard</code> æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œä½äº <code>&lt;mutex&gt;</code> å¤´æ–‡ä»¶ä¸­ï¼Œç¬¦åˆ RAII é£æ ¼ï¼Œç”¨äºç®¡ç† <code>mutex</code> çš„ç”Ÿå‘½å‘¨æœŸï¼Œè§£å†³äº†æ‰‹åŠ¨ç®¡ç† <code>mutex</code> é”å®šå’Œè§£é”æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼ˆå¿˜è®°è§£é”ã€å¼‚å¸¸æƒ…å†µä¸‹æœªè§£é”ç­‰ï¼‰ã€‚<br>å¯ä»¥ç†è§£ä¸ºï¼Œ<code>lock_guard</code> æ˜¯å¯¹ mutex çš„ä¸€ç§ç®¡ç†å°è£…ï¼Œå®ƒå¯ä»¥æ›´å¥½åœ°ç®¡ç† mutexã€‚</p><blockquote><p>ğŸ’»ä»£ç ç¤ºä¾‹</p></blockquote><p><strong>é€šè¿‡è®¾å®šä½œç”¨åŸŸï¼Œä½¿å¾—std::lock_guardåœ¨åˆé€‚çš„åœ°æ–¹è¢«ææ„</strong>ï¼ˆåœ¨äº’æ–¥é‡é”å®šåˆ°äº’æ–¥é‡è§£é”ä¹‹é—´çš„ä»£ç å«åšä¸´ç•ŒåŒºï¼ˆéœ€è¦äº’æ–¥è®¿é—®å…±äº«èµ„æºçš„é‚£æ®µä»£ç ç§°ä¸ºä¸´ç•ŒåŒºï¼‰ï¼Œä¸´ç•ŒåŒºèŒƒå›´åº”è¯¥å°½å¯èƒ½çš„å°ï¼Œå³lockäº’æ–¥é‡ååº”è¯¥å°½æ—©unlockï¼‰ï¼Œ<strong>é€šè¿‡ä½¿ç”¨{}æ¥è°ƒæ•´ä½œç”¨åŸŸèŒƒå›´ï¼Œå¯ä½¿å¾—äº’æ–¥é‡måœ¨åˆé€‚çš„åœ°æ–¹è¢«è§£é”</strong>ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">mutex m;<span class="comment">//å®ä¾‹åŒ–må¯¹è±¡ï¼Œä¸è¦ç†è§£ä¸ºå®šä¹‰å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">proc1</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">g1</span><span class="params">(m)</span></span>;<span class="comment">//ç”¨æ­¤è¯­å¥æ›¿æ¢äº†m.lock()ï¼›lock_guardä¼ å…¥ä¸€ä¸ªå‚æ•°æ—¶ï¼Œè¯¥å‚æ•°ä¸ºäº’æ–¥é‡ï¼Œæ­¤æ—¶è°ƒç”¨äº†lock_guardçš„æ„é€ å‡½æ•°ï¼Œç”³è¯·é”å®šm</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;proc1å‡½æ•°æ­£åœ¨æ”¹å†™a&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;åŸå§‹aä¸º&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ç°åœ¨aä¸º&quot;</span> &lt;&lt; a + <span class="number">2</span> &lt;&lt; endl;</span><br><span class="line">&#125;<span class="comment">//æ­¤æ—¶ä¸éœ€è¦å†™m.unlock(),g1å‡ºäº†ä½œç”¨åŸŸè¢«é‡Šæ”¾ï¼Œè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°ï¼Œäºæ˜¯mè¢«è§£é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">proc2</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">g2</span><span class="params">(m)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;proc2å‡½æ•°æ­£åœ¨æ”¹å†™a&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;åŸå§‹aä¸º&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;ç°åœ¨aä¸º&quot;</span> &lt;&lt; a + <span class="number">1</span> &lt;&lt; endl;</span><br><span class="line">    &#125;<span class="comment">//é€šè¿‡ä½¿ç”¨&#123;&#125;æ¥è°ƒæ•´ä½œç”¨åŸŸèŒƒå›´ï¼Œå¯ä½¿å¾—måœ¨åˆé€‚çš„åœ°æ–¹è¢«è§£é”</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ä½œç”¨åŸŸå¤–çš„å†…å®¹3&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ä½œç”¨åŸŸå¤–çš„å†…å®¹4&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ä½œç”¨åŸŸå¤–çš„å†…å®¹5&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(proc1, a)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(proc2, a)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//proc1å‡½æ•°æ­£åœ¨æ”¹å†™a</span></span><br><span class="line"><span class="comment">//åŸå§‹aä¸º0</span></span><br><span class="line"><span class="comment">//ç°åœ¨aä¸º2</span></span><br><span class="line"><span class="comment">//proc2å‡½æ•°æ­£åœ¨æ”¹å†™a</span></span><br><span class="line"><span class="comment">//åŸå§‹aä¸º0</span></span><br><span class="line"><span class="comment">//ç°åœ¨aä¸º1</span></span><br><span class="line"><span class="comment">//ä½œç”¨åŸŸå¤–çš„å†…å®¹3</span></span><br><span class="line"><span class="comment">//ä½œç”¨åŸŸå¤–çš„å†…å®¹4</span></span><br><span class="line"><span class="comment">//ä½œç”¨åŸŸå¤–çš„å†…å®¹5</span></span><br></pre></td></tr></table></figure><p><code>std::lock_guard</code> ä¹Ÿå¯ä»¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¢« <code>adopt_lock</code> æ ‡è¯†æ—¶ï¼Œè¡¨ç¤ºæ„é€ å‡½æ•°ä¸­ä¸å†è¿›è¡Œäº’æ–¥é‡é”å®šï¼Œå› æ­¤<strong>æ­¤æ—¶éœ€è¦æå‰æ‰‹åŠ¨é”å®š</strong>ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">mutex m;<span class="comment">//å®ä¾‹åŒ–må¯¹è±¡ï¼Œä¸è¦ç†è§£ä¸ºå®šä¹‰å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">proc1</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m.<span class="built_in">lock</span>();<span class="comment">//æ‰‹åŠ¨é”å®š</span></span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">g1</span><span class="params">(m, std::adopt_lock)</span></span>;	<span class="comment">// adapt_lockæ˜¯ä¸€ä¸ªæ ‡è®°(tag)ï¼Œå‘Šè¯‰ lock_guard äº’æ–¥é” m å·²ç»è¢«é”å®š</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;proc1å‡½æ•°æ­£åœ¨æ”¹å†™a&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;åŸå§‹aä¸º&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ç°åœ¨aä¸º&quot;</span> &lt;&lt; a + <span class="number">2</span> &lt;&lt; endl;</span><br><span class="line">&#125;<span class="comment">//è‡ªåŠ¨è§£é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">proc2</span><span class="params">(<span class="type">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">g2</span><span class="params">(m)</span></span>;<span class="comment">//è‡ªåŠ¨é”å®š</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;proc2å‡½æ•°æ­£åœ¨æ”¹å†™a&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;åŸå§‹aä¸º&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;ç°åœ¨aä¸º&quot;</span> &lt;&lt; a + <span class="number">1</span> &lt;&lt; endl;</span><br><span class="line">&#125;<span class="comment">//è‡ªåŠ¨è§£é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(proc1, a)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(proc2, a)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ul><li><code>lock_guard</code> ç¦ç”¨äº†æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´å¤åˆ¶è¿ç®—ç¬¦ï¼Œæ‰€ä»¥å®ƒ<font color="#00b050">ä¸æ”¯æŒæ‹·è´è¯­ä¹‰</font>ï¼Œåªèƒ½é€šè¿‡<font color="#00b050">ç›´æ¥åˆ›å»ºå¯¹è±¡</font>æ¥ä½¿ç”¨ã€‚è¿™æ ·å¯ä»¥é¿å…å¤šä¸ª <code>lock_guard</code> å¯¹è±¡åŒæ—¶ç®¡ç†åŒä¸€ä¸ªäº’æ–¥é”è€Œå¯¼è‡´çš„é”™è¯¯è¡Œä¸ºã€‚</li><li><code>lock_guard</code> ä»…ç”¨äºç®¡ç† mutex çš„é”å®šå’Œè§£é”ï¼ˆå•ä¸€èŒè´£ï¼‰ï¼Œå¯¹äºæ›´å¤æ‚çš„é”å®šéœ€æ±‚ï¼Œä½¿ç”¨ <code>std::unique_lock</code>ã€‚</li></ul><h3 id="unique-lock"><a href="#unique-lock" class="headerlink" title="unique_lock"></a>unique_lock</h3><blockquote><p>ä¸ºä»€ä¹ˆéœ€è¦ <code>unique_lock</code>ï¼Ÿ</p></blockquote><p><code>mutex</code> åœ¨ç®¡ç†æ–¹é¢æœ‰ç‘•ç–µï¼Œå› æ­¤ä½¿ç”¨äº’æ–¥é‡å°è£…å™¨ <code>lock_guard</code> æ¥æ™ºèƒ½ç®¡ç† mutexï¼Œä½†å…¶åŠŸèƒ½è¾ƒå¼±ï¼Œéœ€è¦åŠŸèƒ½æ›´åŠ å¼ºå¤§çš„ <code>unique_lock</code>ï¼ˆä¹Ÿå«â€çµæ´»é”â€ï¼‰ã€‚</p><blockquote><p><code>lock_guard</code> çš„ç‘•ç–µåœ¨äºï¼Ÿ</p></blockquote><p>ä¸‹è¡¨ç»™å‡ºäºŒè€…åŒºåˆ«ï¼š</p><div class="table-container"><table><thead><tr><th>ç‰¹æ€§</th><th>lock_guard</th><th>unique_lock</th></tr></thead><tbody><tr><td>è‡ªåŠ¨é”å®š</td><td>âœ…</td><td>âœ…</td></tr><tr><td>è‡ªåŠ¨è§£é”</td><td>âœ…</td><td>âœ…</td></tr><tr><td>æ‰‹åŠ¨åŠ é”</td><td>âœ…</td><td>âœ…</td></tr><tr><td>å»¶è¿Ÿé”å®š</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>æ‰‹åŠ¨è§£é”</td><td>ä¸æ”¯æŒï¼Œåªèƒ½é€šè¿‡ä½œç”¨åŸŸè‡ªåŠ¨è§£é”</td><td>æ”¯æŒ</td></tr><tr><td>å‚æ•°</td><td>æ”¯æŒ adopt_lock</td><td>æ”¯æŒ adopt_lock/try_to_lock/defer_lock</td></tr><tr><td>ä¸æ¡ä»¶å˜é‡ç»“åˆ</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>é€’å½’é”</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>çµæ´»æ€§</td><td>ä½</td><td>é«˜</td></tr><tr><td>æ€§èƒ½å¼€é”€</td><td>ä½</td><td>é«˜</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>ç®€å•çš„é”ç®¡ç†</td><td>å¤æ‚çš„é”ç®¡ç†</td></tr></tbody></table></div><h4 id="ğŸ’»ä»£ç ç¤ºä¾‹"><a href="#ğŸ’»ä»£ç ç¤ºä¾‹" class="headerlink" title="ğŸ’»ä»£ç ç¤ºä¾‹"></a>ğŸ’»ä»£ç ç¤ºä¾‹</h4><p>æ„é€ ï¼ˆå¤šç§é”å®šç­–ç•¥ï¼‰</p><ul><li><code>std::defer_lock</code>ï¼šå»¶è¿Ÿé”å®šï¼Œäº’æ–¥é”åœ¨æ„é€ æ—¶ä¸é”å®šã€‚éœ€è¦æ—¶è°ƒç”¨ <code>lock</code> æ‰‹åŠ¨é”å®šï¼Œç»“æŸæ—¶è‡ªåŠ¨è§£é”ã€‚</li><li><code>std::try_to_lock</code>ï¼šå°è¯•é”å®šï¼Œå¦‚æœäº’æ–¥é”å·²è¢«å ç”¨ï¼Œåˆ™ç«‹å³è¿”å›ã€‚</li><li><code>std::adopt_lock</code>ï¼šæ¥ç®¡å·²ç»é”å®šçš„äº’æ–¥é”ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mutex mtx;</span><br><span class="line">timed_mutex TimeMtx;</span><br><span class="line"><span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;	<span class="comment">//è‡ªåŠ¨ä¸Šé”</span></span><br><span class="line"><span class="function">unique_lock&lt;timed_mutex&gt; <span class="title">TimeLock</span><span class="params">(TimeMtx, std::chrono::seconds(<span class="number">1</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">unique_lock&lt;mutex&gt; <span class="title">lock1</span><span class="params">(mtx, std::defer_lock)</span></span>;	<span class="comment">//å»¶è¿Ÿé”å®šï¼Œä¸è¦è‡ªåŠ¨é”å®š</span></span><br><span class="line"><span class="function">unique_lock&lt;mutex&gt; <span class="title">lock2</span><span class="params">(mtx, std::try_to_lock)</span></span>;<span class="comment">//å°è¯•é”å®š</span></span><br><span class="line"><span class="function">unique_lock&lt;mutex&gt; <span class="title">lock3</span><span class="params">(mtx, std::adopt_lock)</span></span>;	<span class="comment">//æ¥æ”¶å·²ç»é”å®šçš„mutex</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰€æœ‰æƒè½¬ç§»ï¼ˆunique_lockå¯¹è±¡ä¹‹é—´çš„è½¬ç§»ï¼‰</span></span><br><span class="line"><span class="function">unique_lock&lt;mutex&gt; <span class="title">lock4</span><span class="params">(move(lock))</span></span>;	<span class="comment">//æ‰€æœ‰æƒè½¬ç§»ï¼Œæ­¤æ—¶ç”±lockæ¥ç®¡ç†äº’æ–¥é‡mtx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦é”æˆåŠŸ</span></span><br><span class="line"><span class="keyword">if</span> (lock2.<span class="built_in">owns_lock</span>())</span><br><span class="line">&#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;é”æˆåŠŸ&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸš©æ¡ä»¶å˜é‡-condition-variable"><a href="#ğŸš©æ¡ä»¶å˜é‡-condition-variable" class="headerlink" title="ğŸš©æ¡ä»¶å˜é‡ condition_variable"></a>ğŸš©æ¡ä»¶å˜é‡ condition_variable</h2><blockquote><p>ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡ <code>std::condition_variable</code>ï¼Ÿ</p></blockquote><p><code>std::condition_variable</code> æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ªåŒæ­¥åŸè¯­ï¼Œç”¨äºå®ç°çº¿ç¨‹é—´çš„é€šä¿¡å’ŒåŒæ­¥ã€‚å®ƒé€šå¸¸ä¸ <code>std::mutex</code> é…åˆä½¿ç”¨ï¼Œ<font color="#00b050">å…è®¸ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„é€šçŸ¥</font>ï¼Œä»è€Œå®ç°çº¿ç¨‹é—´çš„åä½œã€‚</p><blockquote><p>æ¡ä»¶å˜é‡çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</p></blockquote><ul><li><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</strong>ï¼šä¸€ä¸ªçº¿ç¨‹ç”Ÿäº§æ•°æ®ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹æ•°æ®ï¼Œé€šè¿‡æ¡ä»¶å˜é‡å®ç°åŒæ­¥ã€‚</li><li><strong>äº‹ä»¶é€šçŸ¥</strong>ï¼šä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æŸä¸ªäº‹ä»¶çš„å‘ç”Ÿï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å®ƒã€‚</li><li><strong>çº¿ç¨‹åä½œ</strong>ï¼šå¤šä¸ªçº¿ç¨‹éœ€è¦åä½œå®Œæˆä»»åŠ¡ï¼Œé€šè¿‡æ¡ä»¶å˜é‡å®ç°åŒæ­¥ã€‚</li></ul><h3 id="ğŸ’»ä»£ç ç¤ºä¾‹-1"><a href="#ğŸ’»ä»£ç ç¤ºä¾‹-1" class="headerlink" title="ğŸ’»ä»£ç ç¤ºä¾‹"></a>ğŸ’»ä»£ç ç¤ºä¾‹</h3><ul><li><strong>ç­‰å¾…ï¼ˆwaitï¼‰</strong>ï¼šä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ <code>wait()</code> æ–¹æ³•ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ <code>notify_one()</code> æˆ– <code>notify_all()</code> é€šçŸ¥å®ƒã€‚<br>çº¿ç¨‹è¿›å…¥ç­‰å¾…æœŸé—´ï¼Œä¼šé‡Šæ”¾ä¸ä¹‹å…³è”çš„äº’æ–¥é”ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è®¿é—®å…±äº«æ•°æ®ã€‚å½“çº¿ç¨‹è¢«å”¤é†’åï¼Œä¼šé‡æ–°è·å–äº’æ–¥é”å¹¶ç»§ç»­æ‰§è¡Œã€‚</li><li><strong>é€šçŸ¥ï¼ˆnotifyï¼‰</strong>ï¼šå¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ <code>notify_one()</code> æˆ– <code>notify_all()</code> æ–¹æ³•ï¼Œå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œ</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mutex&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;condition_variable&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line">mutex mtx;  </span><br><span class="line">condition_variable cv;  </span><br><span class="line"><span class="type">int</span> MyValue = <span class="number">0</span>;  </span><br><span class="line"><span class="type">bool</span> turn = <span class="literal">false</span>;  <span class="comment">//æ§åˆ¶å“ªä¸ªçº¿ç¨‹è¯¥æ‰§è¡Œ  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Increment</span><span class="params">(<span class="type">int</span> thread_id)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;  </span><br><span class="line">        <span class="function">unique_lock&lt;mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;  </span><br><span class="line">        cv.<span class="built_in">wait</span>(lock, [&amp;] &#123; <span class="keyword">return</span> thread_id == <span class="number">1</span> ? !turn : turn; &#125;);  </span><br><span class="line">        ++MyValue;  </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Thread &quot;</span> &lt;&lt; thread_id &lt;&lt; <span class="string">&quot; incremented value to: &quot;</span> &lt;&lt; MyValue &lt;&lt; endl;  </span><br><span class="line">        <span class="comment">// åˆ‡æ¢turnæ ‡å¿—å¹¶é€šçŸ¥å¦ä¸€ä¸ªçº¿ç¨‹  </span></span><br><span class="line">        turn = !turn;  </span><br><span class="line">        cv.<span class="built_in">notify_all</span>();    <span class="comment">//è¿™é‡Œåªéœ€è¦notify_one()å³å¯  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(Increment, <span class="number">1</span>)</span></span>;  </span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(Increment, <span class="number">2</span>)</span></span>;  </span><br><span class="line">    t1.<span class="built_in">join</span>();  </span><br><span class="line">    t2.<span class="built_in">join</span>();  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Final Value: &quot;</span> &lt;&lt; MyValue &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Thread 1 incremented value to: 1</span></span><br><span class="line"><span class="comment">//Thread 2 incremented value to: 2</span></span><br><span class="line"><span class="comment">//Thread 1 incremented value to: 3</span></span><br><span class="line"><span class="comment">//Thread 2 incremented value to: 4</span></span><br><span class="line"><span class="comment">//Thread 1 incremented value to: 5</span></span><br><span class="line"><span class="comment">//Thread 2 incremented value to: 6</span></span><br><span class="line"><span class="comment">//Final Value: 6</span></span><br></pre></td></tr></table></figure><ol><li><code>wait(std::unique_lock&lt;std::mutex&gt;&amp;, Predicate)</code>ï¼Œå…¶ä¸­ <code>Predicate</code> æŒ‡å¯è°ƒç”¨å¯¹è±¡ã€‚</li><li><code>wait_for(std::unique_lock&lt;std::mutex&gt;&amp;, std::chrono::seconds, Predicate)</code>ï¼šå…è®¸æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿™æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å”¤é†’ä¿¡å·/æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™å‡½æ•°ä¼šè¿”å›ï¼Œå¹¶ä¸”çº¿ç¨‹ä¼šé‡æ–°è·å–äº’æ–¥é”ã€‚</li><li><code>notify_one()</code>ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œé€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹éœ€è¦è¢«å”¤é†’çš„åœºæ™¯ã€‚<br>ä¾‹å¦‚ï¼Œç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œç”Ÿäº§è€…ç”Ÿäº§ä¸€ä¸ªæ•°æ®åï¼Œåªéœ€è¦å”¤é†’ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚</li><li><strong><code>notify_all()</code></strong>ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œé€‚ç”¨äºå¤šä¸ªçº¿ç¨‹éœ€è¦è¢«å”¤é†’çš„åœºæ™¯ã€‚<br>ä¾‹å¦‚ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç­‰å¾…åŒä¸€ä¸ªæ¡ä»¶å˜é‡æ—¶ï¼Œç”Ÿäº§è€…ç”Ÿäº§æ•°æ®åï¼Œéœ€è¦å”¤é†’æ‰€æœ‰æ¶ˆè´¹è€…ã€‚</li></ol><p>ä»£ç ç¤ºä¾‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line">std::mutex mtx; <span class="comment">// å®šä¹‰ä¸€ä¸ªäº’æ–¥é”  </span></span><br><span class="line">std::condition_variable cv; <span class="comment">// å®šä¹‰ä¸€ä¸ªæ¡ä»¶å˜é‡  </span></span><br><span class="line">std::queue&lt;<span class="type">int</span>&gt; SharedQueue; <span class="comment">// å…±äº«é˜Ÿåˆ— </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">(<span class="type">bool</span> notify_all)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50000</span>; ++i) &#123;   <span class="comment">//æ ·æœ¬æ•°è¾ƒå¤§æ—¶æ•ˆæœæ›´åŠ ç›´è§‚  </span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>; <span class="comment">// è‡ªåŠ¨é”å®š    </span></span><br><span class="line">		SharedQueue.<span class="built_in">push</span>(i); <span class="comment">// ç”Ÿäº§æ•°æ®    </span></span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Produced: &quot;</span> &lt;&lt; i &lt;&lt; endl;  </span><br><span class="line">        <span class="keyword">if</span> (notify_all) &#123;  </span><br><span class="line">            cv.<span class="built_in">notify_all</span>(); <span class="comment">// é€šçŸ¥æ‰€æœ‰æ¶ˆè´¹è€…    </span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            cv.<span class="built_in">notify_one</span>(); <span class="comment">// é€šçŸ¥ä¸€ä¸ªæ¶ˆè´¹è€…    </span></span><br><span class="line">		&#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">consumer</span><span class="params">(<span class="type">int</span> id)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;  </span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>; <span class="comment">// è‡ªåŠ¨é”å®š    </span></span><br><span class="line">		cv.<span class="built_in">wait</span>(lock, [] &#123; <span class="keyword">return</span> !SharedQueue.<span class="built_in">empty</span>(); &#125;); <span class="comment">// ç­‰å¾…é˜Ÿåˆ—éç©º  </span></span><br><span class="line">        <span class="type">int</span> value = SharedQueue.<span class="built_in">front</span>(); <span class="comment">// æ¶ˆè´¹æ•°æ®    </span></span><br><span class="line">		SharedQueue.<span class="built_in">pop</span>();  </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Consumer &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; consumed: &quot;</span> &lt;&lt; value &lt;&lt; endl;  </span><br><span class="line">        <span class="keyword">if</span> (value == <span class="number">4</span>) <span class="keyword">break</span>; <span class="comment">// ç»“æŸæ¡ä»¶  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="type">bool</span> notify_all = <span class="literal">true</span>; <span class="comment">// é€‰æ‹© notify_all æˆ– notify_one</span></span><br><span class="line">    <span class="function">std::thread <span class="title">producerThread</span><span class="params">(producer, notify_all)</span></span>;  </span><br><span class="line">    <span class="function">std::thread <span class="title">consumerThread1</span><span class="params">(consumer, <span class="number">1</span>)</span></span>;  </span><br><span class="line">    <span class="function">std::thread <span class="title">consumerThread2</span><span class="params">(consumer, <span class="number">2</span>)</span></span>;  </span><br><span class="line">  </span><br><span class="line">    producerThread.<span class="built_in">join</span>();  </span><br><span class="line">    consumerThread1.<span class="built_in">join</span>();  </span><br><span class="line">    consumerThread2.<span class="built_in">join</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é€‰æ‹© <code>notify_one()</code>ï¼šç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼ˆå’Œ id ç­‰æ— å…³ï¼‰æ‰§è¡Œå‡½æ•°<br></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Produced: 0</span><br><span class="line">Produced: 1</span><br><span class="line">Produced: 2</span><br><span class="line">...</span><br><span class="line">Consumer 1 consumed: 0</span><br><span class="line">Consumer 1 consumed: 1</span><br><span class="line">Produced: 9</span><br><span class="line">Produced: 10</span><br><span class="line">Consumer 1 consumed: 3</span><br><span class="line">Consumer 1 consumed: 4</span><br><span class="line">Consumer 1 consumed: 5</span><br><span class="line">...</span><br><span class="line">Consumer 1 consumed: 49999</span><br></pre></td></tr></table></figure><p></p><p>é€‰æ‹© <code>notify_all()</code>ï¼šç”±äºæ¶ˆè´¹è€…çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œå¾ˆå¯èƒ½å‡ºç°ä»…æœ‰ consumer 1/2 å‚ä¸çš„æƒ…å†µã€‚<br></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Produced: 0</span><br><span class="line">Produced: 1</span><br><span class="line">Produced: 2</span><br><span class="line">...</span><br><span class="line">Consumer 1 consumed: 0</span><br><span class="line">Consumer 1 consumed: 1</span><br><span class="line">Produced: 9</span><br><span class="line">Produced: 10</span><br><span class="line">Consumer 2 consumed: 3</span><br><span class="line">Consumer 2 consumed: 4</span><br><span class="line">Consumer 2 consumed: 5</span><br><span class="line">...</span><br><span class="line">Consumer 1 consumed: 49999</span><br></pre></td></tr></table></figure><br>æ¯æ¬¡è¿è¡Œçš„è¾“å‡ºç»“æœä¸ä¼šå®Œå…¨ä¸€è‡´ï¼Œä½†å¤§ä½“é€»è¾‘ä¸å˜ã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/uqJNdUG.png" alt="|916"><p></p><h2 id="ğŸš©è¯»å†™é”-shared-mutex"><a href="#ğŸš©è¯»å†™é”-shared-mutex" class="headerlink" title="ğŸš©è¯»å†™é” shared_mutex"></a>ğŸš©è¯»å†™é” shared_mutex</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-1"><a href="#åŸºæœ¬æ¦‚å¿µ-1" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>ä»€ä¹ˆæ˜¯è¯»å†™é”ï¼Ÿ</p></blockquote><p>è¯»å†™é”ï¼ˆå…±äº«é”ã€ç‹¬å é”ï¼‰æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–èµ„æºï¼Œä½†æ˜¯åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥èµ„æºã€‚</p><blockquote><p>åŸºæœ¬ç‰¹å¾ï¼Ÿ</p></blockquote><p>è¯»è¯»ä¹‹é—´ä¸äº’æ–¥ï¼Œå†™å†™/è¯»å†™ä¹‹é—´äº’æ–¥ã€‚</p><div class="table-container"><table><thead><tr><th>ç‰¹æ€§</th><th>æè¿°</th></tr></thead><tbody><tr><td>å…±äº«é”</td><td>- å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰<br>- å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘åœ°è¯»å–å…±äº«èµ„æº<br>- ä¸èƒ½ä¸ç‹¬å é”åŒæ—¶æŒæœ‰</td></tr><tr><td>ç‹¬å é”</td><td>- åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰<br>- æŒæœ‰ç‹¬å é”çš„çº¿ç¨‹å¯ä»¥å†™å…¥å…±äº«èµ„æº<br>- å½“æŒæœ‰ç‹¬å é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½æŒæœ‰å…±äº«é”æˆ–ç‹¬å é”</td></tr><tr><td>è¯»å†™åˆ†ç¦»</td><td>- è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†å¼€å¤„ç†ï¼Œæé«˜å¹¶å‘æ€§èƒ½<br>- å½“æŒæœ‰ç‹¬å é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½æŒæœ‰å…±äº«é”æˆ–ç‹¬å é”</td></tr><tr><td>äº’æ–¥æ€§</td><td>- è¯»å†™é”ä¸­çš„å†™æ“ä½œä¸å…¶ä»–å†™æ“ä½œã€è¯»æ“ä½œäº’æ–¥<br>- è¯»æ“ä½œä¹‹é—´ä¸äº’æ–¥</td></tr><tr><td>å…¬å¹³æ€§</td><td>- æœ‰äº›è¯»å†™é”å®ç°æä¾›å…¬å¹³æ€§æœºåˆ¶ï¼Œç¡®ä¿è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹ä¸ä¼šè¢«é•¿æœŸé˜»å¡</td></tr><tr><td>æ€§èƒ½</td><td>- åœ¨<font color="#00b050">è¯»å¤šå†™å°‘</font>çš„æƒ…å†µä¸‹èƒ½æ˜¾è‘—æé«˜æ€§èƒ½<br>- åœ¨å†™å¤šçš„æƒ…å†µä¸‹ï¼Œè¯»å†™é”çš„æ€§èƒ½ä¼˜åŠ¿å¯èƒ½ä¸æ˜æ˜¾</td></tr></tbody></table></div><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><h4 id="shared-mutex"><a href="#shared-mutex" class="headerlink" title="shared_mutex"></a>shared_mutex</h4><p><code>std::shared_mutex</code> æ˜¯ C++17 å¼•å…¥çš„ä¸€ç§äº’æ–¥é”ï¼Œæ”¯æŒå¤šè¯»å•å†™çš„å¹¶å‘è®¿é—®æ¨¡å¼ã€‚<br>å®ƒå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰å…±äº«é”ï¼ˆè¯»é”ï¼‰ï¼Œä½†åœ¨æŒæœ‰ç‹¬å é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½å†æŒæœ‰ä»»ä½•ç±»å‹çš„é”ã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/p13vBAL.png" alt="|566"><br>è™½ç„¶å…¶å­˜åœ¨æ’ä»–æ€§é”å®šçš„æˆå‘˜å‡½æ•°ï¼ˆlock/unlock ç­‰ï¼‰ï¼Œä½†æ˜¯ä¸€èˆ¬ä½¿ç”¨ï¼š<br><code>unique_lock</code> / <code>lock_guard</code> ç®¡ç†<font color="#00b050">ç‹¬å é”</font>ï¼ˆæ’ä»–æ€§é”å®šï¼‰ï¼Œ<code>shared_mutex</code> ç®¡ç†<font color="#00b050">å…±äº«é”å®š</font>ã€‚<br><code>unique_lock</code> å’Œ <code>shared_mutex</code> éƒ½ä¼šè‡ªåŠ¨ä¸Šé”ï¼ˆæ„é€ å‡½æ•°å®ç°äº†ï¼‰ã€‚å‰è€…ä½äºå¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code> ä¸­ï¼Œåè€…ä½äºå¤´æ–‡ä»¶ <code>&lt;shared_mutex&gt;</code> ä¸­ã€‚</p><h4 id="shared-lock"><a href="#shared-lock" class="headerlink" title="shared_lock"></a>shared_lock</h4><p>C++17 å¼•å…¥çš„ä¸€ç§é”ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç† <code>shared_mutex</code> çš„å…±äº«é”ã€‚<code>shared_lock</code> åŒæ ·å¯ä»¥è‡ªåŠ¨è·å–å’Œé‡Šæ”¾é”ã€‚<br><code>shared_lock</code> ä¹Ÿç§°é€šç”¨å…±äº«äº’æ–¥æ‰€æœ‰æƒåŒ…è£…å™¨ï¼Œ<code>unique_lock</code> ä¹Ÿç§°ç‹¬å æ‰€æœ‰æƒåŒ…è£…å™¨ï¼ŒäºŒè€…é…åˆä½¿ç”¨å¯¹ <code>shared_mutex</code> è¿›è¡Œç®¡ç†ï¼Œå®ç°è¯»å†™é”ã€‚</p><div class="table-container"><table><thead><tr><th>æˆå‘˜å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>std::shared_lock(mutex_type&amp; m)</code></td><td>æ„é€ æ—¶è·å–å…±äº«é”</td></tr><tr><td><code>std::shared_lock(mutex_type&amp; m, std::defer_lock)</code></td><td>æ„é€ æ—¶ä¸è·å–é”</td></tr><tr><td><code>std::shared_lock(mutex_type&amp; m, std::try_to_lock)</code></td><td>æ„é€ æ—¶å°è¯•è·å–å…±äº«é”</td></tr><tr><td><code>std::shared_lock(mutex_type&amp; m, std::adopt_lock)</code></td><td>æ„é€ æ—¶è®¤ä¸ºè°ƒç”¨è€…å·²ç»æŒæœ‰å…±äº«é”</td></tr><tr><td><code>lock()</code></td><td>è·å–å…±äº«é”</td></tr><tr><td><code>try_lock()</code></td><td>å°è¯•è·å–å…±äº«é”</td></tr><tr><td><code>unlock()</code></td><td>é‡Šæ”¾å…±äº«é”</td></tr><tr><td><code>owns_lock()</code></td><td>è¿”å›ç»“æœï¼šé”æ˜¯å¦è¢«æŒæœ‰</td></tr><tr><td><code>release()</code></td><td>é‡Šæ”¾é”çš„æ‰€æœ‰æƒï¼Œä½†ä¸è§£é”</td></tr></tbody></table></div><hr><p>ğŸ’»ä»£ç ç¤ºä¾‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line">std::shared_mutex rw_mutex; <span class="comment">// è¯»å†™é”  </span></span><br><span class="line"><span class="type">int</span> shared_data = <span class="number">0</span>; <span class="comment">// å…±äº«æ•°æ®  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// è¯»çº¿ç¨‹å‡½æ•°  </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="function">std::shared_lock <span class="title">lock</span><span class="params">(rw_mutex)</span></span>; <span class="comment">// ç”³è¯·å…±äº«é”  </span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Reader thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; reads value: &quot;</span> &lt;&lt; shared_data &lt;&lt; std::endl;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// å†™çº¿ç¨‹å‡½æ•°  </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">writer</span><span class="params">(<span class="type">int</span> value)</span> </span>&#123;  </span><br><span class="line">    <span class="function">std::unique_lock <span class="title">lock</span><span class="params">(rw_mutex)</span></span>; <span class="comment">// ç”³è¯·ç‹¬å é”  </span></span><br><span class="line">    shared_data = value; <span class="comment">// ä¿®æ”¹å…±äº«æ•°æ®  </span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Writer thread: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; <span class="string">&quot; writes value: &quot;</span> &lt;&lt; shared_data &lt;&lt; std::endl;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    std::vector&lt;std::thread&gt; threads; <span class="comment">// ç”¨äºå­˜å‚¨çº¿ç¨‹çš„å‘é‡  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åˆ›å»ºè¯»çº¿ç¨‹  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;  </span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(reader);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// åˆ›å»ºå†™çº¿ç¨‹  </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;  </span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(writer, i);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ  </span></span><br><span class="line">    <span class="keyword">for</span> (std::thread&amp; t : threads) &#123;  </span><br><span class="line">        t.<span class="built_in">join</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>è¾“å‡ºç»“æœï¼š<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Reader thread: Reader thread: 3 reads value: Reader thread: 5 reads value: 00</span><br><span class="line">Reader thread: 4 reads value: 0</span><br><span class="line"></span><br><span class="line">Reader thread: 6 reads value: 0</span><br><span class="line">2 reads value: 0</span><br><span class="line">Writer thread: 7 writes value: 0</span><br><span class="line">Writer thread: 8 writes value: 1</span><br></pre></td></tr></table></figure><br>è¯»çš„è¾“å‡ºæ¯”è¾ƒæ··ä¹±ï¼Œæ˜¯å› ä¸ºè¯»ä¸è¯»æ“ä½œä¹‹é—´å¹¶ä¸äº’æ–¥ã€‚<p></p><h2 id="ğŸš©åŸå­å˜é‡å’ŒåŸå­æ“ä½œ-atomic"><a href="#ğŸš©åŸå­å˜é‡å’ŒåŸå­æ“ä½œ-atomic" class="headerlink" title="ğŸš©åŸå­å˜é‡å’ŒåŸå­æ“ä½œ atomic"></a>ğŸš©åŸå­å˜é‡å’ŒåŸå­æ“ä½œ atomic</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-2"><a href="#åŸºæœ¬æ¦‚å¿µ-2" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>åŸå­å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><p>åŸå­å˜é‡æ˜¯æŒ‡ä½¿ç”¨ <code>std::atomic</code> æ¨¡æ¿ç±»å®šä¹‰çš„å˜é‡ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯¹å˜é‡çš„è¯»å†™æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­æˆ–å¹²æ‰°ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰åŸå­å˜é‡</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">atomicInt</span><span class="params">(<span class="number">10</span>)</span></span>;	<span class="comment">//intå‹çš„åŸå­å˜é‡</span></span><br></pre></td></tr></table></figure><p></p><blockquote><p>åŸå­å˜é‡çš„ç‰¹æ€§</p></blockquote><ul><li><strong>åŸå­æ€§</strong>ï¼šå¯¹åŸå­å˜é‡çš„è¯»ã€å†™ã€ä¿®æ”¹æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œå³æ“ä½œ<font color="#00b050">è¦ä¹ˆå®Œå…¨å®Œæˆï¼Œè¦ä¹ˆå®Œå…¨ä¸å®Œæˆ</font>ã€‚</li><li><strong>æ— é”</strong>ï¼šåŸå­æ“ä½œ<font color="#00b050">ä¸éœ€è¦é”æœºåˆ¶</font>ï¼Œå› æ­¤ä¸ä¼šå¼•èµ·ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šæŒ‡æ“ä½œç³»ç»Ÿä»ä¸€ä¸ªçº¿ç¨‹è½¬æ¢åˆ°å¦ä¸€çº¿ç¨‹çš„è¿‡ç¨‹ï¼‰</li><li><strong>æ˜“ç”¨æ€§</strong>ï¼šæ ‡å‡†åº“æä¾›äº†åŸå­æ“ä½œæ¥å£ï¼Œç®€åŒ–äº†<font color="#00b050">å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„åŒæ­¥é—®é¢˜</font>ã€‚</li></ul><blockquote><p>åŸå­æ“ä½œæ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><p>åŸå­æ“ä½œæ˜¯æŒ‡å¯¹åŸå­å˜é‡è¿›è¡Œçš„ä¸å¯åˆ†å‰²çš„æ“ä½œã€‚ä¸å¯åˆ†å‰²çš„æ„æ€æ˜¯è¿™äº›æ“ä½œè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œï¼Œä¸ä¼šåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</p><h3 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line">atomic&lt;<span class="type">int</span>&gt; num = <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddNum</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; ++i) &#123;  </span><br><span class="line">        num++;  </span><br><span class="line">        <span class="comment">//num += 1;	//ç»“æœä¸º2000000</span></span><br><span class="line">        <span class="comment">//num = num + 1;  //ç»“æœä¸º1259262</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(AddNum)</span></span>;  </span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(AddNum)</span></span>;  </span><br><span class="line">    t1.<span class="built_in">join</span>();  </span><br><span class="line">    t2.<span class="built_in">join</span>();  </span><br><span class="line">    cout &lt;&lt; num &lt;&lt; endl;	<span class="comment">//2000000</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>âœ…æ³¨æ„ï¼šåŸå­å˜é‡å¯ä»¥è¿›è¡ŒåŸå­æ“ä½œï¼ŒåŸå­æ“ä½œæ‰æ˜¯çœŸæ­£ä¿è¯å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„æ ¹æœ¬åŸå› ã€‚å³ä½¿ä½¿ç”¨åŸå­å˜é‡ï¼Œå¦‚æœè¿›è¡Œçš„ä¸æ˜¯åŸå­æ“ä½œï¼Œä¹Ÿæ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚<br>å¦‚æœä½¿ç”¨ <code>num = num + 1</code>ï¼Œä¼šå‘ç°è¾“å‡ºç»“æœå¹¶ä¸æ˜¯é¢„æœŸçš„ 2000000ï¼Œè¿™æ˜¯å› ä¸ºè¯¥æ“ä½œå¹¶ä¸æ˜¯åŸå­æ“ä½œï¼ˆæ²¡æœ‰è¢« <code>atomic</code> ç±»é‡è½½ï¼‰ã€‚</p><h3 id="å¸¸è§åŸå­æ“ä½œæ–¹æ³•"><a href="#å¸¸è§åŸå­æ“ä½œæ–¹æ³•" class="headerlink" title="å¸¸è§åŸå­æ“ä½œæ–¹æ³•"></a>å¸¸è§åŸå­æ“ä½œæ–¹æ³•</h3><ol><li>åŠ è½½å’Œå­˜å‚¨æ“ä½œ<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> value = atomicInt.<span class="built_in">load</span>();	<span class="comment">//åŸå­åŠ è½½</span></span><br><span class="line">atomicInt.<span class="built_in">store</span>(<span class="number">10</span>);	<span class="comment">//åŸå­å­˜å‚¨</span></span><br></pre></td></tr></table></figure></li><li>è¯»å†™æ“ä½œï¼ˆç­‰ä»·äº load å’Œ storeï¼‰<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> value = atomicInt;	<span class="comment">//åŸå­è¯»å–</span></span><br><span class="line">atomicInt = <span class="number">10</span>;	<span class="comment">//åŸå­å†™å…¥</span></span><br></pre></td></tr></table></figure></li><li>è‡ªå¢è‡ªå‡æ“ä½œ<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">atomicInt++;</span><br><span class="line">atomicInt--;</span><br><span class="line">++atomicInt;</span><br><span class="line">--atomicInt;</span><br></pre></td></tr></table></figure></li><li>å¤åˆèµ‹å€¼æ“ä½œ<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">atomicInt += <span class="number">5</span>;	<span class="comment">//åŸå­åŠ </span></span><br><span class="line">atomicInt &amp;= <span class="number">3</span>;	<span class="comment">//åŸå­ä½ä¸</span></span><br></pre></td></tr></table></figure></li><li>é«˜çº§æ“ä½œ<br><code>compare_exchange</code>ï¼šæ¯”è¾ƒå½“å‰å€¼å’ŒæœŸæœ›å€¼ï¼Œå¦‚æœç›¸ç­‰åˆ™å°†å½“å‰å€¼æ›¿æ¢ä¸ºæ–°å€¼ï¼Œå¦åˆ™æ›´æ–°æœŸæœ›å€¼ã€‚<br><code>fetch_add</code> / <code>fetch_sub</code> / <code>fetch_and</code>ï¼šå¯¹å½“å‰å€¼è¿›è¡ŒåŠ æ³•/å‡æ³•/æŒ‰ä½ä¸æ“ä½œï¼Œå¹¶è¿”å›æ“ä½œå‰çš„å€¼ã€‚<br><code>exchange</code>ï¼šäº¤æ¢å½“å‰å€¼å’Œæ–°å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> expected = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> desired = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (atomicInt.<span class="built_in">compare_exchange_strong</span>(expected, desired))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// å¦‚æœatomicInt == expectedï¼Œåˆ™è®©atomicInt = desiredå¹¶è¿”å›true</span></span><br><span class="line">	<span class="comment">// å¦åˆ™expected = atomicIntï¼Œè¿”å›false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">atomicInt.<span class="built_in">fetch_add</span>(<span class="number">1</span>, memory_order_relaxed);</span><br><span class="line"></span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">int</span>&gt; <span class="title">value</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line"><span class="type">int</span> old_value = value.<span class="built_in">exchange</span>(<span class="number">20</span>); <span class="comment">// äº¤æ¢å€¼ï¼Œè¿”å›æ—§å€¼ 10ï¼Œç°åœ¨value = 20</span></span><br></pre></td></tr></table></figure>ä»¥ä¸ŠåŸå­æ“ä½œä»…é’ˆå¯¹åŸå­å˜é‡ç”Ÿæ•ˆã€‚<h3 id="åŸå­æ“ä½œçš„å†…å­˜åºé—®é¢˜"><a href="#åŸå­æ“ä½œçš„å†…å­˜åºé—®é¢˜" class="headerlink" title="åŸå­æ“ä½œçš„å†…å­˜åºé—®é¢˜"></a>åŸå­æ“ä½œçš„å†…å­˜åºé—®é¢˜</h3>åŸå­æ“ä½œå¯ä»¥æŒ‡å®šä¸åŒçš„å†…å­˜é¡ºåºï¼Œä»¥æ§åˆ¶æ“ä½œçš„å¯è§æ€§å’Œæ’åºã€‚<br>å†…å­˜åºä¸ä¼šå½±å“åŸå­æ“ä½œçš„åŸå­æ€§ï¼Œä½†ä¼šå½±å“æ“ä½œçš„å¯è§æ€§å’Œé¡ºåºã€‚</li></ol><div class="table-container"><table><thead><tr><th>é¡ºåº</th><th>ç‰¹ç‚¹</th></tr></thead><tbody><tr><td><code>memory_order_relaxed</code></td><td>æ²¡æœ‰åŒæ­¥æˆ–é¡ºåºçº¦æŸï¼Œä»…ä¿è¯åŸå­æ€§</td></tr><tr><td><code>memory_order_acquire</code></td><td>ç¡®ä¿è¯¥æ“ä½œä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°è¯¥æ“ä½œä¹‹å</td></tr><tr><td><code>memory_order_release</code></td><td>ç¡®ä¿è¯¥æ“ä½œä¹‹åçš„æ‰€æœ‰å†™æ“ä½œä¸ä¼šè¢«é‡æ’åºåˆ°è¯¥æ“ä½œä¹‹å‰</td></tr><tr><td><code>memory_order_acq_rel</code></td><td>åŒæ—¶å…·å¤‡ acquire å’Œ release çš„å±æ€§</td></tr><tr><td><code>memory_order_seq_cst</code></td><td>é¡ºåºä¸€è‡´æ€§ï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹çš„æ“ä½œæŒ‰ç…§é¡ºåºå‘ç”Ÿ</td></tr></tbody></table></div><h2 id="ğŸš©ä¿¡å·é‡-semaphore"><a href="#ğŸš©ä¿¡å·é‡-semaphore" class="headerlink" title="ğŸš©ä¿¡å·é‡ semaphore"></a>ğŸš©ä¿¡å·é‡ semaphore</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-3"><a href="#åŸºæœ¬æ¦‚å¿µ-3" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>ä»€ä¹ˆæ˜¯ä¿¡å·é‡ï¼Ÿ</p></blockquote><p>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰æ˜¯ä¸€ç§ç”¨äºç®¡ç†å’Œåè°ƒå¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹è®¿é—®å…±äº«èµ„æºçš„åŒæ­¥æœºåˆ¶ã€‚å®ƒ<font color="#00b050">é€šè¿‡è®¡æ•°å™¨æ¥æ§åˆ¶å¯¹èµ„æºçš„è®¿é—®æ•°é‡</font>ï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹èƒ½å¤Ÿå®‰å…¨åœ°ä½¿ç”¨å…±äº«èµ„æºè€Œä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰æˆ–æ­»é”ã€‚ä¼ ç»Ÿçš„é”ï¼ˆå¦‚äº’æ–¥é”ï¼‰å¯ä»¥ç”¨æ¥ä¿æŠ¤å…±äº«èµ„æºï¼Œä½†å¯¹äºæŸäº›åœºæ™¯ï¼ˆå¦‚<font color="#00b050">èµ„æºçš„è®¡æ•°ç®¡ç†</font>ï¼‰ï¼Œä¿¡å·é‡æä¾›äº†æ›´çµæ´»å’Œé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p><blockquote><p>ä¿¡å·é‡çš„ç±»å‹ï¼Ÿ</p></blockquote><ol><li>è®¡æ•°ä¿¡å·é‡ï¼šå…è®¸å¯¹èµ„æºçš„å¤šæ¬¡è®¿é—®ï¼Œè®¡æ•°ä¿¡å·é‡çš„å€¼å¯ä»¥æ˜¯ä»»æ„éè´Ÿæ•´æ•°ï¼Œè¡¨ç¤ºå¯ä»¥åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹æˆ–è¿›ç¨‹çš„æ•°é‡ã€‚</li><li>äºŒå…ƒä¿¡å·é‡ï¼šä¹Ÿç§°ä¸ºäº’æ–¥ä¿¡å·é‡ mutexï¼Œå…¶å€¼åªèƒ½æ˜¯ 0 æˆ– 1ï¼Œç±»ä¼¼äºäº’æ–¥é”ï¼Œç”¨äºå®ç°å¯¹èµ„æºçš„äº’æ–¥è®¿é—®ã€‚</li></ol><blockquote><p>ä¿¡å·é‡çš„ä½œç”¨ï¼Ÿ</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/dyvLJVP.png" alt="|684"></p><blockquote><p>ä¿¡å·é‡çš„åŸºæœ¬æ“ä½œï¼Ÿ</p></blockquote><ul><li>P æ“ä½œï¼ˆç­‰å¾…ï¼Œwaitï¼‰ï¼šå¦‚æœä¿¡å·é‡çš„å€¼å¤§äº 0ï¼Œåˆ™å°†å…¶å‡ 1ï¼Œå¦åˆ™çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ä¿¡å·é‡çš„å€¼å¤§äº 0ã€‚</li><li>V æ“ä½œï¼ˆé‡Šæ”¾ï¼Œsignalï¼‰ï¼šå°†ä¿¡å·é‡çš„å€¼åŠ  1ï¼Œå¦‚æœæœ‰çº¿ç¨‹è¢«é˜»å¡åœ¨ P æ“ä½œä¸Šï¼Œåˆ™å”¤é†’ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹ã€‚<br>PV æ“ä½œå‡ä¸ºåŸå­æ“ä½œã€‚ç±»ä¼¼åŠ é”è§£é”çš„æ“ä½œã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/EE1rJR3.png" alt="|590"><h3 id="counting-semaphore"><a href="#counting-semaphore" class="headerlink" title="counting_semaphore"></a>counting_semaphore</h3><code>std::counting_semaphore</code> æ˜¯ C++20 æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªç±»æ¨¡æ¿ï¼Œå®ç°äº†ä¸€ä¸ªè®¡æ•°ä¿¡å·é‡ã€‚éœ€è¦å¤´æ–‡ä»¶ <code>&lt;semaphore&gt;</code><br>ç¦æ­¢æ‹·è´æ„é€ ï¼Œç¦æ­¢æ‹·è´èµ‹å€¼æ“ä½œï¼ˆä¸å…è®¸ <code>a(b)</code> æˆ–è€… <code>a = b</code>ï¼‰ã€‚</li></ul><div class="table-container"><table><thead><tr><th>æˆå‘˜å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>void acquire()</code></td><td>å°è¯•è·å–ä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„è®¡æ•°å€¼ä¸º 0ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è®¡æ•°å€¼å¤§äº 0ã€‚</td></tr><tr><td><code>bool try_acquire()</code></td><td>- å°è¯•è·å–ä¿¡å·é‡ã€‚å¦‚æœä¿¡å·é‡çš„è®¡æ•°å€¼å¤§äº 0ï¼Œåˆ™å°†å…¶å‡ 1 å¹¶è¿”å› <code>true</code>ã€‚<br>- å¦‚æœè®¡æ•°å€¼ä¸º 0ï¼Œåˆ™ç«‹å³è¿”å› <code>false</code>ï¼Œä¸ä¼šé˜»å¡ã€‚</td></tr><tr><td><code>bool try_acquire_for(const chrono::duration&amp;)</code></td><td>- å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ä¿¡å·é‡çš„è®¡æ•°å€¼å¤§äº 0ï¼Œåˆ™å°†å…¶å‡ 1 å¹¶è¿”å› <code>true</code>ã€‚<br>- å¦‚æœè¶…æ—¶ä»æœªè·å–åˆ°ä¿¡å·é‡ï¼Œåˆ™è¿”å› <code>false</code>ã€‚</td></tr><tr><td><code>bool try_acquire_until(const chrono::time_point&amp;)</code></td><td>- å¦‚æœåœ¨æŒ‡å®šæ—¶é—´ç‚¹ä¹‹å‰ä¿¡å·é‡çš„è®¡æ•°å€¼å¤§äº 0ï¼Œåˆ™å°†å…¶å‡ 1 å¹¶è¿”å› <code>true</code>ã€‚<br>- å¦‚æœè¶…æ—¶ä»æœªè·å–åˆ°ä¿¡å·é‡ï¼Œåˆ™è¿”å› <code>false</code>ã€‚</td></tr><tr><td><code>void release(std::ptrdiff_t update = 1)</code></td><td>é‡Šæ”¾ä¿¡å·é‡ï¼Œå¢åŠ ä¿¡å·é‡çš„è®¡æ•°å€¼ã€‚é»˜è®¤åŠ  1ã€‚</td></tr></tbody></table></div><p>ç¤ºä¾‹ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæœ€å¤§å€¼ä¸º 5 çš„è®¡æ•°ä¿¡å·é‡</span></span><br><span class="line"><span class="function">std::counting_semaphore&lt;5&gt; <span class="title">semaphore</span><span class="params">(<span class="number">3</span>)</span></span>; <span class="comment">// åˆå§‹å€¼ä¸º 3</span></span><br><span class="line">semaphore.<span class="built_in">acquire</span>(); <span class="comment">// è®¡æ•°å€¼å‡ 1ï¼Œå˜ä¸º 2</span></span><br><span class="line">semaphore.<span class="built_in">release</span>(); <span class="comment">// è®¡æ•°å€¼å¢åŠ  1ï¼Œå˜ä¸º 3</span></span><br><span class="line">semaphore.<span class="built_in">release</span>(<span class="number">2</span>); <span class="comment">// è®¡æ•°å€¼å¢åŠ  2ï¼Œå˜ä¸º 5</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªåŠ¨æ€æœ€å¤§å€¼çš„è®¡æ•°ä¿¡å·é‡</span></span><br><span class="line">std::counting_semaphore&lt;&gt; <span class="built_in">dynamic_semaphore</span>(<span class="number">2</span>); <span class="comment">// åˆå§‹å€¼ä¸º 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (semaphore.<span class="built_in">try_acquire_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>))) &#123;</span><br><span class="line">    <span class="comment">// æˆåŠŸè·å–ä¿¡å·é‡</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¶…æ—¶æœªè·å–åˆ°ä¿¡å·é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="ğŸ’»ä»£ç ç¤ºä¾‹-2"><a href="#ğŸ’»ä»£ç ç¤ºä¾‹-2" class="headerlink" title="ğŸ’»ä»£ç ç¤ºä¾‹"></a>ğŸ’»ä»£ç ç¤ºä¾‹</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function">std::counting_semaphore&lt;1&gt; <span class="title">sem</span><span class="params">(<span class="number">1</span>)</span></span>;  <span class="comment">//åˆå§‹å€¼ä¸º1çš„è®¡æ•°ä¿¡å·é‡; sem.max()ä¸º1  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker</span><span class="params">(<span class="type">int</span> id)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    sem.<span class="built_in">acquire</span>();  <span class="comment">//Pæ“ä½œï¼Œç­‰å¾…ä¿¡å·é‡å¤§äº0å¹¶å°†å…¶å‡1  </span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;worker &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; is working&quot;</span> &lt;&lt; endl;  </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));    <span class="comment">//æ¨¡æ‹Ÿå·¥ä½œ  </span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;worker &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; is done&quot;</span> &lt;&lt; endl;  </span><br><span class="line">    sem.<span class="built_in">release</span>();  <span class="comment">//Væ“ä½œï¼Œå°†ä¿¡å·é‡åŠ 1  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;max &quot;</span> &lt;&lt; sem.<span class="built_in">max</span>() &lt;&lt; endl;  </span><br><span class="line">    vector&lt;thread&gt; threads;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;  </span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(worker, i);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">for</span> (thread&amp; t : threads) &#123;  </span><br><span class="line">        t.<span class="built_in">join</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š<br></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">max 1</span><br><span class="line">worker 0 is working</span><br><span class="line">worker 0 is done</span><br><span class="line">worker 3 is working</span><br><span class="line">worker 3 is done</span><br><span class="line">worker 4 is working</span><br><span class="line">worker 4 is done</span><br><span class="line">worker 1 is working</span><br><span class="line">worker 1 is done</span><br><span class="line">worker 2 is working</span><br><span class="line">worker 2 is done</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨å¤šä¸ªä¿¡å·é‡ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿¡å·é‡ï¼Œç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œåˆå§‹è®¡æ•°å€¼ä¸º0ï¼Œç”¨äºæ§åˆ¶ work çº¿ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="function">std::counting_semaphore&lt;1&gt; <span class="title">ready</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·é‡ï¼Œç”¨äºçº¿ç¨‹åŒæ­¥ï¼Œåˆå§‹è®¡æ•°å€¼ä¸º1ï¼Œç”¨äºæ§åˆ¶ prepare çº¿ç¨‹çš„æ‰§è¡Œ</span></span><br><span class="line"><span class="function">std::counting_semaphore&lt;1&gt; <span class="title">done</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    done.<span class="built_in">acquire</span>(); <span class="comment">// å‡å°‘ä¿¡å·é‡ done çš„è®¡æ•°å€¼ï¼Œç¡®ä¿ prepare åœ¨ work å®Œæˆä¹‹å‰ä¸å†æ‰§è¡Œ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Preparing...\n&quot;</span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); <span class="comment">// æ¨¡æ‹Ÿå‡†å¤‡å·¥ä½œçš„è€—æ—¶</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Preparation done.\n&quot;</span>;</span><br><span class="line">    ready.<span class="built_in">release</span>(); <span class="comment">// å¢åŠ ä¿¡å·é‡ ready çš„è®¡æ•°å€¼ï¼Œé€šçŸ¥ work çº¿ç¨‹å¯ä»¥å¼€å§‹å·¥ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ready.<span class="built_in">acquire</span>(); <span class="comment">// ç­‰å¾… ready ä¿¡å·é‡ï¼Œç¡®ä¿å‡†å¤‡å·¥ä½œå®Œæˆåå†æ‰§è¡Œ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Working...\n&quot;</span>;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); <span class="comment">// æ¨¡æ‹Ÿå·¥ä½œçš„è€—æ—¶</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Work done.\n&quot;</span>;</span><br><span class="line">    done.<span class="built_in">release</span>(); <span class="comment">// å¢åŠ ä¿¡å·é‡ done çš„è®¡æ•°å€¼ï¼Œé€šçŸ¥ prepare çº¿ç¨‹å¯ä»¥é‡æ–°è¿›å…¥å‡†å¤‡é˜¶æ®µ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(prepare)</span></span>; <span class="comment">// åˆ›å»º prepare çº¿ç¨‹ï¼Œæ‰§è¡Œå‡†å¤‡å·¥ä½œ</span></span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(work)</span></span>; <span class="comment">// åˆ›å»º work çº¿ç¨‹ï¼Œæ‰§è¡Œä¸»è¦å·¥ä½œ</span></span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>(); <span class="comment">// ç­‰å¾… prepare çº¿ç¨‹æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">    t2.<span class="built_in">join</span>(); <span class="comment">// ç­‰å¾… work çº¿ç¨‹æ‰§è¡Œå®Œæˆ</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;All tasks completed.\n&quot;</span>; <span class="comment">// æ‰€æœ‰å·¥ä½œå®Œæˆ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>è¾“å‡ºç»“æœï¼š<br><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Preparing...</span><br><span class="line">Preparation done.</span><br><span class="line">Working...</span><br><span class="line">Work done.</span><br><span class="line">All tasks completed.</span><br></pre></td></tr></table></figure><p></p><h2 id="æ …æ -barrier"><a href="#æ …æ -barrier" class="headerlink" title="æ …æ  barrier"></a>æ …æ  barrier</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-4"><a href="#åŸºæœ¬æ¦‚å¿µ-4" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>ä»€ä¹ˆæ˜¯æ …æ ï¼Ÿ</p></blockquote><p>æ …æ æ˜¯ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºåè°ƒå¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼Œä½¿å¾—å®ƒä»¬èƒ½å¤Ÿ<font color="#00b050">åœ¨æŸä¸ªç‰¹å®šçš„ç‚¹ï¼ˆå³æ …æ ï¼‰ç­‰å¾…</font>ã€‚ç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è¾¾åˆ°è¿™ä¸€ä¸ªç‚¹ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚<br>ä½äº C++20 çš„å¤´æ–‡ä»¶ <code>&lt;barrier&gt;</code> ä¸­ã€‚</p><blockquote><p>æ …æ çš„ä½œç”¨ï¼Ÿ</p></blockquote><p>ç¡®ä¿å¹¶å‘ä»»åŠ¡åœ¨æŸäº›å…³é”®æ—¶åˆ»åŒæ­¥ï¼Œæ¯”å¦‚ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®ŒæˆæŸä¸ªé˜¶æ®µçš„å·¥ä½œï¼Œç„¶åå†è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/kD6MTES.png" alt="|807"><br>ç”¨äºé˜¶æ®µåŒæ­¥å’Œæ‰¹å¤„ç†ã€‚</p><blockquote><p>æ …æ çš„ç‰¹ç‚¹ï¼Ÿ</p></blockquote><ol><li><strong>åŒæ­¥ç‚¹</strong>ï¼šæ …æ ç”¨äºåˆ›å»ºä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»åŒæ­¥ã€‚</li><li><strong>è®¡æ•°å™¨</strong>ï¼šæ …æ å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•åˆ°è¾¾æ …æ çš„çº¿ç¨‹æ•°é‡ã€‚å½“è®¡æ•°å™¨è¾¾åˆ°é¢„è®¾å€¼æ—¶ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹è¢«åŒæ—¶å”¤é†’ã€‚</li><li><strong>å¯é‡ç”¨æ€§</strong>ï¼šC++20 ä¸­çš„ <code>std::barrier</code> æ˜¯å¯é‡ç”¨çš„ï¼Œçº¿ç¨‹å¯ä»¥åå¤ä½¿ç”¨åŒä¸€ä¸ªæ …æ å¯¹è±¡è¿›è¡ŒåŒæ­¥ã€‚</li></ol><h3 id="ğŸ’»ä»£ç å®ç°"><a href="#ğŸ’»ä»£ç å®ç°" class="headerlink" title="ğŸ’»ä»£ç å®ç°"></a>ğŸ’»ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;barrier&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker</span><span class="params">(<span class="type">int</span> id, std::barrier&lt;&gt;&amp; sync_point)</span> <span class="comment">//åŒæ­¥ç‚¹éœ€è¦ä¸ºå¼•ç”¨  </span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Worker &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; is doing phase 1 work.\n&quot;</span>;  </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span> * id));   <span class="comment">//æ¨¡æ‹Ÿä¸åŒçš„å·¥ä½œæ—¶é—´  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åˆ°è¾¾æ …æ ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹  </span></span><br><span class="line">    sync_point.<span class="built_in">arrive_and_wait</span>();  </span><br><span class="line">  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Worker &quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot; has completed phase 1 and is doing phase 2 work.\n&quot;</span>;  </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span> * id));   <span class="comment">//æ¨¡æ‹Ÿä¸åŒçš„å·¥ä½œæ—¶é—´  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> num_threads = <span class="number">5</span>;  </span><br><span class="line">    <span class="function">std::barrier <span class="title">sync_point</span><span class="params">(num_threads)</span></span>;   <span class="comment">//åˆ›å»ºbarrierå¯¹è±¡ï¼Œè®°å½•åŒæ­¥ç‚¹  </span></span><br><span class="line">  </span><br><span class="line">    vector&lt;thread&gt; threads;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= num_threads; ++i) &#123;  </span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(worker, i, std::<span class="built_in">ref</span>(sync_point));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> (thread&amp; t : threads)&#123;  </span><br><span class="line">        t.<span class="built_in">join</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;All tasks completed.\n&quot;</span>; <span class="comment">// æ‰€æœ‰å·¥ä½œå®Œæˆ  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š<br></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Worker Worker 2 is doing phase 1 work.</span><br><span class="line">1 is doing phase 1 work.</span><br><span class="line">Worker 3 is doing phase 1 work.</span><br><span class="line">Worker 4 is doing phase 1 work.</span><br><span class="line">Worker 5 is doing phase 1 work.</span><br><span class="line">Worker Worker 5 has completed phase 1 and is doing phase 2 work.</span><br><span class="line">Worker 1 has completed phase 1 and is doing phase 2 work.</span><br><span class="line">Worker 3 has completed phase 1 and is doing phase 2 work.</span><br><span class="line">4 has completed phase 1 and is doing phase 2 work.</span><br><span class="line">Worker 2 has completed phase 1 and is doing phase 2 work.</span><br><span class="line">All tasks completed.</span><br></pre></td></tr></table></figure><p></p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><blockquote><p>ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ</p></blockquote><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¿›ç¨‹<font color="#00b050">äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æº</font>ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰è¿›ç¨‹æˆ–çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„ç°è±¡ã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/tSbM0ar.png" alt="|647"></p><blockquote><p>æ­»é”çš„å¿…è¦æ¡ä»¶ï¼Ÿ</p></blockquote><ol><li><strong>äº’æ–¥</strong>ï¼šèµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªèµ„æºå ç”¨ã€‚</li><li><strong>è¯·æ±‚å’Œä¿æŒ</strong>ï¼šçº¿ç¨‹å·²ç»æŒæœ‰è‡³å°‘ä¸€ä¸ªèµ„æºï¼ŒåŒæ—¶åˆç”³è¯·æ–°çš„èµ„æºï¼Œè€Œæ–°èµ„æºå·²ç»è¢«å…¶ä»–çº¿ç¨‹å æœ‰ã€‚</li><li><strong>ä¸å‰¥å¤º</strong>ï¼šå·²ç»è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å¼ºè¡Œå‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨å®Œæ¯•åè‡ªå·±é‡Šæ”¾ã€‚</li><li><strong>å¾ªç¯ç­‰å¾…</strong>ï¼šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯çš„é“¾ï¼Œé“¾ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½æŒæœ‰ä¸‹ä¸€ä¸ªçº¿ç¨‹éœ€è¦çš„èµ„æºã€‚<br>è¦æƒ³è§£å†³æ­»é”è¿™ä¸€é—®é¢˜ï¼Œå°±éœ€è¦é¿å¼€ä¸Šé¢å››ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨é«˜çº§åŒæ­¥å·¥å…·ï¼ˆå¦‚ <code>unique_lock</code> ç­‰ï¼‰ã€‚</li></ol><h3 id="ğŸ’»ä»£ç ç¤ºä¾‹-3"><a href="#ğŸ’»ä»£ç ç¤ºä¾‹-3" class="headerlink" title="ğŸ’»ä»£ç ç¤ºä¾‹"></a>ğŸ’»ä»£ç ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“çº¿ç¨‹1 æŒæœ‰ mtx1 å¹¶ç­‰å¾… mtx2 æ—¶ï¼Œçº¿ç¨‹2 æŒæœ‰ mtx2 å¹¶ç­‰å¾… mtx1ã€‚</span></span><br><span class="line"><span class="comment">//ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´æ­»é”</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::mutex mtx1; <span class="comment">// ç¬¬ä¸€ä¸ªäº’æ–¥é”</span></span><br><span class="line">std::mutex mtx2; <span class="comment">// ç¬¬äºŒä¸ªäº’æ–¥é”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1)</span></span>; <span class="comment">// å…ˆé”å®š mtx1</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 1 acquired mtx1\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2)</span></span>; <span class="comment">// å†é”å®š mtx2</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 1 acquired mtx2\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2)</span></span>; <span class="comment">// å…ˆé”å®š mtx2</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 2 acquired mtx2\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1)</span></span>; <span class="comment">// å†é”å®š mtx1</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 2 acquired mtx1\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(thread1)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(thread2)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;All threads completed.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Thread 1 acquired mtx1</span></span><br><span class="line"><span class="comment">//Thread 2 acquired mtx2</span></span><br><span class="line"><span class="comment">//å¯¼è‡´æ­»é”</span></span><br></pre></td></tr></table></figure><ol><li><p>åŒæ—¶é”å®šä¸¤ä¸ªé”</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">lock</span>(mtx1, mtx2); <span class="comment">// åŒæ—¶é”å®š mtx1 å’Œ mtx2</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1, std::adopt_lock)</span></span>;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2, std::adopt_lock)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 1 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::<span class="built_in">lock</span>(mtx1, mtx2); <span class="comment">// åŒæ—¶é”å®š mtx1 å’Œ mtx2</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1, std::adopt_lock)</span></span>;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2, std::adopt_lock)</span></span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 2 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿä¸€é”å®šé¡ºåº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1)</span></span>; <span class="comment">// å…ˆé”å®š mtx1</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2)</span></span>; <span class="comment">// å†é”å®š mtx2</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 1 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1)</span></span>; <span class="comment">// å…ˆé”å®š mtx1</span></span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2)</span></span>; <span class="comment">// å†é”å®š mtx2</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 2 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ <code>std::unique_lock</code> å’Œ <code>std::defer_lock</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1, std::defer_lock)</span></span>;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2, std::defer_lock)</span></span>;</span><br><span class="line">    std::<span class="built_in">lock</span>(lock1, lock2); <span class="comment">// åŒæ—¶é”å®š</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 1 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">thread2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock1</span><span class="params">(mtx1, std::defer_lock)</span></span>;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock2</span><span class="params">(mtx2, std::defer_lock)</span></span>;</span><br><span class="line">    std::<span class="built_in">lock</span>(lock1, lock2); <span class="comment">// åŒæ—¶é”å®š</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Thread 2 acquired both locks\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h1 id="å¼‚æ­¥ç¼–ç¨‹"><a href="#å¼‚æ­¥ç¼–ç¨‹" class="headerlink" title="å¼‚æ­¥ç¼–ç¨‹"></a>å¼‚æ­¥ç¼–ç¨‹</h1><h2 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><blockquote><p>ä»€ä¹ˆæ˜¯å¼‚æ­¥ï¼Ÿ</p></blockquote><p>å…è®¸ç¨‹åºåœ¨ç­‰å¾…æŸäº›æ“ä½œå®Œæˆæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸æ˜¯é˜»å¡æˆ–ç­‰å¾…è¿™äº›æ“ä½œå®Œæˆã€‚</p><blockquote><p>å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜ç‚¹ï¼Ÿä¸ºä»€ä¹ˆé€‰æ‹©å¼‚æ­¥ç¼–ç¨‹ï¼Ÿ</p></blockquote><ul><li><strong>æé«˜æ€§èƒ½</strong>ï¼šé€šè¿‡å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå¼‚æ­¥ç¼–ç¨‹å¯ä»¥æ›´é«˜æ•ˆåœ°åˆ©ç”¨ CPU èµ„æºã€‚</li><li><strong>æé«˜å“åº”é€Ÿåº¦</strong>ï¼šå¼‚æ­¥ç¼–ç¨‹æ—¶ç¨‹åºåœ¨ç­‰å¾…æŸäº›æ“ä½œå®Œæˆæ—¶ç»§ç»­å“åº”ç”¨æˆ·è¾“å…¥ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚</li><li><strong>ç®€åŒ– I/O æ“ä½œ</strong>ï¼šå¼‚æ­¥ç¼–ç¨‹éå¸¸é€‚åˆå¤„ç† I/O å¯†é›†å‹æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚</li></ul><h2 id="ğŸš©async"><a href="#ğŸš©async" class="headerlink" title="ğŸš©async"></a>ğŸš©async</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-5"><a href="#åŸºæœ¬æ¦‚å¿µ-5" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>ä»€ä¹ˆæ˜¯ <code>async</code>ï¼Ÿ</p></blockquote><p><code>async</code> æ˜¯ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ï¼ŒåŒ…å«åœ¨å¤´æ–‡ä»¶ <code>&lt;future&gt;</code> ä¸­ï¼Œç”¨äºå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚<br>å®ƒæ¥å—ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶åœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸Šå¼‚æ­¥æ‰§è¡Œè¯¥å¯¹è±¡ã€‚<br><code>std::async</code> <strong>è‡ªåŠ¨ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>std::future</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºè·å–å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚</p><blockquote><p>ä»€ä¹ˆæ˜¯ <code>future</code>ï¼Ÿ</p></blockquote><p><code>std::future</code> æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äºè¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚<br><code>std::future</code> å¯¹è±¡éœ€è¦å€ŸåŠ© <code>std::async</code>ã€<code>std::promise</code>ã€<code>std::packaged_task</code> ç»“åˆä½¿ç”¨ã€‚</p><h3 id="ğŸ’»ä»£ç å®ç°-1"><a href="#ğŸ’»ä»£ç å®ç°-1" class="headerlink" title="ğŸ’»ä»£ç å®ç°"></a>ğŸ’»ä»£ç å®ç°</h3><p>ğŸš€<code>future</code> çš„åŸºæœ¬æˆå‘˜å‡½æ•°ï¼š</p><div class="table-container"><table><thead><tr><th>æˆå‘˜å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>get()</code></td><td>è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼ã€‚å¦‚æœä»»åŠ¡å°šæœªå®Œæˆï¼Œä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆã€‚</td></tr><tr><td><code>wait()</code></td><td>ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œä½†ä¸è·å–è¿”å›å€¼ã€‚</td></tr><tr><td><code>wait_for()</code></td><td>ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œç›´åˆ°æŒ‡å®šçš„æ—¶é—´ã€‚<br>å¦‚æœä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆï¼Œè¿”å› <code>std::future_status::ready</code>ï¼›<br>å¦‚æœä»»åŠ¡æœªå®Œæˆï¼Œè¿”å› <code>std::future_status::timeout</code>ã€‚</td></tr><tr><td><code>wait_until()</code></td><td>ç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆï¼Œç›´åˆ°æŒ‡å®šçš„æ—¶é—´ç‚¹ã€‚<br>å¦‚æœä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´ç‚¹å‰å®Œæˆï¼Œè¿”å› <code>std::future_status::ready</code>ï¼›<br>å¦‚æœä»»åŠ¡æœªå®Œæˆï¼Œè¿”å› <code>std::future_status::timeout</code>ã€‚</td></tr><tr><td><code>valid()</code></td><td>æ£€æŸ¥ <code>std::future</code> å¯¹è±¡æ˜¯å¦æŒæœ‰æœ‰æ•ˆçš„å¼‚æ­¥ä»»åŠ¡ã€‚<br>å¦‚æœå¯¹è±¡æœ‰æ•ˆï¼Œè¿”å› <code>true</code>ï¼›å¦åˆ™è¿”å› <code>false</code>ã€‚</td></tr><tr><td><code>share()</code></td><td>è¿”å›ä¸€ä¸ª <code>std::shared_future</code> å¯¹è±¡ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹å…±äº«å¼‚æ­¥ä»»åŠ¡çš„ç»“æœã€‚</td></tr></tbody></table></div><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">myfunc</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is myfunc&quot;</span> &lt;&lt; <span class="string">&quot; &quot;</span>;  </span><br><span class="line">    <span class="keyword">return</span> a + b;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="comment">// asyncçš„è¿”å›å¯¹è±¡å¿…é¡»è¦èµ‹å€¼ä½¿ç”¨ï¼Œä¸èƒ½ç›´æ¥async(myfunc, 1, 2);  </span></span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(myfunc, <span class="number">1</span>, <span class="number">2</span>);	<span class="comment">/* ç­‰ä»·äº thread t(myfunc, 1, 2); t.join(); æ‰€ä»¥ä¼šè¾“å‡º&quot;This is my func&quot; */</span>    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;MyFunc == &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot; test&quot;</span> &lt;&lt; endl;  <span class="comment">// MyFunc.get()çš„è¿”å›å€¼ä¸º3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//MyFunc == This is myfunc 3 test	//è¾“å‡ºé¡ºåºä¸å›ºå®šï¼Œä½†testä¸€å®šåœ¨3ä¹‹åè¾“å‡ºï¼Œ3ä¸€å®šåœ¨ä¸¤å¥ä»¥åè¾“å‡º</span></span><br></pre></td></tr></table></figure><p>âœ…æ³¨æ„ï¼š</p><ul><li><code>get()</code> <font color="#00b050">ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ</font>åï¼Œå†è·å–ç»“æœã€‚å¦‚æœå¼‚æ­¥æ“ä½œå°šæœªå®Œæˆï¼Œè°ƒç”¨ <code>get()</code> çš„çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚</li><li>ä¸€æ—¦è°ƒç”¨ <code>get()</code>ï¼Œå®ƒå°†è¿”å›å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¹¶ä¸” <code>future</code> å¯¹è±¡<font color="#00b050">å°†å˜ä¸ºæ— æ•ˆçŠ¶æ€</font>ï¼Œä¸èƒ½å†è°ƒç”¨ <code>get()</code>ã€‚ä¸€ä¸ª <code>future</code> å¯¹è±¡åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>get()</code>ã€‚</li><li><code>wait()</code> ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œä½†ä¸è·å–ç»“æœã€‚ä¸ <code>get()</code> ä¸åŒä¹‹å¤„åœ¨äºï¼Œè°ƒç”¨ <code>wait()</code> åï¼Œ<code>future</code> å¯¹è±¡ä»ç„¶æœ‰æ•ˆï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ <code>get()</code> æ¥è·å–ç»“æœã€‚</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">myfunc</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is myfunc &quot;</span>;  </span><br><span class="line">    <span class="keyword">return</span> a + b;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(myfunc, <span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    MyFunc.<span class="built_in">wait</span>();  <span class="comment">//ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼Œä¹‹åè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;MyFunc == &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot; test&quot;</span> &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//This is myfunc MyFunc == 3 test	//æ­¤æ—¶è¾“å‡ºé¡ºåºå›ºå®š</span></span><br></pre></td></tr></table></figure><h3 id="ä¸‰ç§å¯åŠ¨ç­–ç•¥"><a href="#ä¸‰ç§å¯åŠ¨ç­–ç•¥" class="headerlink" title="ä¸‰ç§å¯åŠ¨ç­–ç•¥"></a>ä¸‰ç§å¯åŠ¨ç­–ç•¥</h3><div class="table-container"><table><thead><tr><th>å¯åŠ¨ç­–ç•¥</th><th>æ˜¯å¦åˆ›å»ºæ–°çº¿ç¨‹</th><th>ä»»åŠ¡æ‰§è¡Œæ—¶æœº</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>std::launch::async</code></td><td>æ˜¯</td><td>ç«‹å³æ‰§è¡Œï¼Œåˆ›å»ºæ–°çº¿ç¨‹</td><td>éœ€è¦å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»»åŠ¡å¯ä»¥ç«‹å³å¼€å§‹æ‰§è¡Œã€‚</td></tr><tr><td><code>std::launch::deferred</code></td><td>å¦</td><td>å»¶è¿Ÿæ‰§è¡Œï¼Œè°ƒç”¨ <code>get()</code> æˆ– <code>wait()</code> æ—¶</td><td>ä¸éœ€è¦ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»»åŠ¡å¯ä»¥åœ¨éœ€è¦æ—¶æ‰æ‰§è¡Œã€‚</td></tr><tr><td>é»˜è®¤</td><td>ç”±å®ç°å†³å®š</td><td>ç”±å®ç°å†³å®š</td><td>ä¸ç¡®å®šä»»åŠ¡æ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œï¼Œç”±å®ç°è‡ªåŠ¨é€‰æ‹©æ‰§è¡Œæ–¹å¼ã€‚</td></tr></tbody></table></div><ol><li><p><code>launch::async</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>   <span class="comment">// this_threadéœ€è¦å¤´æ–‡ä»¶å’Œstdå‘½åç©ºé—´  </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">myfunc</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is myfunc: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> a + b;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(launch::async, myfunc, <span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is main: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is from myfunc: &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//This is main: This is myfunc: 21  </span></span><br><span class="line"><span class="comment">//This is from myfunc:  </span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç­–ç•¥åŸå› ï¼Œå¤šå¥è¯ç«‹å³åŒæ—¶æ‰§è¡Œäº†ï¼Œ<code>async</code> åˆ›å»ºçš„æ–°çº¿ç¨‹å’Œä¸»çº¿ç¨‹åŒæ—¶è¿›è¡Œã€‚<br>åŠ ä¸Š <code>wait()</code> å³å¯è§‚å¯Ÿæ­£ç¡®çš„çº¿ç¨‹ idï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(launch::async, myfunc, <span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    MyFunc.<span class="built_in">wait</span>();  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is main: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is from myfunc: &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//This is myfunc: 2  </span></span><br><span class="line"><span class="comment">//This is main: 1  </span></span><br><span class="line"><span class="comment">//This is from myfunc: 3</span></span><br></pre></td></tr></table></figure></li><li><p><code>launch::deferred</code>ï¼š<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯èƒ½éšè—æ½œåœ¨çš„å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºä»»åŠ¡å¯èƒ½åœ¨æŸ¥è¯¢ç»“æœæ—¶æ‰æ‰§è¡Œã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(launch::deferred, myfunc, <span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is main: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is from myfunc: &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; endl;  <span class="comment">// è°ƒç”¨get()æ–¹æ³•æ—¶æ‰æ‰§è¡Œmyfunc()</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//This is main: 1  </span></span><br><span class="line"><span class="comment">//This is from myfunc: This is myfunc: 1  </span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure><p>åŠ å…¥ <code>wait</code> æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; MyFunc = <span class="built_in">async</span>(launch::deferred, myfunc, <span class="number">1</span>, <span class="number">2</span>);  </span><br><span class="line">    MyFunc.<span class="built_in">wait</span>();  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is main: &quot;</span> &lt;&lt; this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;This is from myfunc: &quot;</span> &lt;&lt; MyFunc.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//This is myfunc: 1  </span></span><br><span class="line"><span class="comment">//This is main: 1  </span></span><br><span class="line"><span class="comment">//This is from myfunc: 3</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œ<code>launch::deferred</code> ç­–ç•¥å¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨ <code>get</code> æ–¹æ³•æ—¶æ‰æ‰§è¡Œ <code>myfunc()</code></p></li></ol><h2 id="ğŸš©promise"><a href="#ğŸš©promise" class="headerlink" title="ğŸš©promise"></a>ğŸš©promise</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-6"><a href="#åŸºæœ¬æ¦‚å¿µ-6" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>promise æ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><p><code>std::promise</code> æ˜¯ä¸€ä¸ªç”¨äºè®¾ç½®å¼‚æ­¥æ“ä½œç»“æœçš„æœºåˆ¶ã€‚å®ƒå…è®¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­<font color="#00b050">è®¾ç½®å€¼æˆ–å¼‚å¸¸</font>ï¼Œç„¶ååœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­é€šè¿‡ <code>std::future</code> å¯¹è±¡æ£€ç´¢è¿™äº›å€¼æˆ–å¼‚å¸¸ã€‚<br>é€šå¸¸ä¸ <code>std::async</code>ã€<code>std::packaged_task</code> æˆ– <code>std::thread</code> ç»“åˆä½¿ç”¨ã€‚éœ€è¦å¤´æ–‡ä»¶ <code>&lt;future&gt;</code>ã€‚</p><p>ä¸€ä¸ª promise å¯¹è±¡å¯ä»¥åˆ›å»ºå¤šä¸ª future å¯¹è±¡ã€‚<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/Srt7GAa.png" alt="|607"></p><h3 id="ğŸ’»ä»£ç å®ç°-2"><a href="#ğŸ’»ä»£ç å®ç°-2" class="headerlink" title="ğŸ’»ä»£ç å®ç°"></a>ğŸ’»ä»£ç å®ç°</h3><p>è®¾ç½®å€¼ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AsyncTask</span><span class="params">(promise&lt;<span class="type">int</span>&gt; prom)</span> </span>&#123;  </span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));  </span><br><span class="line">    prom.<span class="built_in">set_value</span>(<span class="number">3</span>);  <span class="comment">// è®¾ç½®å¼‚æ­¥æ“ä½œçš„ç»“æœ  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;  </span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; FutureObj = prom.<span class="built_in">get_future</span>(); <span class="comment">//è·å–ä¸promiseå…³è”çš„futureã€‚&lt;int&gt;æŒ‡prom.set_valueçš„å‚æ•°ç±»å‹</span></span><br><span class="line">  </span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(AsyncTask, std::move(prom))</span></span>;  <span class="comment">//å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä¼ é€’å‚æ•°promise  </span></span><br><span class="line">  </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;The result is: &quot;</span> &lt;&lt; FutureObj.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">  </span><br><span class="line">    t.<span class="built_in">join</span>();   <span class="comment">//ç­‰å¾…çº¿ç¨‹ç»“æŸã€‚å¿…é¡»åŠ ä¸Š  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//The result is: 3</span></span><br></pre></td></tr></table></figure><br><code>promise</code> æ¯” <code>async</code> æ›´åŠ çµæ´»ï¼Œæ‹¥æœ‰æ›´å¤šåŠŸèƒ½ã€‚<p></p><div class="table-container"><table><thead><tr><th>æˆå‘˜å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>get_future()</code></td><td>è·å–ä¸ <code>std::promise</code> å…³è”çš„ <code>std::future</code> å¯¹è±¡ã€‚</td></tr><tr><td><code>set_value()</code></td><td>è®¾ç½® <code>std::promise</code> çš„å€¼ã€‚</td></tr><tr><td><code>set_exception()</code></td><td>è®¾ç½® <code>std::promise</code> çš„å¼‚å¸¸ã€‚</td></tr><tr><td><code>set_value_at_thread_exit()</code></td><td>åœ¨çº¿ç¨‹é€€å‡ºæ—¶è®¾ç½®å€¼ã€‚</td></tr><tr><td><code>set_exception_at_thread_exit()</code></td><td>åœ¨çº¿ç¨‹é€€å‡ºæ—¶è®¾ç½®å¼‚å¸¸ã€‚</td></tr></tbody></table></div><p>å¤„ç†å¼‚å¸¸ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">producer</span><span class="params">(std::promise&lt;<span class="type">int</span>&gt;&amp; promise)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;An error occurred!&quot;</span>);  </span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;  </span><br><span class="line">        promise.<span class="built_in">set_exception</span>(std::<span class="built_in">current_exception</span>()); <span class="comment">// è®¾ç½®å¼‚å¸¸  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">consumer</span><span class="params">(std::future&lt;<span class="type">int</span>&gt;&amp; future)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">int</span> value = future.<span class="built_in">get</span>(); <span class="comment">// è·å–å€¼ï¼Œæ­¤æ—¶ä¼šæ•è·åˆ°æŠ›å‡ºçš„å¼‚å¸¸ </span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Received value: &quot;</span> &lt;&lt; value &lt;&lt; std::endl;  </span><br><span class="line">    &#125; <span class="built_in">catch</span> (<span class="type">const</span> std::exception&amp; e) &#123;  </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Exception caught: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; promise;  </span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; future = promise.<span class="built_in">get_future</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="function">std::thread <span class="title">producer_thread</span><span class="params">(producer, std::ref(promise))</span></span>;  </span><br><span class="line">    <span class="function">std::thread <span class="title">consumer_thread</span><span class="params">(consumer, std::ref(future))</span></span>;  </span><br><span class="line">  </span><br><span class="line">    producer_thread.<span class="built_in">join</span>();  </span><br><span class="line">    consumer_thread.<span class="built_in">join</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//Exception caught: An error occurred!</span></span><br></pre></td></tr></table></figure><p></p><h3 id="æ³¨æ„äº‹é¡¹-1"><a href="#æ³¨æ„äº‹é¡¹-1" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ol><li><strong>åªèƒ½è®¾ç½®ä¸€æ¬¡å€¼æˆ–å¼‚å¸¸</strong>ï¼š<code>std::promise</code> åªèƒ½è®¾ç½®ä¸€æ¬¡å€¼æˆ–å¼‚å¸¸ã€‚å¦‚æœå¤šæ¬¡è°ƒç”¨ <code>set_value()</code> æˆ– <code>set_exception()</code>ï¼Œä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li><li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼š<code>std::promise</code> å’Œ <code>std::future</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†éœ€è¦ç¡®ä¿åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨ <code>set_value()</code> å’Œ <code>get()</code>ã€‚</li><li><strong>ä¸èƒ½è¢«ç›´æ¥å¤åˆ¶</strong>ï¼š<code>std::promise</code> å¯¹è±¡<font color="#00b050">ä¸èƒ½è¢«å¤åˆ¶</font>ï¼Œåªèƒ½é€šè¿‡ <code>std::move</code> è½¬ç§»æ§åˆ¶æƒã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">std::promise&lt;<span class="type">int</span>&gt; promise;</span><br><span class="line">std::promise&lt;<span class="type">int</span>&gt; promise2 = std::<span class="built_in">move</span>(promise);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyFunc</span><span class="params">(promise&lt;<span class="type">int</span>&gt; prom)</span> </span>&#123;</span><br><span class="line">	prom.<span class="built_in">set_exception</span>(std::<span class="built_in">current_exception</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::thread <span class="title">t</span><span class="params">(MyFunc, std::move(promise))</span></span>;	<span class="comment">//å€¼ä¼ é€’</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MyFunc</span><span class="params">(promise&lt;<span class="type">int</span>&gt;&amp; prom)</span> </span>&#123;	<span class="comment">//ä¸å¯ä»¥ä¸ºconstï¼Œå› ä¸ºset_exception()</span></span><br><span class="line">	prom.<span class="built_in">set_exception</span>(std::<span class="built_in">current_exception</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::thread <span class="title">t</span><span class="params">(MyFunc, std::ref(promise))</span></span>;	<span class="comment">//å¼•ç”¨ä¼ é€’</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="ğŸš©packaged-task"><a href="#ğŸš©packaged-task" class="headerlink" title="ğŸš©packaged_task"></a>ğŸš©packaged_task</h2><h3 id="åŸºæœ¬æ¦‚å¿µ-7"><a href="#åŸºæœ¬æ¦‚å¿µ-7" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><blockquote><p>ä»€ä¹ˆæ˜¯ <code>packaged_task</code>ï¼Ÿ</p></blockquote><p><code>packaged_task</code> æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äº<font color="#00b050">å°è£…å¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶å°†ä»»åŠ¡çš„æ‰§è¡Œä¸ç»“æœçš„è·å–åˆ†ç¦»</font>ã€‚åŒæ ·éœ€è¦å¤´æ–‡ä»¶ <code>&lt;future&gt;</code>ã€‚</p><h3 id="ğŸ’»ä»£ç å®ç°-3"><a href="#ğŸ’»ä»£ç å®ç°-3" class="headerlink" title="ğŸ’»ä»£ç å®ç°"></a>ğŸ’»ä»£ç å®ç°</h3><p>åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">([](<span class="type">int</span> a, <span class="type">int</span> b) &#123; <span class="keyword">return</span> a + b; &#125;)</span></span>;  </span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; result = task.<span class="built_in">get_future</span>();  </span><br><span class="line">      </span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(std::move(task), <span class="number">1</span>, <span class="number">2</span>)</span></span>;   <span class="comment">//packaged_taskåŒæ ·ä¸å¯ä»¥å¤åˆ¶  </span></span><br><span class="line">    t.<span class="built_in">join</span>();  </span><br><span class="line">      </span><br><span class="line">    cout &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦ä¸€ç§æ„é€ å†™æ³•ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Multiply</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="function">std::packaged_task&lt;<span class="title">decltype</span><span class="params">(Multiply)</span>&gt; <span class="title">task</span><span class="params">(Multiply)</span></span>;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡ç½®å¯¹è±¡ï¼Œè·å–æ–°çš„ <code>future</code> å¯¹è±¡ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">([](<span class="type">int</span> a, <span class="type">int</span> b) &#123; <span class="keyword">return</span> a + b; &#125;)</span></span>;  </span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; result = task.<span class="built_in">get_future</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">task</span>(<span class="number">1</span>, <span class="number">2</span>); <span class="comment">//æ‰§è¡Œä»»åŠ¡  </span></span><br><span class="line">    cout &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">  </span><br><span class="line">    task.<span class="built_in">reset</span>();   <span class="comment">//é‡ç½®packaged_taskï¼Œå› ä¸ºå…¶åªèƒ½æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡</span></span><br><span class="line">    result = task.<span class="built_in">get_future</span>(); <span class="comment">//å¿…é¡»è·å–æ–°çš„futureå¯¹è±¡ï¼Œå› ä¸ºæ¯ä¸ªfutureå¯¹è±¡åœ¨è°ƒç”¨getæ–¹æ³•åä¼šå¤±æ•ˆ  </span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">task</span>(<span class="number">3</span>, <span class="number">4</span>);  </span><br><span class="line">    cout &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; endl;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//3  </span></span><br><span class="line"><span class="comment">//7</span></span><br></pre></td></tr></table></figure><p></p><div class="table-container"><table><thead><tr><th>æˆå‘˜å‡½æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>get_future()</code></td><td>è·å–ä¸ <code>std::packaged_task</code> å…³è”çš„ <code>std::future</code> å¯¹è±¡ã€‚</td></tr><tr><td><code>operator()</code></td><td>æ‰§è¡Œå°è£…çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>std::future</code> ä¸­ã€‚</td></tr><tr><td><code>make_ready_at_thread_exit()</code></td><td>åœ¨çº¿ç¨‹é€€å‡ºæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>std::future</code> ä¸­ã€‚</td></tr><tr><td><code>reset()</code></td><td>é‡ç½® <code>std::packaged_task</code>ï¼Œå…è®¸é‡æ–°æ‰§è¡Œä»»åŠ¡ã€‚</td></tr></tbody></table></div><h3 id="æ³¨æ„äº‹é¡¹-2"><a href="#æ³¨æ„äº‹é¡¹-2" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ol><li><code>std::packaged_task</code> ä½¿ç”¨ <code>operator()</code> æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>std::future</code> ä¸­ã€‚</li><li><strong>ä¸å¯å¤åˆ¶</strong>ï¼š <code>packaged_task</code> å¯ç§»åŠ¨ï¼Œä½†ä¸å¯å¤åˆ¶ã€‚å› æ­¤ï¼Œæ„å»º <code>thread</code> ä¸­å€¼ä¼ é€’ <code>std::packaged_task</code> æ—¶éœ€è¦ä½¿ç”¨ <code>std::move</code>ï¼ˆå¼•ç”¨ä¼ é€’ç”¨ <code>std::ref</code>ï¼‰ã€‚</li><li><strong>åªèƒ½æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡</strong>ï¼š<code>std::packaged_task</code> åªèƒ½æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚å¦‚æœéœ€è¦é‡æ–°æ‰§è¡Œä»»åŠ¡ï¼Œåº”ä½¿ç”¨ <code>reset()</code> é‡ç½® <code>std::packaged_task</code>ã€‚</li><li><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼š<code>std::packaged_task</code> å’Œ <code>std::future</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†éœ€è¦ç¡®ä¿åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨ <code>get_future()</code> å’Œ <code>get()</code>ã€‚</li></ol><h2 id="ä¸‰ç§å¼‚æ­¥å·¥å…·çš„æ¯”è¾ƒ"><a href="#ä¸‰ç§å¼‚æ­¥å·¥å…·çš„æ¯”è¾ƒ" class="headerlink" title="ä¸‰ç§å¼‚æ­¥å·¥å…·çš„æ¯”è¾ƒ"></a>ä¸‰ç§å¼‚æ­¥å·¥å…·çš„æ¯”è¾ƒ</h2><div class="table-container"><table><thead><tr><th>ç‰¹æ€§</th><th>async</th><th>promise</th><th>packaged_task</th></tr></thead><tbody><tr><td>ä»£ç å†™æ³•</td><td>ç®€å•ï¼Œè‡ªåŠ¨ç®¡ç†çº¿ç¨‹å’Œä»»åŠ¡æ‰§è¡Œ</td><td>å¤æ‚ï¼Œæ‰‹åŠ¨ç®¡ç†çº¿ç¨‹å’Œä»»åŠ¡æ‰§è¡Œ</td><td>å¤æ‚ï¼Œæ‰‹åŠ¨ç®¡ç†çº¿ç¨‹å’Œä»»åŠ¡æ‰§è¡Œ</td></tr><tr><td>æˆå‘˜å‡½æ•°</td><td>è‡ªåŠ¨è®¾ç½®å€¼æˆ–å¼‚å¸¸</td><td><code>get_future()</code>ã€<code>set_value()</code>ã€<code>set_exception()</code></td><td><code>get_future()</code>ã€<code>operator()</code>ã€<code>reset()</code></td></tr><tr><td>åº”ç”¨åœºæ™¯</td><td>ç®€å•å¼‚æ­¥ä»»åŠ¡</td><td>å¤æ‚çº¿ç¨‹é—´é€šä¿¡ï¼Œçµæ´»æ€§æœ€é«˜</td><td>ä»»åŠ¡è°ƒåº¦ã€çº¿ç¨‹æ± ã€å°è£…å¯è°ƒç”¨å¯¹è±¡</td></tr></tbody></table></div><p>å…±åŒç‚¹æ˜¯ï¼Œå®ƒä»¬å‡ä¸º C++11 æ–°ç‰¹æ€§ï¼ŒåŒ…å«åœ¨å¤´æ–‡ä»¶ <code>&lt;future&gt;</code> ä¸­ï¼Œå¹¶ä¸”éƒ½éœ€è¦æ­é… <code>future</code> å¯¹è±¡å®ç°åŠŸèƒ½ã€‚</p><h4 id="ä¹‹é—´çš„å…³ç³»"><a href="#ä¹‹é—´çš„å…³ç³»" class="headerlink" title="ä¹‹é—´çš„å…³ç³»"></a>ä¹‹é—´çš„å…³ç³»</h4><p>ä»¥ä¸‹å†…å®¹æ‘˜è‡ª <a target="_blank" rel="noopener" href="https://www.51cto.com/article/713316.html">Threadã€Futureã€Promiseã€Packaged_taskã€Asyncä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</a><br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/aljI5fH.png" alt="|852"></p><ul><li><code>packaged_task</code> â‰ˆ <code>promise</code> + function</li><li><code>async</code> â‰ˆ <code>thread</code> + <code>packaged_task</code></li><li>é€šè¿‡ <code>promise</code> çš„ <code>get_future()</code> å¯æ‹¿åˆ° <code>future</code> å¯¹è±¡</li><li>é€šè¿‡ <code>future</code> å¯¹è±¡çš„ <code>share()</code> å¯æ‹¿åˆ° <code>shared_future</code> å¯¹è±¡</li></ul><p><code>promise</code> åªèƒ½ <code>set_value</code>ï¼Œä¸å¤ªå¥½æ‰§è¡Œå¤æ‚çš„é€»è¾‘ï¼Œæœ‰æ‰§è¡Œå‡½æ•°+é˜»å¡çš„éœ€æ±‚æ—¶ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>packaged_task</code>ã€‚</p><p><code>shared_future</code>ï¼š<br>æ™®é€šçš„ <code>future</code> æœ‰ä¸ªç‰¹ç‚¹ï¼Œå®ƒä¸èƒ½æ‹·è´ï¼Œåªèƒ½ç§»åŠ¨ï¼Œè¿™å°±æ„å‘³ç€åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªå®ä¾‹å¯ä»¥é€šè¿‡ <code>get()</code> æ‹¿åˆ°å¯¹åº”çš„ç»“æœã€‚<br>å¦‚æœæƒ³è¦å¤šä¸ªçº¿ç¨‹å¤šä¸ªå®ä¾‹æ‹¿åˆ°ç»“æœï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>shared_future</code>ï¼Œé‚£æ€ä¹ˆæ‹¿åˆ° <code>shared_future</code>ï¼Œå¯ä»¥é€šè¿‡æ™®é€š <code>future</code> çš„ <code>shared()</code> æ–¹æ³•ã€‚<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;  </span><br><span class="line">    future&lt;<span class="type">int</span>&gt; fu = prom.<span class="built_in">get_future</span>();  </span><br><span class="line">    shared_future&lt;<span class="type">int</span>&gt; shared_fu = fu.<span class="built_in">share</span>();  </span><br><span class="line">    future&lt;<span class="type">void</span>&gt; f1 = std::<span class="built_in">async</span>(std::launch::async, [shared_fu]() &#123; std::cout &lt;&lt; shared_fu.<span class="built_in">get</span>() &lt;&lt; std::endl; &#125;);  </span><br><span class="line">    future&lt;<span class="type">void</span>&gt; f2 = std::<span class="built_in">async</span>(std::launch::async, [shared_fu]() &#123; std::cout &lt;&lt; shared_fu.<span class="built_in">get</span>() &lt;&lt; std::endl; &#125;);  </span><br><span class="line">    prom.<span class="built_in">set_value</span>(<span class="number">102</span>);  </span><br><span class="line">    f1.<span class="built_in">get</span>();  </span><br><span class="line">    f2.<span class="built_in">get</span>();  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//102102	//è¿™é‡Œçš„è¾“å‡ºé¡ºåºæ— æ³•ç¡®å®šï¼ˆæ¯•ç«Ÿå› ä¸ºå¼‚æ­¥ï¼‰</span></span><br></pre></td></tr></table></figure><p></p><hr><h1 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h1><h2 id="åŸºæœ¬æ¦‚å¿µ-8"><a href="#åŸºæœ¬æ¦‚å¿µ-8" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><blockquote><p>ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Ÿä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><p>çº¿ç¨‹æ± æ˜¯æŒ‡ä¸€ç§<font color="#00b050">é¢„å…ˆåˆ›å»ºä¸€ç»„çº¿ç¨‹</font>çš„æœºåˆ¶ï¼Œè¿™äº›çº¿ç¨‹åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å°±å·²ç»åˆ›å»ºå¥½ï¼Œç­‰å¾…æ‰§è¡Œä»»åŠ¡ã€‚<br>æ¯å½“æœ‰æ–°çš„ä»»åŠ¡éœ€è¦æ‰§è¡Œæ—¶ï¼Œçº¿ç¨‹æ± ä¼šä»çº¿ç¨‹é›†åˆä¸­åˆ†é…ä¸€ä¸ªç©ºé—²çº¿ç¨‹æ¥æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ã€‚ï¼ˆæ± åŒ–æ€æƒ³ï¼Œå¦‚ epollã€SQLï¼‰</p><blockquote><p>ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</p></blockquote><ol><li><strong>æé«˜æ€§èƒ½</strong>ï¼š<font color="#00b050">åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¼€é”€è¾ƒå¤§</font>ï¼Œçº¿ç¨‹æ± é€šè¿‡é‡ç”¨çš„çº¿ç¨‹ï¼Œå‡å°‘äº†è¿™ç§å¼€é”€ï¼Œæé«˜ç¨‹åºæ€§èƒ½ã€‚</li><li><strong>æ§åˆ¶å¹¶å‘é‡</strong>ï¼šçº¿ç¨‹æ± å…è®¸<font color="#00b050">é™åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡</font>ï¼Œé˜²æ­¢ç³»ç»Ÿå› åˆ›å»ºè¿‡å¤šçº¿ç¨‹è€Œå‡ºç°èµ„æºè€—å°½çš„é—®é¢˜ï¼ˆå¦‚ CPU è¿‡è½½ã€å†…å­˜ä¸è¶³ï¼‰ã€‚</li><li><strong>ç®€åŒ–çº¿ç¨‹ç®¡ç†</strong>ï¼šä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥<font color="#00b050">é¿å…æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</font>ï¼Œå‡å°‘ä»£ç å¤æ‚æ€§ã€‚çº¿ç¨‹æ± é€šå¸¸è¿˜æä¾›äº†<font color="#00b050">ä»»åŠ¡æ’é˜Ÿå’Œè°ƒåº¦</font>çš„åŠŸèƒ½ï¼Œä½¿å¾—å¤šçº¿ç¨‹ç¼–ç¨‹æ›´åŠ å®¹æ˜“ã€‚</li></ol><blockquote><p>çº¿ç¨‹æ± çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</p></blockquote><ol><li><strong>æœåŠ¡å™¨åº”ç”¨</strong>ï¼šæ¯”å¦‚ Web æœåŠ¡å™¨ï¼Œå¤„ç†æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ—¶ä¸å¿…ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œè€Œæ˜¯ä»çº¿ç¨‹æ± ä¸­å–å‡ºçº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚</li><li><strong>é«˜æ€§èƒ½è®¡ç®—</strong></li><li><strong>å¼‚æ­¥ä»»åŠ¡å¤„ç†</strong></li></ol><blockquote><p>ä¸€ä¸ªçº¿ç¨‹æ± åº”è¯¥åŒ…å«ä»€ä¹ˆï¼Ÿ</p></blockquote><ol><li><strong>çº¿ç¨‹æ± ç®¡ç†å™¨ï¼ˆThreadPool Managerï¼‰</strong>ï¼šè´Ÿè´£åˆ›å»ºå¹¶ç®¡ç†çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯ã€ä»»åŠ¡åˆ†é…ç­‰ã€‚</li><li><strong>å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰</strong>ï¼šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œè´Ÿè´£æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡ã€‚è¿™äº›çº¿ç¨‹é€šå¸¸æ˜¯é¢„å…ˆåˆ›å»ºå¥½çš„ï¼Œå¹¶ä¸”åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯è¿”å›åˆ°çº¿ç¨‹æ± ä¸­ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li><li><strong>ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰</strong>ï¼šç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚å½“æœ‰æ–°çš„ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± æ—¶ï¼Œä»»åŠ¡ä¼šè¢«æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œã€‚</li><li><strong>ä»»åŠ¡ï¼ˆTaskï¼‰</strong>ï¼šéœ€è¦æ‰§è¡Œçš„å·¥ä½œå•å…ƒï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–æ–¹æ³•ã€‚<br>å›¾ä¾‹ï¼š<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.imgur.com/w5pFYyP.png" alt="|954"></li></ol><h2 id="ğŸ’»ä»£ç å®ç°-4"><a href="#ğŸ’»ä»£ç å®ç°-4" class="headerlink" title="ğŸ’»ä»£ç å®ç°"></a>ğŸ’»ä»£ç å®ç°</h2><p>æ¥è‡ª <a target="_blank" rel="noopener" href="https://github.com/lzpong/threadpool?tab=readme-ov-file">threadpool-lzpong</a></p><p><code>threadpool.h</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> THREAD_POOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREAD_POOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;condition_variable&gt;</span></span><br><span class="line"><span class="comment">//#include &lt;thread&gt;</span></span><br><span class="line"><span class="comment">//#include &lt;functional&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> std</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//çº¿ç¨‹æ± æœ€å¤§å®¹é‡,åº”å°½é‡è®¾å°ä¸€ç‚¹</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  THREADPOOL_MAX_NUM 16</span></span><br><span class="line"><span class="comment">//çº¿ç¨‹æ± æ˜¯å¦å¯ä»¥è‡ªåŠ¨å¢é•¿(å¦‚æœéœ€è¦,ä¸”ä¸è¶…è¿‡ THREADPOOL_MAX_NUM)</span></span><br><span class="line"><span class="comment">//#define  THREADPOOL_AUTO_GROW</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//çº¿ç¨‹æ± ,å¯ä»¥æäº¤å˜å‚å‡½æ•°æˆ–Lambda\è¡¨è¾¾å¼çš„åŒ¿åå‡½æ•°æ‰§è¡Œ,å¯ä»¥è·å–æ‰§è¡Œè¿”å›å€¼</span></span><br><span class="line"><span class="comment">//ä¸ç›´æ¥æ”¯æŒç±»æˆå‘˜å‡½æ•°, æ”¯æŒç±»é™æ€æˆå‘˜å‡½æ•°æˆ–å…¨å±€å‡½æ•°,Operator()å‡½æ•°ç­‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadpool</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> _initSize;       <span class="comment">//åˆå§‹åŒ–çº¿ç¨‹æ•°é‡</span></span><br><span class="line">	<span class="keyword">using</span> Task = function&lt;<span class="built_in">void</span>()&gt;; <span class="comment">//å®šä¹‰ç±»å‹</span></span><br><span class="line">	vector&lt;thread&gt; _pool;          <span class="comment">//çº¿ç¨‹æ± </span></span><br><span class="line">	queue&lt;Task&gt; _tasks;            <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">	mutex _lock;                   <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—åŒæ­¥é”</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line">	mutex _lockGrow;               <span class="comment">//çº¿ç¨‹æ± å¢é•¿åŒæ­¥é”</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">	condition_variable _task_cv;   <span class="comment">//æ¡ä»¶é˜»å¡</span></span><br><span class="line">	atomic&lt;<span class="type">bool</span>&gt; _run&#123; <span class="literal">true</span> &#125;;     <span class="comment">//çº¿ç¨‹æ± æ˜¯å¦æ‰§è¡Œ</span></span><br><span class="line">	atomic&lt;<span class="type">int</span>&gt;  _idlThrNum&#123; <span class="number">0</span> &#125;;  <span class="comment">//ç©ºé—²çº¿ç¨‹æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">inline</span> <span class="title">threadpool</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> size = <span class="number">4</span>)</span> </span>&#123; _initSize = size; <span class="built_in">addThread</span>(size); &#125;</span><br><span class="line">	<span class="keyword">inline</span> ~<span class="built_in">threadpool</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		_run=<span class="literal">false</span>;</span><br><span class="line">		_task_cv.<span class="built_in">notify_all</span>(); <span class="comment">// å”¤é†’æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">		<span class="keyword">for</span> (thread&amp; thread : _pool) &#123;</span><br><span class="line">			<span class="comment">//thread.detach(); // è®©çº¿ç¨‹â€œè‡ªç”Ÿè‡ªç­â€</span></span><br><span class="line">			<span class="keyword">if</span> (thread.<span class="built_in">joinable</span>())</span><br><span class="line">				thread.<span class="built_in">join</span>(); <span class="comment">// ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œ å‰æï¼šçº¿ç¨‹ä¸€å®šä¼šæ‰§è¡Œå®Œ</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// æäº¤ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">	<span class="comment">// è°ƒç”¨.get()è·å–è¿”å›å€¼ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œ,è·å–è¿”å›å€¼</span></span><br><span class="line">	<span class="comment">// æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°è°ƒç”¨ç±»æˆå‘˜ï¼Œ</span></span><br><span class="line">	<span class="comment">// ä¸€ç§æ˜¯ä½¿ç”¨   bindï¼š .commit(std::bind(&amp;Dog::sayHello, &amp;dog));</span></span><br><span class="line">	<span class="comment">// ä¸€ç§æ˜¯ç”¨   mem_fnï¼š .commit(std::mem_fn(&amp;Dog::sayHello), this)</span></span><br><span class="line">	<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span> F, <span class="keyword">class</span>... Args&gt;</span></span><br><span class="line"><span class="function">	<span class="keyword">auto</span> <span class="title">commit</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; future&lt;<span class="title">decltype</span><span class="params">(f(args...))</span>&gt;</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!_run)    <span class="comment">// stoped ??</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;commit on ThreadPool is stopped.&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">using</span> RetType = <span class="keyword">decltype</span>(<span class="built_in">f</span>(args...)); <span class="comment">// typename std::result_of&lt;F(Args...)&gt;::type, å‡½æ•° f çš„è¿”å›å€¼ç±»å‹</span></span><br><span class="line">		<span class="keyword">auto</span> task = make_shared&lt;packaged_task&lt;<span class="built_in">RetType</span>()&gt;&gt;(</span><br><span class="line">			<span class="built_in">bind</span>(forward&lt;F&gt;(f), forward&lt;Args&gt;(args)...)</span><br><span class="line">		); <span class="comment">// æŠŠå‡½æ•°å…¥å£åŠå‚æ•°,æ‰“åŒ…(ç»‘å®š)</span></span><br><span class="line">		future&lt;RetType&gt; future = task-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">		&#123;    <span class="comment">// æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—</span></span><br><span class="line">			lock_guard&lt;mutex&gt; lock&#123; _lock &#125;;<span class="comment">//å¯¹å½“å‰å—çš„è¯­å¥åŠ é”  lock_guard æ˜¯ mutex çš„ stack å°è£…ç±»ï¼Œæ„é€ çš„æ—¶å€™ lock()ï¼Œææ„çš„æ—¶å€™ unlock()</span></span><br><span class="line">			_tasks.<span class="built_in">emplace</span>([task]() &#123; <span class="comment">// push(Task&#123;...&#125;) æ”¾åˆ°é˜Ÿåˆ—åé¢</span></span><br><span class="line">				(*task)();</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line">		<span class="keyword">if</span> (_idlThrNum &lt; <span class="number">1</span> &amp;&amp; _pool.<span class="built_in">size</span>() &lt; THREADPOOL_MAX_NUM)</span><br><span class="line">			<span class="built_in">addThread</span>(<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">		_task_cv.<span class="built_in">notify_one</span>(); <span class="comment">// å”¤é†’ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> future;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// æäº¤ä¸€ä¸ªæ— å‚ä»»åŠ¡, ä¸”æ— è¿”å›å€¼</span></span><br><span class="line">	<span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">F</span>&gt;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">commit2</span><span class="params">(F&amp;&amp; task)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!_run) <span class="keyword">return</span>;</span><br><span class="line">		&#123;</span><br><span class="line">			lock_guard&lt;mutex&gt; lock&#123; _lock &#125;;</span><br><span class="line">			_tasks.<span class="built_in">emplace</span>(std::forward&lt;F&gt;(task));</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line">		<span class="keyword">if</span> (_idlThrNum &lt; <span class="number">1</span> &amp;&amp; _pool.<span class="built_in">size</span>() &lt; THREADPOOL_MAX_NUM)</span><br><span class="line">			<span class="built_in">addThread</span>(<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">		_task_cv.<span class="built_in">notify_one</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//ç©ºé—²çº¿ç¨‹æ•°é‡</span></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">idlCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _idlThrNum; &#125;</span><br><span class="line">	<span class="comment">//çº¿ç¨‹æ•°é‡</span></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">thrCount</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> _pool.<span class="built_in">size</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">	<span class="comment">//æ·»åŠ æŒ‡å®šæ•°é‡çš„çº¿ç¨‹</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">addThread</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> size)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line">		<span class="keyword">if</span> (!_run)    <span class="comment">// stoped ??</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;Grow on ThreadPool is stopped.&quot;</span>);</span><br><span class="line">		unique_lock&lt;mutex&gt; lockGrow&#123; _lockGrow &#125;; <span class="comment">//è‡ªåŠ¨å¢é•¿é”</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">		<span class="keyword">for</span> (; _pool.<span class="built_in">size</span>() &lt; THREADPOOL_MAX_NUM &amp;&amp; size &gt; <span class="number">0</span>; --size)</span><br><span class="line">		&#123;   <span class="comment">//å¢åŠ çº¿ç¨‹æ•°é‡,ä½†ä¸è¶…è¿‡ é¢„å®šä¹‰æ•°é‡ THREADPOOL_MAX_NUM</span></span><br><span class="line">			_pool.<span class="built_in">emplace_back</span>( [<span class="keyword">this</span>]&#123; <span class="comment">//å·¥ä½œçº¿ç¨‹å‡½æ•°</span></span><br><span class="line">				<span class="keyword">while</span> (<span class="literal">true</span>) <span class="comment">//é˜²æ­¢ _run==false æ—¶ç«‹å³ç»“æŸ,æ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—å¯èƒ½ä¸ä¸ºç©º</span></span><br><span class="line">				&#123;</span><br><span class="line">					Task task; <span class="comment">// è·å–ä¸€ä¸ªå¾…æ‰§è¡Œçš„ task</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">// unique_lock ç›¸æ¯” lock_guard çš„å¥½å¤„æ˜¯ï¼šå¯ä»¥éšæ—¶ unlock() å’Œ lock()</span></span><br><span class="line">						unique_lock&lt;mutex&gt; lock&#123; _lock &#125;;</span><br><span class="line">						_task_cv.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>] &#123; <span class="comment">// wait ç›´åˆ°æœ‰ task, æˆ–éœ€è¦åœæ­¢</span></span><br><span class="line">							<span class="keyword">return</span> !_run || !_tasks.<span class="built_in">empty</span>();</span><br><span class="line">						&#125;);</span><br><span class="line">						<span class="keyword">if</span> (!_run &amp;&amp; _tasks.<span class="built_in">empty</span>())</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						_idlThrNum--;</span><br><span class="line">						task = <span class="built_in">move</span>(_tasks.<span class="built_in">front</span>()); <span class="comment">// æŒ‰å…ˆè¿›å…ˆå‡ºä»é˜Ÿåˆ—å–ä¸€ä¸ª task</span></span><br><span class="line">						_tasks.<span class="built_in">pop</span>();</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="built_in">task</span>();<span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> THREADPOOL_AUTO_GROW</span></span><br><span class="line">					<span class="keyword">if</span> (_idlThrNum&gt;<span class="number">0</span> &amp;&amp; _pool.<span class="built_in">size</span>() &gt; _initSize) <span class="comment">//æ”¯æŒè‡ªåŠ¨é‡Šæ”¾ç©ºé—²çº¿ç¨‹,é¿å…å³°å€¼è¿‡åå¤§é‡ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">						<span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !THREADPOOL_AUTO_GROW</span></span></span><br><span class="line">					&#123;</span><br><span class="line">						unique_lock&lt;mutex&gt; lock&#123; _lock &#125;;</span><br><span class="line">						_idlThrNum++;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			&#123;</span><br><span class="line">				unique_lock&lt;mutex&gt; lock&#123; _lock &#125;;</span><br><span class="line">				_idlThrNum++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">//https://github.com/lzpong/</span></span></span><br></pre></td></tr></table></figure><p></p><p><code>main.cpp</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">(<span class="type">int</span> slp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;  hello, fun1 !  %d\n&quot;</span> ,std::this_thread::<span class="built_in">get_id</span>());</span><br><span class="line">	<span class="keyword">if</span> (slp&gt;<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; ======= fun1 sleep %d  =========  %d\n&quot;</span>,slp, std::this_thread::<span class="built_in">get_id</span>());</span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(slp));</span><br><span class="line">		<span class="comment">//Sleep(slp );</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">gfun</span> &#123;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d  hello, gfun !  %d\n&quot;</span> ,n, std::this_thread::<span class="built_in">get_id</span>() );</span><br><span class="line">		<span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;    <span class="comment">//å‡½æ•°å¿…é¡»æ˜¯ static çš„æ‰èƒ½ä½¿ç”¨çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">Afun</span><span class="params">(<span class="type">int</span> n = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">		std::cout &lt;&lt; n &lt;&lt; <span class="string">&quot;  hello, Afun !  &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> n;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">static</span> std::string <span class="title">Bfun</span><span class="params">(<span class="type">int</span> n, std::string str, <span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">		std::cout &lt;&lt; n &lt;&lt; <span class="string">&quot;  hello, Bfun !  &quot;</span>&lt;&lt; str.<span class="built_in">c_str</span>() &lt;&lt;<span class="string">&quot;  &quot;</span> &lt;&lt; (<span class="type">int</span>)c &lt;&lt;<span class="string">&quot;  &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> str;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		std::threadpool executor&#123; <span class="number">50</span> &#125;;</span><br><span class="line">		A a;</span><br><span class="line">		std::future&lt;<span class="type">void</span>&gt; ff = executor.<span class="built_in">commit</span>(fun1,<span class="number">0</span>);</span><br><span class="line">		std::future&lt;<span class="type">int</span>&gt; fg = executor.<span class="built_in">commit</span>(gfun&#123;&#125;,<span class="number">0</span>);</span><br><span class="line">		std::future&lt;<span class="type">int</span>&gt; gg = executor.<span class="built_in">commit</span>(a.Afun, <span class="number">9999</span>); <span class="comment">//IDEæç¤ºé”™è¯¯,ä½†å¯ä»¥ç¼–è¯‘è¿è¡Œ</span></span><br><span class="line">		std::future&lt;std::string&gt; gh = executor.<span class="built_in">commit</span>(A::Bfun, <span class="number">9998</span>,<span class="string">&quot;mult args&quot;</span>, <span class="number">123</span>);</span><br><span class="line">		std::future&lt;std::string&gt; fh = executor.<span class="built_in">commit</span>([]()-&gt;std::string &#123; std::cout &lt;&lt; <span class="string">&quot;hello, fh !  &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl; <span class="keyword">return</span> <span class="string">&quot;hello,fh ret !&quot;</span>; &#125;);</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  sleep ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">microseconds</span>(<span class="number">900</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</span><br><span class="line">			executor.<span class="built_in">commit</span>(fun1,i*<span class="number">100</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  commit all ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>()&lt;&lt; <span class="string">&quot; idlsize=&quot;</span>&lt;&lt;executor.<span class="built_in">idlCount</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  sleep ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">		ff.<span class="built_in">get</span>(); <span class="comment">//è°ƒç”¨.get()è·å–è¿”å›å€¼ä¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œ,è·å–è¿”å›å€¼</span></span><br><span class="line">		std::cout &lt;&lt; fg.<span class="built_in">get</span>() &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; fh.<span class="built_in">get</span>().<span class="built_in">c_str</span>()&lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  sleep ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  fun1,55 ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">		executor.<span class="built_in">commit</span>(fun1,<span class="number">55</span>).<span class="built_in">get</span>();    <span class="comment">//è°ƒç”¨.get()è·å–è¿”å›å€¼ä¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œ</span></span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;end... &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="function">std::threadpool <span class="title">pool</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line">		std::vector&lt; std::future&lt;<span class="type">int</span>&gt; &gt; results;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">			results.<span class="built_in">emplace_back</span>(</span><br><span class="line">				pool.<span class="built_in">commit</span>([i] &#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;hello &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">					std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;world &quot;</span> &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">					<span class="keyword">return</span> i*i;</span><br><span class="line">				&#125;)</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot; =======  commit all2 ========= &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp; result : results)</span><br><span class="line">			std::cout &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		std::cout &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">catch</span> (std::exception&amp; e) &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;some unhappy happened...  &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>C++11 è¯­è¨€ç»†èŠ‚ï¼š<p></p><ol><li><code>using Task = function&lt;void()&gt;</code> æ˜¯ç±»å‹åˆ«åï¼Œç®€åŒ–äº† <code>typedef</code> çš„ç”¨æ³•ã€‚<code>function&lt;void()&gt;</code> å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œæ¥å—ä»»æ„åŸå‹æ˜¯ <code>void()</code> çš„å‡½æ•°ï¼Œæˆ–æ˜¯å‡½æ•°å¯¹è±¡ï¼Œæˆ–æ˜¯åŒ¿åå‡½æ•°ã€‚<code>void()</code> æ„æ€æ˜¯ä¸å¸¦å‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼ã€‚</li><li><code>pool.emplace_back([this]&#123;...&#125;)</code> å’Œ <code>pool.push_back([this]&#123;...&#125;)</code> åŠŸèƒ½ä¸€æ ·ï¼Œåªä¸è¿‡å‰è€…æ€§èƒ½ä¼šæ›´å¥½ã€‚</li><li><code>pool.emplace_back([this]&#123;...&#125;)</code> æ„é€ äº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œæ‰§è¡Œå‡½æ•°æ˜¯ LambdaåŒ¿åå‡½æ•°ã€‚</li><li>æ‰€æœ‰å¯¹è±¡çš„åˆå§‹åŒ–æ–¹å¼å‡é‡‡ç”¨äº† <code>&#123;&#125;</code>ï¼Œè€Œä¸å†ä½¿ç”¨ <code>()</code> æ–¹å¼ï¼Œå› ä¸ºé£æ ¼ä¸å¤Ÿä¸€è‡´ä¸”å®¹æ˜“å‡ºé”™ã€‚</li><li>åŒ¿åå‡½æ•°ï¼š <code>[this]&#123;...&#125;</code> ä¸å¤šè¯´ã€‚<code>[]</code> æ˜¯æ•æ‰å™¨ï¼Œ<code>this</code> æ˜¯å¼•ç”¨åŸŸå¤–çš„å˜é‡ thisæŒ‡é’ˆï¼Œå†…éƒ¨ä½¿ç”¨æ­»å¾ªç¯, ç”± <code>cv_task.wait(lock,[this]&#123;...&#125;)</code> æ¥é˜»å¡çº¿ç¨‹ã€‚</li><li><code>delctype(expr)</code> ç”¨æ¥æ¨æ–­ <code>expr</code> çš„ç±»å‹ï¼Œå’Œ <code>auto</code> æ˜¯ç±»ä¼¼çš„ï¼Œç›¸å½“äºç±»å‹å ä½ç¬¦ï¼Œå æ®ä¸€ä¸ªç±»å‹çš„ä½ç½®ï¼›<code>auto f(A a, B b) -&gt; decltype(a+b)</code> æ˜¯ä¸€ç§ç”¨æ³•ï¼Œä¸èƒ½å†™ä½œ <code>decltype(a+b) f(A a, B b)</code>ã€‚</li><li><code>commit</code> æ–¹æ³•æ˜¯ä¸æ˜¯ç•¥å¥‡è‘©ï¼å¯ä»¥å¸¦ä»»æ„å¤šçš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ fï¼Œåé¢ä¾æ¬¡æ˜¯å‡½æ•° f çš„å‚æ•°(<em>æ³¨æ„:å‚æ•°è¦ä¼ struct/classçš„è¯,å»ºè®®ç”¨pointer,å°å¿ƒå˜é‡çš„ä½œç”¨åŸŸ</em>)ï¼å¯å˜å‚æ•°æ¨¡æ¿æ˜¯ c++11 çš„ä¸€å¤§äº®ç‚¹ã€‚</li><li><code>commit</code> ç›´æ¥ä½¿ç”¨æ™ºèƒ½è°ƒç”¨ <code>stdcall</code> å‡½æ•°ï¼Œä½†æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°è°ƒç”¨ç±»æˆå‘˜ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ bindï¼š<code>commit(std::bind(&amp;Dog::sayHello, &amp;dog));</code> ä¸€ç§æ˜¯ç”¨ mem_fnï¼š <code>commit(std::mem_fn(&amp;Dog::sayHello), &amp;dog)ï¼›</code>ã€‚</li><li><code>make_shared()</code> ç”¨æ¥æ„é€  <code>shared_ptr</code> æ™ºèƒ½æŒ‡é’ˆã€‚ç”¨æ³•å¤§ä½“æ˜¯ <code>shared_ptr p = make_shared(4)</code> ç„¶å <code>*p == 4</code> ã€‚æ™ºèƒ½æŒ‡é’ˆçš„å¥½å¤„å°±æ˜¯è‡ªåŠ¨ deleteã€‚</li><li><code>bind</code> å‡½æ•°ï¼Œæ¥å—å‡½æ•° f å’Œéƒ¨åˆ†å‚æ•°ï¼Œè¿”å›curryingåçš„åŒ¿åå‡½æ•°ï¼Œè­¬å¦‚ <code>bind(add, 4)</code> å¯ä»¥å®ç°ç±»ä¼¼ <code>add(4)</code> çš„å‡½æ•°ã€‚</li><li><code>forward()</code> å‡½æ•°ï¼Œç±»ä¼¼äº <code>move()</code> å‡½æ•°ï¼Œåè€…æ˜¯å°†å‚æ•°å³å€¼åŒ–ï¼Œå‰è€…æ˜¯ä¸æ”¹å˜æœ€åˆä¼ å…¥çš„ç±»å‹çš„å¼•ç”¨ç±»å‹(å·¦å€¼è¿˜æ˜¯å·¦å€¼ï¼Œå³å€¼è¿˜æ˜¯å³å€¼)ã€‚</li><li><code>packaged_task</code> å°±æ˜¯ä»»åŠ¡å‡½æ•°çš„å°è£…ç±»ï¼Œé€šè¿‡ <code>get_future()</code> è·å– <code>future</code> ï¼Œç„¶åé€šè¿‡ <code>future</code> å¯ä»¥è·å–å‡½æ•°çš„è¿”å›å€¼(<code>future.get()</code>)ï¼›<code>packaged_task</code> æœ¬èº«å¯ä»¥åƒå‡½æ•°ä¸€æ ·è°ƒç”¨ã€‚</li><li><code>queue</code> æ˜¯é˜Ÿåˆ—ç±»ï¼Œ <code>front()</code> è·å–å¤´éƒ¨å…ƒç´ ï¼Œ <code>pop()</code> ç§»é™¤å¤´éƒ¨å…ƒç´ ï¼›<code>back()</code> è·å–å°¾éƒ¨å…ƒç´ ï¼Œ<code>push()</code> å°¾éƒ¨æ·»åŠ å…ƒç´ ã€‚</li><li><code>lock_guard</code> æ˜¯ <code>mutex</code> çš„ stack å°è£…ç±»ï¼Œæ„é€ çš„æ—¶å€™ <code>lock()</code>ï¼Œææ„çš„æ—¶å€™ <code>unlock()</code>ï¼Œæ˜¯ C++ RAII çš„ ideaã€‚</li><li><code>condition_variable cv;</code> æ¡ä»¶å˜é‡ï¼Œéœ€è¦é…åˆ <code>unique_lock</code> ä½¿ç”¨ï¼›<code>unique_lock</code> ç›¸æ¯” <code>lock_guard</code> çš„å¥½å¤„æ˜¯ï¼šå¯ä»¥éšæ—¶ <code>unlock()</code> å’Œ <code>lock()</code>ã€‚ <code>cv.wait()</code> ä¹‹å‰éœ€è¦æŒæœ‰ mutexï¼Œ<code>wait()</code> æœ¬èº«ä¼šè§£é”ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³åˆ™ä¼šé‡æ–°æŒæœ‰é”ã€‚</li><li>æœ€åçº¿ç¨‹æ± ææ„çš„æ—¶å€™ï¼Œ<code>join()</code> å¯ä»¥ç­‰å¾…ä»»åŠ¡éƒ½æ‰§è¡Œå®Œå†ç»“æŸï¼Œå¾ˆå®‰å…¨ã€‚</li></ol><h4 id="ç®€å•å†™æ³•"><a href="#ç®€å•å†™æ³•" class="headerlink" title="ç®€å•å†™æ³•"></a>ç®€å•å†™æ³•</h4><p><code>ThreadPool.hpp</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once  </span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//çº¿ç¨‹æ±   </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="type">int</span> ThreadNums)</span></span>;    <span class="comment">//åŠ ä¸Šexplicité¿å…äº§ç”Ÿè¯¸å¦‚ThreadPool pool = 1;è¿™æ ·çš„éšå¼è½¬æ¢  </span></span><br><span class="line">    ~<span class="built_in">ThreadPool</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—  </span></span><br><span class="line">    <span class="comment">//F&amp;&amp;ä¸‡èƒ½å¼•ç”¨ï¼Œå¦‚æœFæ˜¯å·¦å€¼ï¼Œé‚£å¾—åˆ°çš„å°±æ˜¯å·¦å€¼ï¼›å¦‚æœFæ˜¯å³å€¼ï¼Œé‚£å¾—åˆ°çš„å°±æ˜¯å³å€¼  </span></span><br><span class="line">    <span class="comment">//Fä¸ºå¯è°ƒç”¨å¯¹è±¡ç±»å‹ï¼ŒArgä¸ºå…¶å¯¹åº”çš„å‚æ•°ç±»å‹  </span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span> ...Arg&gt;   <span class="comment">//...Argä¸ºå¯å˜å‚æ•°æ¨¡æ¿ï¼Œä»»æ„ä¸ªæ•°çš„å‚æ•°  </span></span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">EnterQueues</span><span class="params">(F&amp;&amp; f, Arg&amp;&amp;... arg)</span> -&gt; std::future&lt;<span class="keyword">typename</span> std::invoke_result&lt;F, Arg...&gt;::type&gt;</span>;  </span><br><span class="line">    <span class="comment">//result_ofæ˜¯ç±»å‹èƒå–å·¥å…·ï¼Œåˆ©ç”¨::typeæ¥æ¨å¯¼å‡ºå¯è°ƒç”¨å¯¹è±¡Fåœ¨ä¼ å…¥å‚æ•°Arg...æ—¶çš„è¿”å›ç±»å‹ã€‚å¤´æ–‡ä»¶&lt;type_traits&gt;  </span></span><br><span class="line">    <span class="comment">//C++17ä¸­result_ofè¢«å¯ç”¨ï¼Œä½¿ç”¨invoke_result  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span>:  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">worker</span><span class="params">()</span></span>;  <span class="comment">//çº¿ç¨‹çš„æ‰§è¡Œå†…å®¹  </span></span><br><span class="line">    <span class="type">bool</span> IsStop;    <span class="comment">//æ ‡è¯†ï¼Œå½“å‰çº¿ç¨‹æ± æ˜¯ä¸æ˜¯åœæ­¢  </span></span><br><span class="line">    std::condition_variable cv;  </span><br><span class="line">    std::mutex mtx;  </span><br><span class="line">    std::vector&lt;std::thread&gt; workers;   <span class="comment">//çº¿ç¨‹é›†åˆï¼ˆçº¿ç¨‹æ± ï¼‰  </span></span><br><span class="line">    std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; MyQueue;  <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—ï¼Œä»»åŠ¡å°è£…æˆäº†voidè¿”å›ç±»å‹çš„å‡½æ•°  </span></span><br><span class="line">    <span class="comment">//å¦‚æœç”¨æˆ·æ”¾è¿›æ¥çš„å‡½æ•°æœ‰è¿”å›å€¼ï¼Œè¦æƒ³è·å¾—è¿™ä¸ªè¿”å›å€¼ï¼Œå°±éœ€è¦åˆ©ç”¨packaged_taskè¿”å›ä¸€ä¸ªfutureå¯¹è±¡ï¼Œåˆ©ç”¨è¯¥å¯¹è±¡è·å–è¿”å›å€¼  </span></span><br><span class="line">&#125;;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°  </span></span><br><span class="line">ThreadPool::<span class="built_in">ThreadPool</span>(<span class="type">int</span> ThreadNums) : <span class="built_in">IsStop</span>(<span class="literal">false</span>)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; ThreadNums; ++i) &#123;  </span><br><span class="line">        workers.<span class="built_in">emplace_back</span>([<span class="keyword">this</span>]() &#123;  </span><br><span class="line">            <span class="keyword">this</span>-&gt;<span class="built_in">worker</span>(); <span class="comment">//æ­¤æ—¶çº¿ç¨‹å°±å¼€å§‹è¿è¡Œäº†  </span></span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//ææ„å‡½æ•°  </span></span><br><span class="line">ThreadPool::~<span class="built_in">ThreadPool</span>()  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="comment">//æ›´æ”¹åœæ­¢æ ‡è¯†  </span></span><br><span class="line">    &#123;   <span class="comment">//æ·»åŠ ä½œç”¨åŸŸï¼Œç¦»å¼€åè‡ªåŠ¨é‡Šæ”¾ã€‚åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨åœ°å°†IsStopç½®ä¸ºtrue  </span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;  </span><br><span class="line">        IsStop = <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//é€šçŸ¥æ‰€æœ‰é˜»å¡ä¸­çš„çº¿ç¨‹ï¼Œè®©å®ƒä»¬ç»§ç»­è¿›è¡Œ  </span></span><br><span class="line">    cv.<span class="built_in">notify_all</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//ç¡®ä¿çº¿ç¨‹æ‰§è¡Œå®Œæˆ  </span></span><br><span class="line">    <span class="keyword">for</span> (std::thread&amp; OneThread : workers)  </span><br><span class="line">    &#123;  </span><br><span class="line">        OneThread.<span class="built_in">join</span>();   <span class="comment">//éƒ½åŠ å…¥ï¼ˆé˜»å¡ï¼‰åˆ°ä¸»çº¿ç¨‹ä¸­ï¼ˆä¸æ˜¯æŒ‡æ‰§è¡Œï¼‰ï¼Œå½“æ‰€æœ‰å­çº¿ç¨‹é‡Šæ”¾ä»¥åï¼Œä¸»çº¿ç¨‹æ‰èƒ½é‡Šæ”¾  </span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//æ·»åŠ ä»»åŠ¡  </span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span> ...Arg&gt;   <span class="comment">//...Argä¸ºå¯å˜å‚æ•°æ¨¡æ¿ï¼Œä»»æ„ä¸ªæ•°çš„å‚æ•°  </span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">ThreadPool::EnterQueues</span><span class="params">(F&amp;&amp; f, Arg&amp;&amp;... arg)</span> -&gt; std::future&lt;<span class="keyword">typename</span> std::invoke_result&lt;F, Arg...&gt;::type&gt;  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="comment">//è·å¾—fæ‰§è¡Œåçš„ç±»å‹  </span></span><br><span class="line">    <span class="keyword">using</span> functype = <span class="keyword">typename</span> std::result_of&lt;<span class="built_in">F</span>(Arg...)&gt;::type;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//è·å¾—ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªè¢«åŒ…è£…ä¸ºfunctype()çš„task  </span></span><br><span class="line">    <span class="comment">//ä¹‹æ‰€ä»¥ä½¿ç”¨æŒ‡é’ˆè€Œä¸æ˜¯ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œæ˜¯ä¸ºäº†å»¶é•¿ç”Ÿå‘½å‘¨æœŸ  </span></span><br><span class="line">    <span class="keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;<span class="built_in">functype</span>()&gt;&gt;(  </span><br><span class="line">            std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Arg&gt;(arg)...)    <span class="comment">//ç»‘å®šæˆfunction&lt;void()&gt;ç±»å‹  </span></span><br><span class="line">            );  </span><br><span class="line">    <span class="comment">//std::forwardå®Œç¾è½¬å‘ï¼Œå‘çš„æ˜¯å³å€¼åˆ™ä¼ å³å€¼ï¼Œå‘çš„æ˜¯å·¦å€¼åˆ™ä¼ å·¦å€¼  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">//è·å¾—future  </span></span><br><span class="line">    std::future&lt;functype&gt; rsFuture = task-&gt;<span class="built_in">get_future</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—  </span></span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lockGuard</span><span class="params">(mtx)</span></span>;  </span><br><span class="line">        <span class="keyword">if</span> (IsStop)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;å‡ºé”™ï¼šçº¿ç¨‹æ± å·²ç»åœæ­¢äº†&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        MyQueue.<span class="built_in">emplace</span>([task]() &#123;  </span><br><span class="line">            (*task)();  </span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//é€šçŸ¥çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡  </span></span><br><span class="line">    cv.<span class="built_in">notify_one</span>();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> rsFuture;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//æ¯ä¸ªå…·ä½“çš„å·¥ä½œä»»åŠ¡  </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::worker</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="comment">//å®šä¹‰ä»»åŠ¡  </span></span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; task;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//ä»é˜Ÿåˆ—ä¸­å–å¾—ä¸€ä¸ªä»»åŠ¡  </span></span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">uniqueLock</span><span class="params">(mtx)</span></span>;  </span><br><span class="line">  </span><br><span class="line">            cv.<span class="built_in">wait</span>(uniqueLock, [<span class="keyword">this</span>]() &#123;  </span><br><span class="line">                <span class="keyword">return</span> !<span class="keyword">this</span>-&gt;MyQueue.<span class="built_in">empty</span>() || <span class="keyword">this</span>-&gt;IsStop;  </span><br><span class="line">            &#125;);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (IsStop &amp;&amp; MyQueue.<span class="built_in">empty</span>())  </span><br><span class="line">            &#123;  </span><br><span class="line">                <span class="keyword">return</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            task = std::<span class="built_in">move</span>(MyQueue.<span class="built_in">front</span>());  </span><br><span class="line">            MyQueue.<span class="built_in">pop</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//æ‰§è¡Œä»»åŠ¡  </span></span><br><span class="line">        <span class="built_in">task</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>main.cpp</code>ï¼š<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ThreadPool.hpp&quot;</span>  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;chcp 65001&quot;</span>);  </span><br><span class="line">    <span class="function">ThreadPool <span class="title">MyPool</span><span class="params">(<span class="number">4</span>)</span></span>;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;  <span class="comment">//å³ä½¿æ˜¯i &lt; 20ï¼Œä»ç„¶åªæœ‰4ä¸ªçº¿ç¨‹è¿è¡Œ  </span></span><br><span class="line">        std::future&lt;<span class="type">int</span>&gt; MyFuture = MyPool.<span class="built_in">EnterQueues</span>([](<span class="type">int</span> a, <span class="type">int</span> b) -&gt; <span class="type">int</span> &#123;  </span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;å½“å‰çº¿ç¨‹: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;  </span><br><span class="line">            <span class="keyword">return</span> a + b;  </span><br><span class="line">        &#125;, <span class="number">10</span> * i, <span class="number">10</span> * i);  </span><br><span class="line">  </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;thread rs: &quot;</span> &lt;&lt; MyFuture.<span class="built_in">get</span>() &lt;&lt; std::endl;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>âœ…æ³¨ï¼šå…³äº hpp æ–‡ä»¶<br>HPPï¼ˆHeader Plus Plusï¼‰æ˜¯C++ä¸­çš„ä¸€ç§ç‰¹æ®Šå¤´æ–‡ä»¶æ ¼å¼ï¼Œå®ƒå°†ç±»çš„å£°æ˜å’Œå®ç°ä»£ç æ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ä¸ä¼ ç»Ÿçš„ <code>.h</code> å’Œ <code>.cpp</code> æ–‡ä»¶ä¸åŒï¼ŒHPPæ–‡ä»¶å…è®¸åœ¨å¤´æ–‡ä»¶ä¸­ç›´æ¥åŒ…å«å®ç°ä»£ç ï¼Œä»è€Œå‡å°‘äº†ä»£ç æ–‡ä»¶çš„æ•°é‡å’Œç¼–è¯‘æ¬¡æ•°ã€‚è¿™ç§æ–‡ä»¶æ ¼å¼ç‰¹åˆ«é€‚åˆç”¨äºç¼–å†™æ¨¡æ¿ç±»å’Œå¼€æºåº“ï¼Œå› ä¸ºå®ƒç®€åŒ–äº†ä»£ç çš„ç®¡ç†å’Œä½¿ç”¨ã€‚</p><p>è¾“å‡ºç»“æœï¼š<br></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">thread rs: å½“å‰çº¿ç¨‹: 2</span><br><span class="line">0</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 3</span><br><span class="line">20</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 4</span><br><span class="line">40</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 5</span><br><span class="line">60</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 2</span><br><span class="line">80</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 3</span><br><span class="line">100</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 4</span><br><span class="line">120</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 5</span><br><span class="line">140</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 2</span><br><span class="line">160</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 3</span><br><span class="line">180</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 4</span><br><span class="line">200</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 5</span><br><span class="line">220</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 2</span><br><span class="line">240</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 3</span><br><span class="line">260</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 4</span><br><span class="line">280</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 5</span><br><span class="line">300</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 2</span><br><span class="line">320</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 3</span><br><span class="line">340</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 4</span><br><span class="line">360</span><br><span class="line">thread rs: å½“å‰çº¿ç¨‹: 5</span><br><span class="line">380</span><br></pre></td></tr></table></figure><p></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…:</span> <span class="post-copyright-info"><a href="https://sumikiru.top">Sumikiru</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥:</span> <span class="post-copyright-info"><a href="https://sumikiru.top/posts/4fee29fb.html">https://sumikiru.top/posts/4fee29fb.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜:</span> <span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://sumikiru.top" target="_blank">Sumikiruã®Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C++</a><a class="post-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">å¤šçº¿ç¨‹</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/31d79f30.html" title="CLioné…ç½®C++ä¸Lua"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6798b1eed0e0a243d4f84e1b.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">CLioné…ç½®C++ä¸Lua</div></div></a></div><div class="next-post pull-right"><a href="/posts/d0ae354a.html" title="GASä¸­æ–‡æ–‡æ¡£ï¼ˆæ›´æ–°ä¸­ï¼‰"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">GASä¸­æ–‡æ–‡æ¡£ï¼ˆæ›´æ–°ä¸­ï¼‰</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/f83528c7.html" title="3.æ•°ä¸ä½ç¯‡"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-25</div><div class="title">3.æ•°ä¸ä½ç¯‡</div></div></a></div><div><a href="/posts/31d79f30.html" title="CLioné…ç½®C++ä¸Lua"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6798b1eed0e0a243d4f84e1b.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-28</div><div class="title">CLioné…ç½®C++ä¸Lua</div></div></a></div><div><a href="/posts/123456.html" title="0.å¸¸ç”¨çš„C++ STLç”¨æ³•"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-05</div><div class="title">0.å¸¸ç”¨çš„C++ STLç”¨æ³•</div></div></a></div><div><a href="/posts/254d58d4.html" title="1.æ•°ç»„ç¯‡"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-05</div><div class="title">1.æ•°ç»„ç¯‡</div></div></a></div><div><a href="/posts/10e5d792.html" title="2.0å­—ç¬¦ä¸²ç¯‡"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-05</div><div class="title">2.0å­—ç¬¦ä¸²ç¯‡</div></div></a></div><div><a href="/posts/283bba67.html" title="2.1å­—ç¬¦ä¸²ç¯‡(2)"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-05</div><div class="title">2.1å­—ç¬¦ä¸²ç¯‡(2)</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E3%80%81%E8%BF%9B%E7%A8%8B%E3%80%81%E5%B9%B6%E5%8F%91"><span class="toc-text">ä»€ä¹ˆæ˜¯çº¿ç¨‹ã€è¿›ç¨‹ã€å¹¶å‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text">çº¿ç¨‹çš„ç‰¹ç‚¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="toc-text">ä»€ä¹ˆæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%B9%B6%E5%8F%91%EF%BC%88%E4%BC%98%E7%82%B9%EF%BC%89"><span class="toc-text">ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹&#x2F;å¹¶å‘ï¼ˆä¼˜ç‚¹ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">å¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%A3%B0%E6%98%8E%E5%91%A8%E6%9C%9F"><span class="toc-text">çº¿ç¨‹çš„å£°æ˜å‘¨æœŸ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Thread-%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-text">Thread åˆ›å»ºçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E4%BB%A3%E7%A0%81"><span class="toc-text">æ€»ä½“ä»£ç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%AF%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B"><span class="toc-text">é€šè¿‡å¯è°ƒç”¨å¯¹è±¡åˆ›å»ºçº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="toc-text">çº¿ç¨‹å‚æ•°ä¼ é€’</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%80%BC%E4%BC%A0%E9%80%92"><span class="toc-text">é€šè¿‡å€¼ä¼ é€’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%BC%95%E7%94%A8%E4%BC%A0%E9%80%92"><span class="toc-text">é€šè¿‡å¼•ç”¨ä¼ é€’</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join-%E4%B8%8E-detach-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">join ä¸ detach çš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%8C%85%E5%90%AB%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-text">ä¸»çº¿ç¨‹åŒ…å«çš„å†…å®¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#this-thread"><span class="toc-text">this_thread</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="toc-text">çº¿ç¨‹åŒæ­¥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9%E4%BA%92%E6%96%A5%E9%94%81-mutex"><span class="toc-text">ğŸš©äº’æ–¥é” mutex</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9C%85%E5%85%B3%E4%BA%8ERAII"><span class="toc-text">âœ…å…³äºRAII</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mutex-%E7%9A%84%E5%9B%9B%E7%A7%8D%E7%B1%BB%E5%9E%8B"><span class="toc-text">mutex çš„å››ç§ç±»å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lock-guard"><span class="toc-text">lock_guard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unique-lock"><span class="toc-text">unique_lock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">ğŸ’»ä»£ç ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-condition-variable"><span class="toc-text">ğŸš©æ¡ä»¶å˜é‡ condition_variable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">ğŸ’»ä»£ç ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9%E8%AF%BB%E5%86%99%E9%94%81-shared-mutex"><span class="toc-text">ğŸš©è¯»å†™é” shared_mutex</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shared-mutex"><span class="toc-text">shared_mutex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shared-lock"><span class="toc-text">shared_lock</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E5%92%8C%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-atomic"><span class="toc-text">ğŸš©åŸå­å˜é‡å’ŒåŸå­æ“ä½œ atomic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">ä»£ç ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95"><span class="toc-text">å¸¸è§åŸå­æ“ä½œæ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E5%86%85%E5%AD%98%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-text">åŸå­æ“ä½œçš„å†…å­˜åºé—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9%E4%BF%A1%E5%8F%B7%E9%87%8F-semaphore"><span class="toc-text">ğŸš©ä¿¡å·é‡ semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-3"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#counting-semaphore"><span class="toc-text">counting_semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-2"><span class="toc-text">ğŸ’»ä»£ç ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%85%E6%A0%8F-barrier"><span class="toc-text">æ …æ  barrier</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-4"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">ğŸ’»ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-text">æ­»é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-3"><span class="toc-text">ğŸ’»ä»£ç ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B"><span class="toc-text">å¼‚æ­¥ç¼–ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9async"><span class="toc-text">ğŸš©async</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-5"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-text">ğŸ’»ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%90%AF%E5%8A%A8%E7%AD%96%E7%95%A5"><span class="toc-text">ä¸‰ç§å¯åŠ¨ç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9promise"><span class="toc-text">ğŸš©promise</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-6"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-text">ğŸ’»ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-1"><span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%A9packaged-task"><span class="toc-text">ğŸš©packaged_task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-7"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-text">ğŸ’»ä»£ç å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-2"><span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%BC%82%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-text">ä¸‰ç§å¼‚æ­¥å·¥å…·çš„æ¯”è¾ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">ä¹‹é—´çš„å…³ç³»</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-8"><span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%92%BB%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-text">ğŸ’»ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%86%99%E6%B3%95"><span class="toc-text">ç®€å•å†™æ³•</span></a></li></ol></li></ol></li></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Sumikiru</div><div class="framework-info"><span>æ¡†æ¶</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-netlify.sumikiru.top/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-netlify.sumikiru.top/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.31/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="2125653815" data-server="netease" data-type="playlist" data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"]):not([href="https://twikoo-netlify.sumikiru.top/.netlify/functions/twikoo"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div class="app-refresh" id="app-refresh" style="position:fixed;top:-2.2rem;left:0;right:0;z-index:99999;padding:0 1rem;font-size:15px;height:2.2rem;transition:all .3s ease"><div class="app-refresh-wrap" style="display:flex;color:#fff;height:100%;align-items:center;justify-content:center"><label>âœ¨ æœ‰æ–°æ–‡ç« å•¦ï¼ ğŸ‘‰</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color:#fff;text-decoration:underline;cursor:pointer">ğŸ—ç‚¹å‡»é£Ÿç”¨ğŸ”</span></a></div></div><script>if ('serviceWorker' in navigator) {
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.addEventListener('controllerchange', function() {
      showNotification()
    })
  }
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
  })
}
function showNotification() {
  if (GLOBAL_CONFIG.Snackbar) {
    var snackbarBg = document.documentElement.getAttribute('data-theme') === 'light' ? GLOBAL_CONFIG.Snackbar.bgLight : GLOBAL_CONFIG.Snackbar.bgDark
    var snackbarPos = GLOBAL_CONFIG.Snackbar.position
    Snackbar.show({
      text: 'âœ¨ æœ‰æ–°æ–‡ç« å•¦ï¼ ğŸ‘‰',
      backgroundColor: snackbarBg,
      duration: 500000,
      pos: snackbarPos,
      actionText: 'ğŸ—ç‚¹å‡»é£Ÿç”¨ğŸ”',
      actionTextColor: '#fff',
      onActionClick: function(e) {
        location.reload()
      },
    })
  } else {
    var showBg = document.documentElement.getAttribute('data-theme') === 'light' ? '#3b70fc' : '#1f1f1f'
    var cssText = `top: 0; background: ${showBg};`
    document.getElementById('app-refresh').style.cssText = cssText
  }
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var a=document.getElementsByClassName("sticky_layout")[0];console.log("å·²æŒ‚è½½butterfly_clock_anzhiyu"),a&&a.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="/posts/".split(","),cpage=location.pathname,epage="all",qweather_key="814574b8a08a439aaf0c4e65c598bde2",gaud_map_key="7d331966e19a65abf8cc5fdd3d0a735a",baidu_ak_key="undefined",flag=0,clock_rectangle="112.6534116,27.96920845",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_clock_anzhiyu_injector_config():epage===cpage&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>function butterfly_footer_beautify_injector_config(){var A=document.getElementById("footer-wrap");console.log("å·²æŒ‚è½½butterfly_footer_beautify"),A.insertAdjacentHTML("beforeend",'<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_footer_beautify_injector_config():epage===cpage&&butterfly_footer_beautify_injector_config()</script><script async src="/js/runtime/runtime.min.js"></script><script data-pjax>function butterfly_swiper_injector_config(){var a=document.getElementById("recent-posts");console.log("å·²æŒ‚è½½butterfly_swiper"),a.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/9b94e219.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660f797468eb93571307d888.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-04-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/9b94e219.html&quot;);" href="javascript:void(0);" alt="">æ¬¢è¿æ¥åˆ°æœ¬ç«™</a><div class="blog-slider__text">æ¬¢è¿ï¼Œä¸€èµ·æ¥ç ”ç©¶C++å§~</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/9b94e219.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/d0ae354a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-12-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/d0ae354a.html&quot;);" href="javascript:void(0);" alt="">GASä¸­æ–‡æ–‡æ¡£ï¼ˆæ›´æ–°ä¸­ï¼‰</a><div class="blog-slider__text">GASä¸­æ–‡æ–‡æ¡£ï¼Œæ›´æ–°è‡³5.3ç‰ˆæœ¬ï¼ˆæ›´æ–°ä¸­ï¼Œimagesä»¥åé…ç½®ï¼‰</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/d0ae354a.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/4fee29fb.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-12-15</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/4fee29fb.html&quot;);" href="javascript:void(0);" alt="">è¯­è¨€åŸºç¡€4.å¹¶å‘ä¸å¤šçº¿ç¨‹</a><div class="blog-slider__text">C++åŸºç¡€ï¼šå¤šçº¿ç¨‹</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/4fee29fb.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/9da932c7.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-09-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/9da932c7.html&quot;);" href="javascript:void(0);" alt="">è¯­è¨€åŸºç¡€3.æ–‡ä»¶æ“ä½œä¸C++11æ–°ç‰¹æ€§</a><div class="blog-slider__text">C++åŸºç¡€ï¼šæ–‡ä»¶æ“ä½œä¸C++11æ–°ç‰¹æ€§</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/9da932c7.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/816de279.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/6692a239d9c307b7e99355e5.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-08-10</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/816de279.html&quot;);" href="javascript:void(0);" alt="">è¯­è¨€åŸºç¡€2.é¢å‘å¯¹è±¡</a><div class="blog-slider__text">C++åŸºç¡€ï¼šé¢å‘å¯¹è±¡</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/816de279.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/31d79f30.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6798b1eed0e0a243d4f84e1b.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-01-28</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/31d79f30.html&quot;);" href="javascript:void(0);" alt="">CLioné…ç½®C++ä¸Lua</a><div class="blog-slider__text">CLioné…ç½®C++å’ŒLuaçš„è¿è¡Œä¸è°ƒè¯•</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/31d79f30.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/10e5d792.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-04-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/10e5d792.html&quot;);" href="javascript:void(0);" alt="">2.0å­—ç¬¦ä¸²ç¯‡</a><div class="blog-slider__text">å­—ç¬¦ä¸²åŸºç¡€éƒ¨åˆ†</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/10e5d792.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/123456.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic.imgdb.cn/item/660e52719f345e8d03a5e677.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-04-05</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/123456.html&quot;);" href="javascript:void(0);" alt="">0.å¸¸ç”¨çš„C++ STLç”¨æ³•</a><div class="blog-slider__text">è½¬è½½è‡ªgithub</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/123456.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="/",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_swiper_injector_config():epage===cpage&&butterfly_swiper_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async src="/js/ali_font.js"></script><div class="js-pjax"><script async>for(var arr=document.getElementsByClassName("recent-post-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset","30"),arr[i].setAttribute("data-wow-iteration","1")</script><script async>for(var arr=document.getElementsByClassName("card-widget"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__zoomIn"),arr[i].setAttribute("data-wow-duration",""),arr[i].setAttribute("data-wow-delay","200ms"),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("flink-list-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("article-sort-item"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__slideInRight"),arr[i].setAttribute("data-wow-duration","1.5s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__flipInY"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script><script async>for(var arr=document.getElementsByClassName("site-card"),i=0;i<arr.length;i++)arr[i].classList.add("wow"),arr[i].classList.add("animate__animated"),arr[i].setAttribute("data-wow-duration","3s"),arr[i].setAttribute("data-wow-delay",""),arr[i].setAttribute("data-wow-offset",""),arr[i].setAttribute("data-wow-iteration","")</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/haruto.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!1},log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/"})</script></body></html>